var value_to_desc_map = {};
value_to_desc_map['BAGSS'] = 'Bias-Corrected Gilbert Skill Score';
value_to_desc_map['AFSS'] = 'Asymptotic Fractions Skill Score';
value_to_desc_map['UFSS'] = 'Uniform Fractions Skill Score';
value_to_desc_map['F_RATE'] = 'Forecast Rate';
value_to_desc_map['O_RATE'] = 'Observation Rate';
value_to_desc_map['IQR'] = 'Inter-quartile range';
value_to_desc_map['MAD'] = 'Median Absolute Deviation';
value_to_desc_map['LODDS'] = 'Log Odds Ratio';
value_to_desc_map['ORSS'] = 'Odds Ratio Skill Score';
value_to_desc_map['EDS'] = 'Extreme Dependency Score';
value_to_desc_map['SEDS'] = 'Symmetric Extreme Dependency Score';
value_to_desc_map['EDI'] = 'Extreme Dependency Index';
value_to_desc_map['SEDI'] = 'Symmetric Extreme Dependency Index';
value_to_desc_map['solid'] = '1';
value_to_desc_map['dashed'] = '2';
value_to_desc_map['dotted'] = '3';
value_to_desc_map['dot-dash'] = '4';
value_to_desc_map['long dash'] = '5';
value_to_desc_map['long short'] = '6';
value_to_desc_map['normal'] = '1';
value_to_desc_map['bold'] = '2';
value_to_desc_map['italic'] = '3';
value_to_desc_map['bold italic'] = '4';
value_to_desc_map['greek'] = '5';
value_to_desc_map['ANOM_CORR'] = 'Anomaly correlation';
value_to_desc_map['ANOM_CORR_UNCNTR'] = 'Uncentered anomaly correlation ';
value_to_desc_map['ACPC_03'] = '3hr accumulation';
value_to_desc_map['ACPC_06'] = '6hr accumulation';
value_to_desc_map['ACPC_24'] = '24hr accumulation';
value_to_desc_map['REFC'] = 'Reflectivity';
value_to_desc_map['DPT'] = 'Dew point temperature';
value_to_desc_map['HGT'] = 'Height';
value_to_desc_map['TMP'] = 'Temperature';
value_to_desc_map['PMSL'] = 'Mean sea level pressure';
value_to_desc_map['UGRD'] = 'U-Wind';
value_to_desc_map['VGRD'] = 'V-Wind';
value_to_desc_map['UGRD_VGRD'] = 'U and V-Wind';
value_to_desc_map['WIND'] = 'Wind';
value_to_desc_map['SPFH'] = 'Specific humidity';
value_to_desc_map['PWAT'] = 'Precipital water';
value_to_desc_map['ACC'] = 'Accuracy';
value_to_desc_map['BASER'] = 'Base rate, aka Observed relative frequency';
value_to_desc_map['BCMSE'] = 'Bias-corrected mean squared error';
value_to_desc_map['BCRMSE'] = 'Bias-corrected root mean square error';
value_to_desc_map['CSI'] = 'Critical success index, aka Threat score';
value_to_desc_map['E10'] = '10th percentile of the error';
value_to_desc_map['E25'] = '25th percentile of the error';
value_to_desc_map['E50'] = '50th percentile of the error';
value_to_desc_map['E75'] = '75th percentile of the error';
value_to_desc_map['E90'] = '90th percentile of the error';
value_to_desc_map['ESTDEV'] = 'Standard deviation of the error';
value_to_desc_map['FAR'] = 'False alarm ratio';
value_to_desc_map['FBAR'] = 'Forecast mean';
value_to_desc_map['FBIAS'] = 'Bias, aka Frequency bias';
value_to_desc_map['FMEAN'] = 'Forecast mean';
value_to_desc_map['FSTDEV'] = 'Forecast standard deviation';
value_to_desc_map['GSS'] = 'Gilbert skill score, aka Equitable threat score';
value_to_desc_map['HK'] = 'Hanssen Kuipers Discriminant';
value_to_desc_map['HSS'] = 'Heidke skill score';
value_to_desc_map['KT_CORR'] = 'Kendall Tau Rank Correlation Coefficient';
value_to_desc_map['MAE'] = 'Mean absolute error';
value_to_desc_map['MBIAS'] = 'Multiplicative Bias';
value_to_desc_map['ME'] = 'Mean error, aka Additive bias';
value_to_desc_map['MSE'] = 'Mean squared error';
value_to_desc_map['OBAR'] = 'Observation Mean';
value_to_desc_map['ODDS'] = 'Odds Ratio';
value_to_desc_map['OSTDEV'] = 'Observation Standard Deviation';
value_to_desc_map['PODN'] = 'Probability of Detecting No';
value_to_desc_map['PODY'] = 'Probability of Detecting Yes';
value_to_desc_map['POFD'] = 'Probability of false detection';
value_to_desc_map['PR_CORR'] = 'Pearson\'s Correlation Coefficient';
value_to_desc_map['RMSE'] = 'Root-mean squared error';
value_to_desc_map['SP_CORR'] = 'Spearman\'s Rank Correlation Coefficient';
value_to_desc_map['MCTS_ACC'] = 'Multi-category: Accuracy';
value_to_desc_map['MCTS_GER'] = 'Multi-category: Gerrity score';
value_to_desc_map['MCTS_HK'] = 'Multi-category: Hanssen Kuipers Discrim';
value_to_desc_map['MCTS_HSS'] = 'Multi-category: Heidke skill score';
value_to_desc_map['NBR_ACC'] = 'Nbrhd methods: Accuracy';
value_to_desc_map['NBR_BASER'] = 'Nbrhd base rate';
value_to_desc_map['NBR_CSI'] = 'Nbrhd critical success index';
value_to_desc_map['NBR_FAR'] = 'Nbrhd false alarm rate';
value_to_desc_map['NBR_FBIAS'] = 'Nbrhd frequesncy bias';
value_to_desc_map['NBR_FBS'] = 'Nbrhd methods cont: Fract brier score';
value_to_desc_map['NBR_FMEAN'] = 'Nbrhd forecast mean';
value_to_desc_map['NBR_FSS'] = 'Nbrhd methods cont: Fract skill score';
value_to_desc_map['NBR_GSS'] = 'Nbrhd Gilbert skill score';
value_to_desc_map['NBR_HK'] = 'Nbrhd Hanssen Kuipers discrim';
value_to_desc_map['NBR_HSS'] = 'Nbrhd Heidke skill score';
value_to_desc_map['NBR_ODDS'] = 'Nbrhd odds ratio';
value_to_desc_map['NBR_PODN'] = 'Nbrhd prob of detecting no';
value_to_desc_map['NBR_PODY'] = 'Nbrhd prob of detecting yes';
value_to_desc_map['NBR_POFD'] = 'Nbrhd prob of false detecting';
value_to_desc_map['ACOV'] = 'Sum of area divided by total';
value_to_desc_map['CNT'] = 'Count of object_id';
value_to_desc_map['CNTSUM'] = 'Count of object_id';
value_to_desc_map['CENTX'] = 'Centroid X in grid-units';
value_to_desc_map['CENTY'] = 'Centroid Y in grid-units';
value_to_desc_map['CENTLAT'] = 'Centroid lat';
value_to_desc_map['CENTLON'] = 'Centroid lon';
value_to_desc_map['AXAVG'] = 'Axis average';
value_to_desc_map['LEN'] = 'Length';
value_to_desc_map['WID'] = 'Width';
value_to_desc_map['ASPECT'] = 'Aspect';
value_to_desc_map['AREA'] = 'Area';
value_to_desc_map['AREAFIL'] = 'Area filter';
value_to_desc_map['AREATHR'] = 'Area threshold';
value_to_desc_map['CURV'] = 'Curvature';
value_to_desc_map['CURVX'] = 'Curvature X';
value_to_desc_map['CURVY'] = 'Curvature Y';
value_to_desc_map['CPLX'] = 'Complexity';
value_to_desc_map['INT10'] = 'Intensity 10th percentile';
value_to_desc_map['INT25'] = 'Intensity 25th percentile';
value_to_desc_map['INT50'] = 'Intensity 50th percentile';
value_to_desc_map['INT75'] = 'Intensity 75th percentile';
value_to_desc_map['INT90'] = 'Intensity 90th percentile';
value_to_desc_map['INTN'] = 'Intensity designed for use in PERCINTRATIO';
value_to_desc_map['INTSUM'] = 'Intensity sum';
value_to_desc_map['RATIO_FSA_ASA'] = '% of simple objects that are forecast';
value_to_desc_map['RATIO_OSA_ASA'] = '% of simple objects that are observation';
value_to_desc_map['RATIO_ASM_ASA'] = '% of simple objects that are matched';
value_to_desc_map['RATIO_ASU_ASA'] = '% of simple objects that are unmatched';
value_to_desc_map['RATIO_FSM_FSA'] = '% of simple forecast objects that are matched';
value_to_desc_map['RATIO_FSU_FSA'] = '% of simple forecast objects that are unmatched';
value_to_desc_map['RATIO_OSM_OSA'] = '% of simple simple observation objects that are matched';
value_to_desc_map['RATIO_OSU_OSA'] = '% of simple simple observation objects that are unmatched';
value_to_desc_map['RATIO_FSM_ASM'] = '% of simple matched objects that are forecasts';
value_to_desc_map['RATIO_OSM_ASM'] = '% of simple matched objects that are observations';
value_to_desc_map['RATIO_FSU_ASU'] = '% of simple unmatched objects that are forecast';
value_to_desc_map['RATIO_OSU_ASU'] = '% of simple unmatched objects that are observation';
value_to_desc_map['RATIO_ASA_AAA'] = '% of all objects that are simple';
value_to_desc_map['RATIO_ACA_AAA'] = '% of all objects that are cluster';
value_to_desc_map['RATIO_FSA_AAA'] = 'What is';
value_to_desc_map['RATIO_OSA_AAA'] = 'What is';
value_to_desc_map['RATIO_FSA_FAA'] = '% of all forecast objects that are simple';
value_to_desc_map['RATIO_FCA_FAA'] = '% of all forecast objects that are cluster';
value_to_desc_map['RATIO_OSA_OAA'] = '% of all observation objects that are simple';
value_to_desc_map['RATIO_OCA_OAA'] = '% of all observation objects that are cluster';
value_to_desc_map['RATIO_FCA_ACA'] = '% of cluster objects that are forecast';
value_to_desc_map['RATIO_OCA_ACA'] = '% of cluster objects that are observation';
value_to_desc_map['RATIO_FSA_OSA'] = 'Ratio of simple forecasts to simple observations [frequency bias]';
value_to_desc_map['RATIO_OSA_FSA'] = 'Ratio of simple observations to simple forecasts [1 / frequency bias]';
value_to_desc_map['RATIO_ACA_ASA'] = 'Ratio of cluster objects to simple objects';
value_to_desc_map['RATIO_ASA_ACA'] = 'Ratio of simple objects to cluster objects';
value_to_desc_map['RATIO_FCA_FSA'] = 'Ratio of cluster forecast objects to simple forecast objects';
value_to_desc_map['RATIO_FSA_FCA'] = 'Ratio of simple forecast objects to cluster forecast objects';
value_to_desc_map['RATIO_OCA_OSA'] = 'Ratio of cluster observation objects to simple observation objects';
value_to_desc_map['RATIO_OSA_OCA'] = 'Ratio of simple observation objects to cluster observation objects';
value_to_desc_map['OBJHITS'] = 'Hits =/2';
value_to_desc_map['OBJMISSES'] = 'Misses = OSU';
value_to_desc_map['OBJFAS'] = 'False Alarms = FSU';
value_to_desc_map['OBJCSI'] = 'CSI = hits //2 + OSU + FSU]';
value_to_desc_map['OBJPODY'] = 'PODY = hits //2 + OSU]';
value_to_desc_map['OBJFAR'] = 'FAR = false alarms //2 + FSU]';
value_to_desc_map['OBJFBIAS'] = 'FBIAS = RATIO_FSA_OSA = FSA / OSA';
value_to_desc_map['AREARAT_FSA_ASA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSA_ASA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_ASM_ASA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_ASU_ASA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSM_FSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSU_FSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSM_OSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSU_OSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSM_ASM'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSM_ASM'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSU_ASU'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSU_ASU'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSA_AAA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSA_AAA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSA_FAA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FCA_FAA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSA_OAA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OCA_OAA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FCA_ACA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OCA_ACA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSA_OSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSA_FSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_ACA_ASA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_ASA_ACA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FCA_FSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_FSA_FCA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OCA_OSA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['AREARAT_OSA_OCA'] = 'Area-weighted % of simple objects forecasted';
value_to_desc_map['CENTDIST'] = 'Centroid distance';
value_to_desc_map['BOUNDDIST'] = 'Boundry distance';
value_to_desc_map['HULLDIST'] = 'Convex hull distance';
value_to_desc_map['ANGLEDIFF'] = 'Angle difference';
value_to_desc_map['AREARATIO'] = 'Area ratio';
value_to_desc_map['INTAREA'] = 'Intersection area';
value_to_desc_map['UNIONAREA'] = 'Union area';
value_to_desc_map['SYMDIFF'] = 'Symmetric difference or non-intersecting area';
value_to_desc_map['INTOVERAREA'] = 'Ratio of intersection area to union area';
value_to_desc_map['CMPLXRATIO'] = 'Complexity ratio';
value_to_desc_map['PERCINTRATIO'] = 'Ratio of intensity at percentile defined by INTNN';
value_to_desc_map['INT'] = 'Interest';
value_to_desc_map['MAXINT'] = 'Maximun interest';
value_to_desc_map['MAXINTF'] = 'Maximun interest for forecast objects';
value_to_desc_map['MAXINTO'] = 'Maximun interest for observation objects';
value_to_desc_map['PSTD_BSS_SMPL'] = 'Sample Brier skill score';
value_to_desc_map['PSTD_BSS'] = 'Brier skill score';
value_to_desc_map['FGBAR'] = 'Mean of absolute value of forecast gradients';
value_to_desc_map['MGBAR'] = 'Mean of maximum of absolute values of forecast and observed gradients';
value_to_desc_map['EGBAR'] = 'Mean of absolute value of forecast minus observed gradients';
value_to_desc_map['S1'] = 'S1 score';
value_to_desc_map['SI'] = 'Scatter Index';
value_to_desc_map['S1_OG'] = 'S1 score with respect to observed gradient';
value_to_desc_map['FGOG_RATIO'] = 'Ratio of forecast and observed gradients';
value_to_desc_map['SSVAR_SPREAD'] = 'RHIST_SPREAD is preferred';
value_to_desc_map['ECNT_CRPS'] = 'The Continuous Ranked Probability Score';
value_to_desc_map['ECNT_CRPSS'] = 'The ContinuousRanked Probability Skill Score';
value_to_desc_map['ECNT_IGN'] = 'The Ignorance Score';
value_to_desc_map['ECNT_ME'] = 'The Mean Error of the ensemble mean';
value_to_desc_map['ECNT_RMSE'] = 'The Root Mean Square Error of the ensemble mean';
value_to_desc_map['ECNT_SPREAD'] = 'The mean of the spread of the unperturbed ensemble member values at each observation location';
value_to_desc_map['ECNT_ME_OERR'] = 'The Mean Error of the PERTURBED ensemble mean';
value_to_desc_map['ECNT_RMSE_OERR'] = 'The Root Mean Square Error of the PERTURBED ensemble mean';
value_to_desc_map['ECNT_SPREAD_OERR'] = 'The mean of the spread of the PERTURBED ensemble member values at each observation location';
value_to_desc_map['ECNT_SPREAD_PLUS_OERR'] = 'The square root of the sum of unperturbed ensemble variance and the observation error variance';
value_to_desc_map['ASPECTDIFF'] = 'Absolute value of the difference between teh aspect ratios' +
    ' of two objects';
value_to_desc_map['CURVATURERATIO'] = 'Ratio of the curvature of two objects definded as the' +
    ' lesser of the two divided by teh greater of the two';

value_to_desc_map['ORANK_OBS'] = 'Value of the observation';
value_to_desc_map['ORANK_PIT'] = 'Probability Integral Transform';
value_to_desc_map['ORANK_RANK'] = 'Rank of the observation';
value_to_desc_map['ORANK_ENS_MEAN'] = 'The unperturbed ensemble mean value';
value_to_desc_map['ORANK_SPREAD'] = 'The spread of the unperturbed ensemble member values';
value_to_desc_map['ORANK_CLIMO'] = 'The value of the inluded climatology';
value_to_desc_map['ORANK_ENS_MEAN_OERR'] = 'The PERTURBED ensemble mean';
value_to_desc_map['ORANK_SPREAD_OERR'] = 'The spread of the PERTURBED ensemble member values';
value_to_desc_map['ORANK_SPREAD_PLUS_OERR'] = 'The square root of the sum of the unperturbed ensemble variance and the observation error variance';
value_to_desc_map['RPS_COMP'] = 'Complement of the Ranked Probability Score';
value_to_desc_map['SS_INDEX'] = 'Skill score index value';

var listStatModeRatio = ["RATIO_FSA_ASA", "RATIO_OSA_ASA", "RATIO_ASM_ASA", "RATIO_ASU_ASA", "RATIO_FSM_FSA",
    "RATIO_FSU_FSA", "RATIO_OSM_OSA", "RATIO_OSU_OSA", "RATIO_FSM_ASM", "RATIO_OSM_ASM",
    "RATIO_FSU_ASU", "RATIO_OSU_ASU", "RATIO_FSA_AAA", "RATIO_OSA_AAA", "RATIO_FSA_FAA",
    "RATIO_FCA_FAA", "RATIO_OSA_OAA", "RATIO_OCA_OAA", "RATIO_FCA_ACA", "RATIO_OCA_ACA",
    "RATIO_FSA_OSA", "RATIO_OSA_FSA", "RATIO_ACA_ASA", "RATIO_ASA_ACA", "RATIO_FCA_FSA",
    "RATIO_FSA_FCA", "RATIO_OCA_OSA", "RATIO_OSA_OCA", "OBJHITS", "OBJMISSES", "OBJFAS",
    "OBJCSI", "OBJPODY", "OBJFAR",

    "AREARAT_FSA_ASA", "AREARAT_OSA_ASA", "AREARAT_ASM_ASA", "AREARAT_ASU_ASA", "AREARAT_FSM_FSA",
    "AREARAT_FSU_FSA", "AREARAT_OSM_OSA", "AREARAT_OSU_OSA", "AREARAT_FSM_ASM", "AREARAT_OSM_ASM",
    "AREARAT_FSU_ASU", "AREARAT_OSU_ASU", "AREARAT_FSA_AAA", "AREARAT_OSA_AAA", "AREARAT_FSA_FAA",
    "AREARAT_FCA_FAA", "AREARAT_OSA_OAA", "AREARAT_OCA_OAA", "AREARAT_FCA_ACA", "AREARAT_OCA_ACA",
    "AREARAT_FSA_OSA", "AREARAT_OSA_FSA", "AREARAT_ACA_ASA", "AREARAT_ASA_ACA", "AREARAT_FCA_FSA",
    "AREARAT_FSA_FCA", "AREARAT_OCA_OSA", "AREARAT_OSA_OCA", "OBJAHITS", "OBJAMISSES", "OBJAFAS",
    "OBJACSI", "OBJAPODY", "OBJAFAR"
];

var listStatMtdRatio = [
    "2d_AREARAT_ACA_ASA",
    "2d_AREARAT_ASA_ACA",
    "2d_AREARAT_ASM_ASA",
    "2d_AREARAT_ASU_ASA",
    "2d_AREARAT_FCA_ACA",
    "2d_AREARAT_FCA_FAA",
    "2d_AREARAT_FCA_FSA",
    "2d_AREARAT_FSA_AAA",
    "2d_AREARAT_FSA_ASA",
    "2d_AREARAT_FSA_FAA",
    "2d_AREARAT_FSA_FCA",
    "2d_AREARAT_FSA_OSA",
    "2d_AREARAT_FSM_ASM",
    "2d_AREARAT_FSM_FSA",
    "2d_AREARAT_FSU_ASU",
    "2d_AREARAT_FSU_FSA",
    "2d_AREARAT_OCA_ACA",
    "2d_AREARAT_OCA_OAA",
    "2d_AREARAT_OCA_OSA",
    "2d_AREARAT_OSA_AAA",
    "2d_AREARAT_OSA_ASA",
    "2d_AREARAT_OSA_FSA",
    "2d_AREARAT_OSA_OAA",
    "2d_AREARAT_OSA_OCA",
    "2d_AREARAT_OSM_ASM",
    "2d_AREARAT_OSM_OSA",
    "2d_AREARAT_OSU_ASU",
    "2d_AREARAT_OSU_OSA",
    "2d_OBJACSI",
    "2d_OBJAFAR",
    "2d_OBJAFAS",
    "2d_OBJAMISSES",
    "2d_OBJAPODY",
    "2d_OBJCSI",
    "2d_OBJFAR",
    "2d_OBJFAS",
    "2d_OBJHITS",
    "2d_OBJMISSES",
    "2d_OBJPODY",
    "2d_RATIO_ACA_ASA",
    "2d_RATIO_ASA_ACA",
    "2d_RATIO_ASM_ASA",
    "2d_RATIO_ASU_ASA",
    "2d_RATIO_FCA_ACA",
    "2d_RATIO_FCA_FAA",
    "2d_RATIO_FCA_FSA",
    "2d_RATIO_FSA_AAA",
    "2d_RATIO_FSA_ASA",
    "2d_RATIO_FSA_FAA",
    "2d_RATIO_FSA_FCA",
    "2d_RATIO_FSA_OSA",
    "2d_RATIO_FSM_ASM",
    "2d_RATIO_FSM_FSA",
    "2d_RATIO_FSU_ASU",
    "2d_RATIO_FSU_FSA",
    "2d_RATIO_OCA_ACA",
    "2d_RATIO_OCA_OAA",
    "2d_RATIO_OCA_OSA",
    "2d_RATIO_OSA_AAA",
    "2d_RATIO_OSA_ASA",
    "2d_RATIO_OSA_FSA",
    "2d_RATIO_OSA_OAA",
    "2d_RATIO_OSA_OCA",
    "2d_RATIO_OSM_ASM",
    "2d_RATIO_OSM_OSA",
    "2d_RATIO_OSU_ASU",
    "2d_RATIO_OSU_OSA",
    "3d_OBJCSI",
    "3d_OBJFAR",
    "3d_OBJFAS",
    "3d_OBJHITS",
    "3d_OBJMISSES",
    "3d_OBJPODY",
    "3d_OBJVCSI",
    "3d_OBJVFAR",
    "3d_OBJVFAS",
    "3d_OBJVHITS",
    "3d_OBJVMISSES",
    "3d_OBJVPODY",
    "3d_RATIO_ACA_ASA",
    "3d_RATIO_ASA_ACA",
    "3d_RATIO_ASM_ASA",
    "3d_RATIO_ASU_ASA",
    "3d_RATIO_FCA_ACA",
    "3d_RATIO_FCA_FAA",
    "3d_RATIO_FCA_FSA",
    "3d_RATIO_FSA_AAA",
    "3d_RATIO_FSA_ASA",
    "3d_RATIO_FSA_FAA",
    "3d_RATIO_FSA_FCA",
    "3d_RATIO_FSA_OSA",
    "3d_RATIO_FSM_ASM",
    "3d_RATIO_FSM_FSA",
    "3d_RATIO_FSU_ASU",
    "3d_RATIO_FSU_FSA",
    "3d_RATIO_OCA_ACA",
    "3d_RATIO_OCA_OAA",
    "3d_RATIO_OCA_OSA",
    "3d_RATIO_OSA_AAA",
    "3d_RATIO_OSA_ASA",
    "3d_RATIO_OSA_FSA",
    "3d_RATIO_OSA_OAA",
    "3d_RATIO_OSA_OCA",
    "3d_RATIO_OSM_ASM",
    "3d_RATIO_OSM_OSA",
    "3d_RATIO_OSU_ASU",
    "3d_RATIO_OSU_OSA",
    "3d_VOLRAT_ACA_ASA",
    "3d_VOLRAT_ASA_ACA",
    "3d_VOLRAT_ASM_ASA",
    "3d_VOLRAT_ASU_ASA",
    "3d_VOLRAT_FCA_ACA",
    "3d_VOLRAT_FCA_FAA",
    "3d_VOLRAT_FCA_FSA",
    "3d_VOLRAT_FSA_AAA",
    "3d_VOLRAT_FSA_ASA",
    "3d_VOLRAT_FSA_FAA",
    "3d_VOLRAT_FSA_FCA",
    "3d_VOLRAT_FSA_OSA",
    "3d_VOLRAT_FSM_ASM",
    "3d_VOLRAT_FSM_FSA",
    "3d_VOLRAT_FSU_ASU",
    "3d_VOLRAT_FSU_FSA",
    "3d_VOLRAT_OCA_ACA",
    "3d_VOLRAT_OCA_OAA",
    "3d_VOLRAT_OCA_OSA",
    "3d_VOLRAT_OSA_AAA",
    "3d_VOLRAT_OSA_ASA",
    "3d_VOLRAT_OSA_FSA",
    "3d_VOLRAT_OSA_OAA",
    "3d_VOLRAT_OSA_OCA",
    "3d_VOLRAT_OSM_ASM",
    "3d_VOLRAT_OSM_OSA",
    "3d_VOLRAT_OSU_ASU",
    "3d_VOLRAT_OSU_OSA"
];
var listStatModeSingle = [
    "ACOV", "CNT", "CNTSUM", "CENTX", "CENTY", "CENTLAT", "CENTLON", "AXAVG", "LEN", "WID", "ASPECT",
    "AREA", "AREATHR", "CURV", "CURVX", "CURVY", "CPLX", "INT10", "INT25", "INT50",
    "INT75", "INT90", "INTN", "INTSUM"
];

var listStatModePair = [
    "CENTDIST", "BOUNDDIST", "HULLDIST", "ANGLEDIFF", "AREARATIO", "INTAREA", "UNIONAREA",
    "SYMDIFF", "INTOVERAREA", "CMPLXRATIO", "PERCINTRATIO", "INT", "MAXINT", "MAXINTF", "MAXINTO", "ASPECTDIFF", "CURVATURERATIO"
];

var listStatMtd2d = [
    '2D_AREA',
    '2D_CENTROID_X',
    '2D_CENTROID_Y',
    '2D_CENTROID_LAT',
    '2D_CENTROID_LON',
    '2D_AXIS_ANG',
    '2D_INTENSITY_10',
    '2D_INTENSITY_25',
    '2D_INTENSITY_50',
    '2D_INTENSITY_75',
    '2D_INTENSITY_90',
    '2D_INTENSITY_N'
];

var listStatMtd3dSingle = [
    '3D_CENTROID_X',
    '3D_CENTROID_Y',
    '3D_CENTROID_T',
    '3D_CENTROID_LAT',
    '3D_CENTROID_LON',
    '3D_X_DOT',
    '3D_Y_DOT',
    '3D_AXIS_ANG',
    '3D_VOLUME',
    '3D_START_TIME',
    '3D_END_TIME',
    '3D_DURATION',
    '3D_CDIST_TRAVELLED',
    '3D_INTENSITY_10',
    '3D_INTENSITY_25',
    '3D_INTENSITY_50',
    '3D_INTENSITY_75',
    '3D_INTENSITY_90',
    '3D_INTENSITY_N'
];

var listStatMtd3dPair = [
    '3D_SPACE_CENTROID_DIST',
    '3D_TIME_CENTROID_DELTA',
    '3D_AXIS_DIFF',
    '3D_SPEED_DELTA',
    '3D_DIRECTION_DIFF',
    '3D_VOLUME_RATIO',
    '3D_START_TIME_DELTA',
    '3D_END_TIME_DELTA',
    '3D_INTERSECTION_VOLUME',
    '3D_DURATION_DIFF',
    '3D_INTEREST'
];
var listStatMode = listStatModeSingle.concat(listStatModePair);
var listStatMtd = listStatMtd2d.concat(listStatMtd3dSingle).concat(listStatMtd3dPair);

var series_var_value_to_title_stat_map = {};
series_var_value_to_title_stat_map['model'] = 'MODEL';
series_var_value_to_title_stat_map['descr'] = 'DESC';
series_var_value_to_title_stat_map['fcst_lead'] = 'FCST_LEAD';
series_var_value_to_title_stat_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
series_var_value_to_title_stat_map['valid_hour'] = 'VALID_HOUR';
series_var_value_to_title_stat_map['fcst_init_beg'] = 'FCST_INIT_BEG';
series_var_value_to_title_stat_map['init_hour'] = 'INIT_HOUR';
series_var_value_to_title_stat_map['fcst_lev'] = 'FCST_LEV';
series_var_value_to_title_stat_map['obtype'] = 'OBTYPE';
series_var_value_to_title_stat_map['vx_mask'] = 'VX_MASK';
series_var_value_to_title_stat_map['interp_mthd'] = 'INTERP_MTHD';
series_var_value_to_title_stat_map['interp_pnts'] = 'INTERP_PNTS';
series_var_value_to_title_stat_map['fcst_thresh'] = 'FCST_THRESH';
series_var_value_to_title_stat_map['obs_thresh'] = 'OBS_THRESH';
series_var_value_to_title_stat_map['obs_var'] = 'OBS_VAR';
series_var_value_to_title_stat_map['fcst_perc'] = 'FCST_PERC';
series_var_value_to_title_stat_map['obs_perc'] = 'OBS_PERC';


var fix_var_value_to_title_stat_map = {};
fix_var_value_to_title_stat_map['fcst_lead'] = 'FCST_LEAD';
fix_var_value_to_title_stat_map['model'] = 'MODEL';
fix_var_value_to_title_stat_map['descr'] = 'DESC';
fix_var_value_to_title_stat_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
fix_var_value_to_title_stat_map['valid_hour'] = 'VALID_HOUR';
fix_var_value_to_title_stat_map['fcst_init_beg'] = 'FCST_INIT_BEG';
fix_var_value_to_title_stat_map['init_hour'] = 'INIT_HOUR';
fix_var_value_to_title_stat_map['fcst_lev'] = 'FCST_LEV';
fix_var_value_to_title_stat_map['obtype'] = 'OBTYPE';
fix_var_value_to_title_stat_map['vx_mask'] = 'VX_MASK';
fix_var_value_to_title_stat_map['interp_mthd'] = 'INTERP_MTHD';
fix_var_value_to_title_stat_map['interp_pnts'] = 'INTERP_PNTS';
fix_var_value_to_title_stat_map['fcst_thresh'] = 'FCST_THRESH';
fix_var_value_to_title_stat_map['obs_thresh'] = 'OBS_THRESH';
fix_var_value_to_title_stat_map['obs_var'] = 'OBS_VAR';
fix_var_value_to_title_stat_map['cov_thresh'] = 'COV_THRESH';

var fix_var_value_to_title_mode_map = {};
fix_var_value_to_title_mode_map['fcst_lead'] = 'FCST_LEAD';
fix_var_value_to_title_mode_map['model'] = 'MODEL';
fix_var_value_to_title_mode_map['descr'] = 'DESC';
fix_var_value_to_title_mode_map['fcst_valid'] = 'FCST_VALID';
fix_var_value_to_title_mode_map['valid_hour'] = 'VALID_HOUR';
fix_var_value_to_title_mode_map['fcst_init'] = 'FCST_INIT';
fix_var_value_to_title_mode_map['init_hour'] = 'INIT_HOUR';
fix_var_value_to_title_mode_map['fcst_accum'] = 'FCST_ACCUM';
fix_var_value_to_title_mode_map['fcst_rad'] = 'FCST_RAD';
fix_var_value_to_title_mode_map['fcst_thr'] = 'FCST_THR';
fix_var_value_to_title_mode_map['fcst_lev'] = 'FCST_LEV';


var fix_var_value_to_title_mtd_map = {};
fix_var_value_to_title_mtd_map['fcst_lead'] = 'FCST_LEAD';
fix_var_value_to_title_mtd_map['model'] = 'MODEL';
fix_var_value_to_title_mtd_map['descr'] = 'DESC';
fix_var_value_to_title_mtd_map['fcst_valid'] = 'FCST_VALID';
fix_var_value_to_title_mtd_map['valid_hour'] = 'VALID_HOUR';
fix_var_value_to_title_mtd_map['fcst_init'] = 'FCST_INIT';
fix_var_value_to_title_mtd_map['init_hour'] = 'INIT_HOUR';
fix_var_value_to_title_mtd_map['fcst_accum'] = 'FCST_ACCUM';
fix_var_value_to_title_mtd_map['fcst_rad'] = 'FCST_RAD';
fix_var_value_to_title_mtd_map['fcst_thr'] = 'FCST_THR';
fix_var_value_to_title_mtd_map['fcst_lev'] = 'FCST_LEV';
fix_var_value_to_title_mtd_map['fcst_t_beg'] = 'FCST_T_BEG';
fix_var_value_to_title_mtd_map['fcst_t_end'] = 'FCST_T_END';
fix_var_value_to_title_mtd_map['obs_t_beg'] = 'OBS_T_BEG';
fix_var_value_to_title_mtd_map['obs_t_end'] = 'OBS_T_END';


var indy_var_value_to_title_stat_map = {};
indy_var_value_to_title_stat_map['fcst_lead'] = 'FCST_LEAD';
indy_var_value_to_title_stat_map['model'] = 'MODEL';
indy_var_value_to_title_stat_map['descr'] = 'DESC';
indy_var_value_to_title_stat_map['fcst_lev'] = 'FCST_LEV';
indy_var_value_to_title_stat_map['fcst_thresh'] = 'FCST_THRESH';
indy_var_value_to_title_stat_map['obs_thresh'] = 'OBS_THRESH';
indy_var_value_to_title_stat_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
indy_var_value_to_title_stat_map['valid_hour'] = 'VALID_HOUR';
indy_var_value_to_title_stat_map['fcst_init_beg'] = 'FCST_INIT_BEG';
indy_var_value_to_title_stat_map['init_hour'] = 'INIT_HOUR';
indy_var_value_to_title_stat_map['interp_pnts'] = 'INTERP_PNTS';
indy_var_value_to_title_stat_map['vx_mask'] = 'VX_MASK';

var indy_var_value_to_title_mode_map = {};
indy_var_value_to_title_mode_map['fcst_lead'] = 'FCST_LEAD';
indy_var_value_to_title_mode_map['model'] = 'MODEL';
indy_var_value_to_title_mode_map['descr'] = 'DESC';
indy_var_value_to_title_mode_map['fcst_lev'] = 'FCST_LEV';
indy_var_value_to_title_mode_map['fcst_thr'] = 'FCST_THR';
indy_var_value_to_title_mode_map['fcst_valid'] = 'FCST_VALID';
indy_var_value_to_title_mode_map['valid_hour'] = 'VALID_HOUR';
indy_var_value_to_title_mode_map['fcst_init'] = 'FCST_INIT';
indy_var_value_to_title_mode_map['init_hour'] = 'INIT_HOUR';
indy_var_value_to_title_mode_map['fcst_rad'] = 'FCST_RAD';
indy_var_value_to_title_mode_map['vx_mask'] = 'VX_MASK';


var indy_var_value_to_title_mtd_map = {};
indy_var_value_to_title_mtd_map['fcst_lead'] = 'FCST_LEAD';
indy_var_value_to_title_mtd_map['model'] = 'MODEL';
indy_var_value_to_title_mtd_map['descr'] = 'DESC';
indy_var_value_to_title_mtd_map['fcst_lev'] = 'FCST_LEV';
indy_var_value_to_title_mtd_map['fcst_thr'] = 'FCST_THR';
indy_var_value_to_title_mtd_map['fcst_valid'] = 'FCST_VALID';
indy_var_value_to_title_mtd_map['valid_hour'] = 'VALID_HOUR';
indy_var_value_to_title_mtd_map['fcst_init'] = 'FCST_INIT';
indy_var_value_to_title_mtd_map['init_hour'] = 'INIT_HOUR';
indy_var_value_to_title_mtd_map['fcst_rad'] = 'FCST_RAD';
indy_var_value_to_title_mtd_map['vx_mask'] = 'VX_MASK';
indy_var_value_to_title_mtd_map['fcst_t_beg'] = 'FCST_T_BEG';
indy_var_value_to_title_mtd_map['fcst_t_end'] = 'FCST_T_END';
indy_var_value_to_title_mtd_map['obs_t_beg'] = 'OBS_T_BEG';
indy_var_value_to_title_mtd_map['obs_t_end'] = 'OBS_T_END';


var phist_fixed_var_map = {};
phist_fixed_var_map['fcst_var'] = 'FCST_VAR';
phist_fixed_var_map['model'] = 'MODEL';
phist_fixed_var_map['fcst_lead'] = 'FCST_LEAD';
phist_fixed_var_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
phist_fixed_var_map['valid_hour'] = 'VALID_HOUR';
phist_fixed_var_map['fcst_init_beg'] = 'FCST_INIT_BEG';
phist_fixed_var_map['init_hour'] = 'INIT_HOUR';
phist_fixed_var_map['fcst_lev'] = 'FCST_LEV';
phist_fixed_var_map['obtype'] = 'OBTYPE';
phist_fixed_var_map['vx_mask'] = 'VX_MASK';
phist_fixed_var_map['interp_mthd'] = 'INTERP_MTHD';
phist_fixed_var_map['interp_pnts'] = 'INTERP_PNTS';
phist_fixed_var_map['fcst_thresh'] = 'FCST_THRESH';
phist_fixed_var_map['obs_thresh'] = 'OBS_THRESH';
phist_fixed_var_map['n_bin'] = 'N_BIN';
phist_fixed_var_map['cov_thresh'] = 'COV_THRESH';

var rhist_fixed_var_map = {};
rhist_fixed_var_map['fcst_var'] = 'FCST_VAR';
rhist_fixed_var_map['model'] = 'MODEL';
rhist_fixed_var_map['fcst_lead'] = 'FCST_LEAD';
rhist_fixed_var_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
rhist_fixed_var_map['valid_hour'] = 'VALID_HOUR';
rhist_fixed_var_map['fcst_init_beg'] = 'FCST_INIT_BEG';
rhist_fixed_var_map['init_hour'] = 'INIT_HOUR';
rhist_fixed_var_map['fcst_lev'] = 'FCST_LEV';
rhist_fixed_var_map['obtype'] = 'OBTYPE';
rhist_fixed_var_map['vx_mask'] = 'VX_MASK';
rhist_fixed_var_map['interp_mthd'] = 'INTERP_MTHD';
rhist_fixed_var_map['interp_pnts'] = 'INTERP_PNTS';
rhist_fixed_var_map['fcst_thresh'] = 'FCST_THRESH';
rhist_fixed_var_map['obs_thresh'] = 'OBS_THRESH';
rhist_fixed_var_map['n_rank'] = 'N_RANK';
rhist_fixed_var_map['cov_thresh'] = 'COV_THRESH';


var relp_fixed_var_map = {};
relp_fixed_var_map['fcst_var'] = 'FCST_VAR';
relp_fixed_var_map['model'] = 'MODEL';
relp_fixed_var_map['fcst_lead'] = 'FCST_LEAD';
relp_fixed_var_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
relp_fixed_var_map['valid_hour'] = 'VALID_HOUR';
relp_fixed_var_map['fcst_init_beg'] = 'FCST_INIT_BEG';
relp_fixed_var_map['init_hour'] = 'INIT_HOUR';
relp_fixed_var_map['fcst_lev'] = 'FCST_LEV';
relp_fixed_var_map['obtype'] = 'OBTYPE';
relp_fixed_var_map['vx_mask'] = 'VX_MASK';
relp_fixed_var_map['interp_mthd'] = 'INTERP_MTHD';
relp_fixed_var_map['interp_pnts'] = 'INTERP_PNTS';
relp_fixed_var_map['fcst_thresh'] = 'FCST_THRESH';
relp_fixed_var_map['obs_thresh'] = 'OBS_THRESH';
relp_fixed_var_map['n_ens'] = 'N_ENS';
relp_fixed_var_map['cov_thresh'] = 'COV_THRESH';


var perf_fixed_var_map = {};
perf_fixed_var_map['fcst_var'] = 'FCST_VAR';
perf_fixed_var_map['model'] = 'MODEL';
perf_fixed_var_map['fcst_lead'] = 'FCST_LEAD';
perf_fixed_var_map['fcst_valid_beg'] = 'FCST_VALID_BEG';
perf_fixed_var_map['valid_hour'] = 'VALID_HOUR';
perf_fixed_var_map['fcst_init_beg'] = 'FCST_INIT_BEG';
perf_fixed_var_map['init_hour'] = 'INIT_HOUR';
perf_fixed_var_map['fcst_lev'] = 'FCST_LEV';
perf_fixed_var_map['obtype'] = 'OBTYPE';
perf_fixed_var_map['vx_mask'] = 'VX_MASK';
perf_fixed_var_map['interp_mthd'] = 'INTERP_MTHD';
perf_fixed_var_map['interp_pnts'] = 'INTERP_PNTS';
perf_fixed_var_map['fcst_thresh'] = 'FCST_THRESH';
perf_fixed_var_map['obs_thresh'] = 'OBS_THRESH';
perf_fixed_var_map['cov_thresh'] = 'COV_THRESH';


var fcst_var_y1_indexes = [1];
var series_var_y1_indexes = [1];
var fcst_var_y2_indexes = [];
var series_var_y2_indexes = [];
var fixed_var_indexes = [];
var date_period_indexes = [1];
var firstSeriesFormatting = {
    order: "1", /*y_axis: "Y1",*/
    hide: "No", /*title: "GSI3 TMP BASER",*/
    plot_ci: "none",
    color: "",
    pch: 20,
    type: "b",
    lty: "1",
    lwd: "1",
    show_signif: "No",
    con_series: "1",
    legend: "",
    id: "1"
};
var seriesDiffY1 = [];
var seriesDiffY2 = [];
var previousIndVarValResponse;
var fixVarValResponse = {};
var seriesY1VarValResponse = {};
var seriesY2VarValResponse = {};
var xml = '<?xml version="1.0"?><Request/>';
var group_name_to_value_map;
var indy_var_vals_to_attr;
var fcst_vars = [];
var fcst_vars_stats = [];

function cleanUp() {

    fcst_var_y1_indexes = [1];
    series_var_y1_indexes = [1];
    fcst_var_y2_indexes = [];
    series_var_y2_indexes = [];
    fixed_var_indexes = [];
    date_period_indexes = [1];
    seriesDiffY1 = [];
    seriesDiffY2 = [];
    previousIndVarValResponse = null;
    fixVarValResponse = {};
    seriesY1VarValResponse = {};
    seriesY2VarValResponse = {};
    group_name_to_value_map = null;
    fcst_vars = [];
    fcst_vars_stats = [];
}

/**
 * Determine if the input statistic is a MODE statistic and return true if so,
 * false otherwise.
 */
function isModeStat(stat) {
    if ($.inArray(stat, listStatModeRatio) >= 0) {
        return true;
    } else {
        var statArr = stat.split("_");
        if (statArr.length == 2) {
            if ($.inArray(statArr[0], listStatMode) >= 0 || statArr[0] == 'ACOVACOV') {
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
}

function isMtdStat(stat) {
    if ($.inArray(stat, listStatMtdRatio) >= 0) {
        return true;
    } else {
        var statArr = stat.split("_");
        var stat1 = "";
        for (var i = 0; i < statArr.length - 1; i++) {
            stat1 = stat1 + statArr[i];
            if (i !== statArr.length - 2) {
                stat1 = stat1 + '_';
            }
        }
        return $.inArray(stat1, listStatMtd) >= 0;

    }
}

function getForecastVariablesHist() {
    var selectedDatabase = getSelectedDatabases();
    //<request><db_con>mv_dart_gsi</db_con><list_stat><stat_fcst_var>TMP</stat_fcst_var></list_stat></request>
    if (selectedDatabase) {
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><stat_field>FCST_VAR</stat_field></list_val></request>',
            error: function (jqXHR, textStatus, errorThrown) {
            },
            success: function (data) {
                var values = $(data).find("val");
                for (var i = 0; i < values.length; i++) {
                    fcst_vars.push($(values[i]).text());
                }
            }
        });
        var fcst_var = "TMP";
        if (fcst_vars.length > 0) {
            fcst_var = fcst_vars[0];
        }
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_stat><stat_fcst_var>' + fcst_var + '</stat_fcst_var></list_stat></request>',
            error: function (jqXHR, textStatus, errorThrown) {
            },
            success: function (data) {
                var values = $(data).find("val");
                for (var i = 0; i < values.length; i++) {
                    fcst_vars_stats.push($(values[i]).text());
                }
            }
        });
    }
}

function getSelectedDatabases() {
    var databases = '';
    $("input[name='multiselect_database']:checked").each(function () {
        databases = databases + $(this).val() + ',';
    });
    if (databases.endsWith(',')) {
        databases = databases.slice(0, -1);
    }
    if (databases.length === 0) {
        //try to get it from the URL
        databases = querySt("db");
    }
    if (typeof databases === 'undefined' && initXML != null) {
        //try to get it from response XML
        databases = initXML.find("database").text();
        var textnode = document.createTextNode(databases);
        var item = document.getElementById("categories1").childNodes[0];
        item.replaceChild(textnode, item.childNodes[0]);
    }
    if (typeof databases === 'undefined') {
        //try to get it from the text field
        databases = document.getElementById("categories1").childNodes[0].innerText;
    }
    if (databases === "Select database") {
        databases = null;
    }
    return databases;
}

function updateStatVariable() {
    var i;
    $('#listdt').jqGrid('clearGridData');

    var select = $("#fcst_var_y1_1");
    var indy_var_val = $('#indy_var_val');
    select.empty();
    try {
        select.multiselect('refresh');
    } catch (err) {
    }


    indy_var_val.empty();
    try {
        indy_var_val.multiselect('refresh');
    } catch (err) {
    }


    var fixed_var_indexes_copy = fixed_var_indexes.slice();
    for (i = 0; i < fixed_var_indexes_copy.length; i++) {
        removeFixedVar("fixed_var_" + fixed_var_indexes_copy[i]);
    }


    //get value of database
    var databases = getSelectedDatabases();
    if (databases) {
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + databases + '</db_con><list_val><stat_field>FCST_VAR</stat_field></list_val></request>',
            error: function () {
            },
            success: function (data) {
                var values = $(data).find("val");
                var opt;
                if (values.length > 0) {
                    var options = [];
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        if (i == 0 || (i != 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted,
                                title: value_to_desc_map[t.text()]
                            });
                            options.push(opt);
                        } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }

                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;
                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select);
                    }
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                    updateStatVal();
                }
            }
        });
    }
}

function updateForecastVariables() {
    var i;
    $('#listdt').jqGrid('clearGridData');
    selected_mode = $("#plot_data").multiselect("getChecked").val();
    if (!selected_mode) {
        selected_mode = 'stat';
    }
    var select_y1 = $("#fcst_var_y1_1");
    var select_y2 = $('#fcst_var_y2_1');
    var indy_var_val = $('#indy_var_val');

    select_y1.empty();
    try {
        select_y1.multiselect('refresh');
    } catch (err) {
    }

    select_y2.empty();
    try {
        select_y2.multiselect('refresh');
    } catch (err) {
    }
    indy_var_val.empty();
    try {
        indy_var_val.multiselect('refresh');
    } catch (err) {
    }
    for (i = 1; i < fcst_var_y1_indexes.length; i++) {
        removeFcstVar("fcst_var_y1_" + fcst_var_y1_indexes[i]);
    }

    for (i = 0; i < fcst_var_y2_indexes.length; i++) {
        removeFcstVar("fcst_var_y2_" + fcst_var_y2_indexes[i]);
    }

    for (i = 1; i < series_var_y1_indexes.length; i++) {
        removeSeriesVar("series_var_y1_" + series_var_y1_indexes[i]);
    }

    for (i = 0; i < series_var_y2_indexes.length; i++) {
        removeSeriesVar("series_var_y2_" + series_var_y2_indexes[i]);
    }
    var fixed_var_indexes_copy = fixed_var_indexes.slice();
    for (i = 0; i < fixed_var_indexes_copy.length; i++) {
        removeFixedVar("fixed_var_" + fixed_var_indexes_copy[i]);
    }
    $("#group_series_var_y1_1").prop('checked', false);


    //get value of database
    var databases = getSelectedDatabases();
    if (!databases || databases.length === 0) {
        $('#plot_data').val("stat");
        $("#plot_data").multiselect('refresh');
    } else {

        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + databases + '</db_con><list_val><' + selected_mode + '_field>FCST_VAR</' + selected_mode + '_field></list_val></request>',
            error: function () {
            },
            success: function (data) {
                var values = $(data).find("val");
                var opt;
                if (values.length > 0) {
                    var options = [];
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        if (i === 0 || (i !== 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted,
                                title: value_to_desc_map[t.text()]
                            });
                            options.push(opt);
                        } else if (i !== 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }

                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;
                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select_y1);
                        options[i].clone().appendTo(select_y2);
                    }
                    try {
                        select_y1.multiselect('refresh');
                    } catch (err) {
                    }
                    try {
                        select_y2.multiselect('refresh');
                    } catch (err) {
                    }
                } else {

                    if (selected_mode === 'stat') {
                        $('#plot_data').val("mode");

                    } else if (selected_mode === 'mode') {
                        $('#plot_data').val("mtd");

                    } else if (selected_mode === 'mtd') {
                        $('#plot_data').val("stat");
                    }
                    $("#plot_data").multiselect('refresh');
                }


            }
        });
    }
}


function updateMode(y_axis, index, selectedVals) {
    var select = $("#fcst_stat_" + y_axis + "_" + index);
    select.empty();
    var selectedVariable, i, t;
    try {
        selectedVariable = $("#fcst_var_" + y_axis + "_" + index).multiselect("getChecked").val();
    } catch (err) {
        selectedVariable = $("#fcst_var_" + y_axis + "_" + index + ' option:first-child').val();
    }


    var opt, selected;
    for (i = 0; i < listStatModeRatio.length; i++) {
        t = listStatModeRatio[i];
        if ($.isArray(selectedVals)) {
            selected = $.inArray(t, selectedVals) >= 0;
        } else {
            selected = t == selectedVals;
        }
        opt = $('<option />', {
            value: t,
            text: t,
            title: value_to_desc_map[t],
            selected: selected
        });
        opt.appendTo(select);
    }
    try {
        select.multiselect("option", "noneSelectedText", "Select ratio stat");
        select.multiselect('refresh');
    } catch (err) {
    }
    var fcst_stat_mode = $("#fcst_stat_mode_" + y_axis + "_" + index);
    var selectedModeStat = "";
    var selectedModeStatCode = "";
    if (selectedVals.length > 0 && selectedVals.split("_").length == 2) {
        selectedModeStat = selectedVals.split("_")[0];
        selectedModeStatCode = selectedVals.split("_")[1]
    }
    if (selectedModeStat == 'ACOVACOV') {
        selectedModeStat = 'ACOV';
    }
    var is_fcst_stat_mode = false;
    fcst_stat_mode.empty();
    try {
        fcst_stat_mode.multiselect('destroy');
    } catch (err) {
    }


    for (i = 0; i < listStatMode.length; i++) {
        t = listStatMode[i];
        selected = (t == selectedModeStat);
        if (selected) {
            is_fcst_stat_mode = true;
        }
        opt = $('<option />', {
            value: t,
            text: t,
            title: value_to_desc_map[t],
            selected: selected
        });
        opt.appendTo(fcst_stat_mode);

    }

    fcst_stat_mode.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 225,
        height: 300,
        noneSelectedText: "Select attribute stat",
        allUnselected: !is_fcst_stat_mode,
        click: function (event, ui) {
            var id_array = this.id.split("_");
            $("#fcst_stat_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1] + " option").removeAttr("selected");
            try {
                $("#fcst_stat_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]).multiselect("refresh");
            } catch (err) {
            }

            var config_table = $("#fcst_stat_mode_config_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]);
            config_table.css("display", "block");
            if (ui.value == "ACOV") {
                config_table.find(".non-acov").attr("disabled", true);
            } else {
                config_table.find(".non-acov").removeAttr("disabled");
            }
            if (listStatModePair.indexOf(ui.value) > -1) {
                config_table.find(".non-pair").attr("disabled", true);
            } else {
                config_table.find(".non-pair").removeAttr("disabled");
            }
            $("input[name=statistics][value=calculations_statistics]").prop('checked', true);
            $('#calc_stat').val('none');
            try {
                $('#calc_stat').multiselect('refresh');
            } catch (e) {
            }
            $('#aggregation_statistics ').hide();
            $('#calculations_statistics ').show();

            updateSeries();
        }
    });


    if (is_fcst_stat_mode) {
        var config_table = $("#fcst_stat_mode_config_" + y_axis + "_" + index);
        config_table.css("display", "block");
        if (selectedModeStat == "ACOV") {
            config_table.find(".non-acov").attr("disabled", true);
        } else {
            config_table.find(".non-acov").removeAttr("disabled");
        }
        //add a first letter if mode code has only 2 letters
        if (selectedModeStatCode.length == 2) {
            selectedModeStatCode = "A" + selectedModeStatCode;
        }
        if (selectedModeStat == "ACOV") {
            if (selectedModeStatCode[0] == "A") {
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            } else if (selectedModeStatCode[0] == "F") {
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', false);
            } else if (selectedModeStatCode[0] == "O") {
                config_table.find('[name="mode_stat_fcst"]').prop('checked', false);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            }
        } else {
            if (selectedModeStatCode[0] == "D") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', true);
            } else if (selectedModeStatCode[0] == "A") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', false);
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            } else if (selectedModeStatCode[0] == "F") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', false);
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', false);
            } else if (selectedModeStatCode[0] == "O") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', false);
                config_table.find('[name="mode_stat_fcst"]').prop('checked', false);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            }

            if (selectedModeStatCode[1] == "A") {
                config_table.find('[name="mode_stat_simple"]').prop('checked', true);
                config_table.find('[name="mode_stat_cluster"]').prop('checked', true);
            } else if (selectedModeStatCode[1] == "S") {
                config_table.find('[name="mode_stat_simple"]').prop('checked', true);
                config_table.find('[name="mode_stat_cluster"]').prop('checked', false);

            } else if (selectedModeStatCode[1] == "C") {
                config_table.find('[name="mode_stat_simple"]').prop('checked', false);
                config_table.find('[name="mode_stat_cluster"]').prop('checked', true);
            }
            if (selectedModeStatCode[2] == "A") {
                config_table.find('[name="mode_stat_matched"]').prop('checked', true);
                config_table.find('[name="mode_stat_unmatched"]').prop('checked', true);
            } else if (selectedModeStatCode[2] == "M") {
                config_table.find('[name="mode_stat_matched"]').prop('checked', true);
                config_table.find('[name="mode_stat_unmatched"]').prop('checked', false);
            } else if (selectedModeStatCode[2] == "U") {
                config_table.find('[name="mode_stat_matched"]').prop('checked', false);
                config_table.find('[name="mode_stat_unmatched"]').prop('checked', true);
            }
        }
        if (listStatModePair.indexOf(selectedModeStat) > -1) {
            config_table.find(".non-pair").attr("disabled", true);
        } else {
            config_table.find(".non-pair").removeAttr("disabled");
        }
    }


    if (selectedVariable === "N/A") {
        try {
            select.multiselect("disable");
        } catch (err) {
        }
        try {
            fcst_stat_mode.multiselect("disable");
        } catch (err) {
        }
    } else {
        try {
            select.multiselect("enable");
        } catch (err) {
        }
        try {
            fcst_stat_mode.multiselect("enable");
        } catch (err) {
        }
    }

    //update series_var
    select = $("#series_var_" + y_axis + "_" + index);
    select.empty();
    $.each(fix_var_value_to_title_mode_map, function (key, val) {
        select.append('<option value="' + key + '">' + val + '</option>');
    });
    try {
        select.multiselect('refresh');
    } catch (err) {

    }
}

function updateMtd(y_axis, index, selectedVals) {
    var select = $("#fcst_stat_" + y_axis + "_" + index);
    select.empty();
    var selectedVariable, i, t;
    try {
        selectedVariable = $("#fcst_var_" + y_axis + "_" + index).multiselect("getChecked").val();
    } catch (err) {
        selectedVariable = $("#fcst_var_" + y_axis + "_" + index + ' option:first-child').val();
    }


    var opt, selected;
    for (i = 0; i < listStatMtdRatio.length; i++) {
        t = listStatMtdRatio[i];
        if ($.isArray(selectedVals)) {
            selected = $.inArray(t, selectedVals) >= 0;
        } else {
            selected = t == selectedVals;
        }
        opt = $('<option />', {
            value: t,
            text: t,
            title: value_to_desc_map[t],
            selected: selected
        });
        opt.appendTo(select);
    }
    try {
        select.multiselect("option", "noneSelectedText", "Select ratio stat");
        select.multiselect('refresh');
    } catch (err) {
    }
    var fcst_stat_mode = $("#fcst_stat_mode_" + y_axis + "_" + index);
    var selectedModeStat = "";
    var selectedModeStatCode = "";

    if (selectedVals.length > 0) {

        var statArr = selectedVals.split("_");
        for (var i = 0; i < statArr.length - 1; i++) {
            selectedModeStat = selectedModeStat + statArr[i];
            if (i !== statArr.length - 2) {
                selectedModeStat = selectedModeStat + '_';
            }
        }
        selectedModeStatCode = statArr[statArr.length - 1];
    }

    var is_fcst_stat_mode = false;
    fcst_stat_mode.empty();
    try {
        fcst_stat_mode.multiselect('destroy');
    } catch (err) {
    }


    for (i = 0; i < listStatMtd.length; i++) {
        t = listStatMtd[i];
        selected = (t === selectedModeStat);
        if (selected) {
            is_fcst_stat_mode = true;
        }

        opt = $('<option />', {
            value: t,
            text: t,
            title: value_to_desc_map[t],
            selected: selected
        });
        opt.appendTo(fcst_stat_mode);

    }

    fcst_stat_mode.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 225,
        height: 300,
        noneSelectedText: "Select attribute stat",
        allUnselected: !is_fcst_stat_mode,
        click: function (event, ui) {
            var id_array = this.id.split("_");
            $("#fcst_stat_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1] + " option").removeAttr("selected");
            try {
                $("#fcst_stat_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]).multiselect("refresh");
            } catch (err) {
            }

            var config_table = $("#fcst_stat_mode_config_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]);
            config_table.css("display", "block");
            config_table.find(".non-acov").removeAttr("disabled");

            if (listStatModePair.indexOf(ui.value) > -1 || listStatMtd3dPair.indexOf(ui.value) > -1) {
                config_table.find(".non-pair").attr("disabled", true);
            } else {
                config_table.find(".non-pair").removeAttr("disabled");
            }
            $("input[name=statistics][value=calculations_statistics]").prop('checked', true);
            $('#calc_stat').val('none');
            try {
                $('#calc_stat').multiselect('refresh');
            } catch (e) {
            }
            $('#aggregation_statistics ').hide();
            $('#calculations_statistics ').show();

            updateSeries();
        }
    });


    if (is_fcst_stat_mode) {
        var config_table = $("#fcst_stat_mode_config_" + y_axis + "_" + index);
        config_table.css("display", "block");
        if (selectedModeStat == "ACOV") {
            config_table.find(".non-acov").attr("disabled", true);
        } else {
            config_table.find(".non-acov").removeAttr("disabled");
        }
        //add a first letter if mode code has only 2 letters
        if (selectedModeStatCode.length == 2) {
            selectedModeStatCode = "A" + selectedModeStatCode;
        }
        if (selectedModeStat == "ACOV") {
            if (selectedModeStatCode[0] == "A") {
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            } else if (selectedModeStatCode[0] == "F") {
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', false);
            } else if (selectedModeStatCode[0] == "O") {
                config_table.find('[name="mode_stat_fcst"]').prop('checked', false);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            }
        } else {
            if (selectedModeStatCode[0] == "D") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', true);
            } else if (selectedModeStatCode[0] == "A") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', false);
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            } else if (selectedModeStatCode[0] == "F") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', false);
                config_table.find('[name="mode_stat_fcst"]').prop('checked', true);
                config_table.find('[name="mode_stat_obs"]').prop('checked', false);
            } else if (selectedModeStatCode[0] == "O") {
                config_table.find('[name="mode_stat_diff"]').prop('checked', false);
                config_table.find('[name="mode_stat_fcst"]').prop('checked', false);
                config_table.find('[name="mode_stat_obs"]').prop('checked', true);
            }

            if (selectedModeStatCode[1] == "A") {
                config_table.find('[name="mode_stat_simple"]').prop('checked', true);
                config_table.find('[name="mode_stat_cluster"]').prop('checked', true);
            } else if (selectedModeStatCode[1] == "S") {
                config_table.find('[name="mode_stat_simple"]').prop('checked', true);
                config_table.find('[name="mode_stat_cluster"]').prop('checked', false);

            } else if (selectedModeStatCode[1] == "C") {
                config_table.find('[name="mode_stat_simple"]').prop('checked', false);
                config_table.find('[name="mode_stat_cluster"]').prop('checked', true);
            }
            if (selectedModeStatCode[2] == "A") {
                config_table.find('[name="mode_stat_matched"]').prop('checked', true);
                config_table.find('[name="mode_stat_unmatched"]').prop('checked', true);
            } else if (selectedModeStatCode[2] == "M") {
                config_table.find('[name="mode_stat_matched"]').prop('checked', true);
                config_table.find('[name="mode_stat_unmatched"]').prop('checked', false);
            } else if (selectedModeStatCode[2] == "U") {
                config_table.find('[name="mode_stat_matched"]').prop('checked', false);
                config_table.find('[name="mode_stat_unmatched"]').prop('checked', true);
            }
        }
        if (listStatMtd3dPair.indexOf(selectedModeStat) > -1) {
            config_table.find(".non-pair").attr("disabled", true);
        } else {
            config_table.find(".non-pair").removeAttr("disabled");
        }
    }


    if (selectedVariable === "N/A") {
        try {
            select.multiselect("disable");
        } catch (err) {
        }
        try {
            fcst_stat_mode.multiselect("disable");
        } catch (err) {
        }
    } else {
        try {
            select.multiselect("enable");
        } catch (err) {
        }
        try {
            fcst_stat_mode.multiselect("enable");
        } catch (err) {
        }
    }

    //update series_var
    select = $("#series_var_" + y_axis + "_" + index);
    select.empty();
    $.each(fix_var_value_to_title_mtd_map, function (key, val) {
        select.append('<option value="' + key + '">' + val + '</option>');
    });
    try {
        select.multiselect('refresh');
    } catch (err) {

    }
}

function updateStatVal() {
    var databases = getSelectedDatabases();
    if (databases) {
        var selectedVariable = $("#fcst_var_y1_1").multiselect("getChecked").val();
        $("#fcst_stat_y1_1").empty();
        var stat_select = $("#fcst_stat_y1_1");
        if (selectedVariable) {
            selectedVariable = selectedVariable.replace("&", "&amp;").replace(">", "&gt;").replace("<", "&lt;");
        }
        stat_select.empty();
        $.ajax({
                async: false,
                url: "servlet",
                type: "POST",
                dataType: 'xml',
                contentType: "application/xml",
                data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + databases + '</db_con><list_stat><stat_fcst_var>' + selectedVariable + '</stat_fcst_var></list_stat></request>',
                error: function () {
                },
                success: function (data) {
                    var values = $(data).find("val");
                    var opt;
                    var options = [];
                    if (values.length > 0) {
                        for (var i = 0; i < values.length; i++) {
                            var t = $(values[i]);
                            if (i == 0 || (i != 0 && t.text() !== $(values[i - 1]).text())) {
                                var text_formatted = t.text().formatAll();
                                opt = $('<option />', {
                                    value: text_formatted,
                                    text: text_formatted,
                                    title: value_to_desc_map[t.text()]
                                });
                                options.push(opt);
                            } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                                options[options.length - 1].text(options[options.length - 1].text() + '*');
                            }
                        }
                        var length;
                        var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;
                        for (var i = 0; i < options.length; i++) {
                            if (options[i].text() !== options[i][0].value) {
                                length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                                if (length === databaseNumbers) {
                                    options[i].text(options[i][0].value + "*");
                                } else {
                                    options[i].text(options[i][0].value);
                                }
                            }
                            options[i].appendTo(stat_select);
                        }
                    } else {
                        opt = $('<option />', {
                            value: "N/A",
                            text: "N/A"
                        });
                        opt.appendTo(stat_select);

                    }
                    try {
                        stat_select.multiselect('refresh');
                    } catch (err) {
                        console.log(err);
                    }
                    updateSeries();
                }
            }
        );
    }
}


function updateStats(y_axis, index, selectedVals) {
    var fcst_stat_select = $("#fcst_stat_" + y_axis + "_" + index);
    var fcst_stat_mode = $("#fcst_stat_mode_" + y_axis + "_" + index);
    var selected_mode = $("#plot_data").multiselect("getChecked").val();
    var databases = getSelectedDatabases();
    if (databases) {
        var selectedVariable;
        try {
            selectedVariable = $("#fcst_var_" + y_axis + "_" + index).multiselect("getChecked").val();
        } catch (err) {
            selectedVariable = $("#fcst_var_" + y_axis + "_" + index + ' option:first-child').val();
        }
        if (selected_mode === "stat") {
            fcst_stat_select.empty();
            try {
                fcst_stat_mode.multiselect("destroy");
            } catch (err) {
            }
            fcst_stat_mode.css("display", "none");
            $("#fcst_stat_mode_config_" + y_axis + "_" + index).css("display", "none");
            try {
                fcst_stat_select.multiselect("option", "noneSelectedText", 'Select attribute stat');
            } catch (err) {
                fcst_stat_select.prop('disabled', 'disabled');
            }
        } else {
            if (!selected_mode) {
                fcst_stat_select.empty();
                try {
                    fcst_stat_select.multiselect("option", "noneSelectedText", 'Select value');
                } catch (err) {
                    fcst_stat_select.prop('disabled', 'disabled');
                }
            } else {

                try {
                    fcst_stat_mode.multiselect("enable");
                } catch (err) {
                    fcst_stat_mode.prop('disabled', '');
                }
                try {
                    fcst_stat_select.multiselect("option", "noneSelectedText", 'Select ratio stat');
                } catch (err) {
                    fcst_stat_select.prop('disabled', 'disabled');
                }
            }
        }
        if (selectedVariable === "N/A") {
            try {
                fcst_stat_select.multiselect("disable");
            } catch (err) {
                fcst_stat_select.prop('disabled', 'disabled');
            }
        } else {
            try {
                fcst_stat_select.multiselect("enable");
            } catch (err) {
                fcst_stat_select.prop('disabled', '');
            }
            if (selectedVariable) {
                selectedVariable = selectedVariable.replace("&", "&amp;").replace(">", "&gt;").replace("<", "&lt;");
            }
            $.ajax({
                async: false,
                url: "servlet",
                type: "POST",
                dataType: 'xml',
                contentType: "application/xml",
                data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + databases + '</db_con><list_stat><stat_fcst_var>' + selectedVariable + '</stat_fcst_var></list_stat></request>',
                error: function () {
                },
                success: function (data) {
                    var values = $(data).find("val");
                    var opt, selected;
                    var options = [];
                    if (values.length > 0) {
                        for (var i = 0; i < values.length; i++) {
                            var t = $(values[i]);
                            selected = $.inArray(t.text(), selectedVals) >= 0;
                            if (i == 0 || (i != 0 && t.text() !== $(values[i - 1]).text())) {
                                var text_formatted = t.text().formatAll();
                                opt = $('<option />', {
                                    value: text_formatted,
                                    text: text_formatted,
                                    title: value_to_desc_map[t.text()],
                                    selected: selected
                                });
                                options.push(opt);
                            } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                                options[options.length - 1].text(options[options.length - 1].text() + '*');
                            }
                        }
                        var length;
                        var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;
                        for (var i = 0; i < options.length; i++) {
                            if (options[i].text() !== options[i][0].value) {
                                length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                                if (length === databaseNumbers) {
                                    options[i].text(options[i][0].value + "*");
                                } else {
                                    options[i].text(options[i][0].value);
                                }
                            }
                            options[i].appendTo(fcst_stat_select);
                        }
                    } else {
                        opt = $('<option />', {
                            value: "N/A",
                            text: "N/A"
                        });
                        opt.appendTo(fcst_stat_select);

                    }
                    try {
                        fcst_stat_select.multiselect('refresh');
                    } catch (err) {

                    }
                    selectedVals = [];
                }
            });
        }
        //update series_var
        var select = $("#series_var_" + y_axis + "_" + index);
        select.empty();
        $.each(series_var_value_to_title_stat_map, function (key, val) {
            select.append('<option value="' + key + '">' + val + '</option>');
        });
        try {
            select.multiselect('refresh');
        } catch (err) {
        }
    }
}

function updateSeriesVarValEns(index, selectedVals) {
    $('#listdt').jqGrid('clearGridData');

    var select = $("#series_var_val_y1_" + index);
    select.empty();
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedSeriesVariable;
        try {
            selectedSeriesVariable = $("#series_var_y1_" + index).multiselect("getChecked").val();
        } catch (err) {
            selectedSeriesVariable = $("#series_var_y1_" + index + ' option:first-child').val();
        }
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            contentType: "application/xml",
            dataType: 'xml',
            processData: false,
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><ensss_field>' + selectedSeriesVariable + '</ensss_field><stat><fcst_var name="TMP"></fcst_var></stat></list_val></request>',
            error: function () {

            },
            success: function (data) {
                seriesY1VarValResponse[index] = data;
                var values = $(data).find("val");
                var opt, selected;
                var options = [];
                if (values.length > 0) {
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        selected = $.inArray(t.text(), selectedVals) >= 0;
                        if (i == 0 || (i != 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted,
                                selected: selected
                            });
                            options.push(opt);
                        } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }
                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select);
                    }
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                } else {
                    opt = $('<option />', {
                        value: "N/A",
                        text: "N/A"
                    });
                    opt.appendTo(select);
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                }
                selectedVals = [];
            }
        });
    }
}

function updateSeriesVarVal(y_axis, index, selectedVals) {
    var select = $("#series_var_val_" + y_axis + "_" + index);
    select.empty();
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selected_mode, statst;
        if (currentTab === 'Perf') {
            selected_mode = 'perf';
            statst = '<stat></stat>';
        } else if (currentTab === 'Taylor') {
            selected_mode = 'taylor';
            statst = convertVarsAndStatsToXml();
        } else {
            selected_mode = $("#plot_data").multiselect("getChecked").val();
            statst = convertVarsAndStatsToXml();
        }
        var selectedSeriesVariable;
        try {
            selectedSeriesVariable = $("#series_var_" + y_axis + "_" + index).multiselect("getChecked").val();
        } catch (err) {
            selectedSeriesVariable = $("#series_var_" + y_axis + "_" + index).find('option:first-child').val();
        }
        if (typeof selectedSeriesVariable !== 'undefined') {
            var url = '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><' + selected_mode + '_field>' + selectedSeriesVariable + '</' + selected_mode + '_field>' + statst + '</list_val></request>';
            $.ajax({
                async: false,
                url: "servlet",
                type: "POST",
                data: url,
                dataType: 'xml',
                processData: false,
                contentType: "application/xml",
                error: function () {

                },
                success: function (data) {
                    if (y_axis === 'y1') {
                        seriesY1VarValResponse[index] = data;
                    } else {
                        seriesY2VarValResponse[index] = data;
                    }

                    var values = $(data).find("val");
                    var opt, selected;
                    var options = [];
                    if (values.length > 0) {
                        for (var i = 0; i < values.length; i++) {
                            var t = $(values[i]);
                            if ($.type(selectedVals) === "string") {
                                selected = t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&") === selectedVals;
                            } else {
                                selected = $.inArray(t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&"), selectedVals) >= 0;
                            }
                            if (i === 0 || (i !== 0 && t.text() !== $(values[i - 1]).text())) {
                                opt = $('<option />', {
                                    value: t.text(),
                                    text: t.text(),
                                    selected: selected
                                });
                                options.push(opt);
                            } else if (i !== 0 && t.text() === $(values[i - 1]).text()) {
                                options[options.length - 1].text(options[options.length - 1].text() + '*');
                            }
                        }
                        var length;
                        var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                        for (var i = 0; i < options.length; i++) {
                            if (options[i].text() !== options[i][0].value) {
                                length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                                if (length === databaseNumbers) {
                                    options[i].text(options[i][0].value + "*");
                                } else {
                                    options[i].text(options[i][0].value);
                                }
                            }
                            options[i].appendTo(select);
                        }
                        try {
                            select.multiselect('refresh');
                        } catch (err) {
                        }
                    } else {
                        opt = $('<option />', {
                            value: "N/A",
                            text: "N/A"
                        });
                        opt.appendTo(select);
                        try {
                            select.multiselect('refresh');
                        } catch (err) {
                        }

                    }
                    if (selectedVals.length === 1 && selectedVals[0].indexOf(",") !== -1) {
                        $("#group_series_var_" + y_axis + "_" + index).prop('checked', true);
                    }
                    selectedVals = [];
                }
            });
        }
    }
}

function updateFixedVarValHist(index, selectedVals, equalize) {
    if (equalize && equalize === "false") {
        $("#fix_var_event_equal_" + index).prop("checked", false);
    }
    var fixed_var_val = $("#fixed_var_val_" + index);
    fixed_var_val.empty();
    //get value of database
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedFixedVariable;
        try {
            selectedFixedVariable = $("#fixed_var_" + index).multiselect("getChecked").val();
        } catch (err) {
            selectedFixedVariable = $("#fixed_var_" + index + ' option:first-child').val();
        }
        var field_type;
        if (currentTab === 'Hist') {
            field_type = $("input:radio[name='hist_line_type']:checked").val();
        } else if (currentTab === 'Roc') {
            field_type = "roc";
        } else if (currentTab === 'Eclv') {
            field_type = "eclv";
        } else if (currentTab === 'Rely') {
            field_type = "rely";
        } else if (currentTab === 'Ens_ss') {
            field_type = "ensss";
        } else if (currentTab === 'Perf') {
            field_type = "perf";
        } else if (currentTab === 'Taylor') {
            field_type = "taylor";
        }
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><' + field_type + '_field>' + selectedFixedVariable + '</' + field_type + '_field></list_val></request>',
            error: function () {
            },
            success: function (data) {
                fixVarValResponse[index] = data;
                var values = $(data).find("val");
                var opt, selected;
                if (values.length > 0) {
                    var options = [];
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        selected = $.inArray(t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&"), selectedVals) >= 0;
                        if (i === 0 || (i !== 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted,
                                selected: selected
                            });
                            options.push(opt);
                        } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }
                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(fixed_var_val);
                    }
                    try {
                        fixed_var_val.multiselect('refresh');
                    } catch (err) {
                    }
                } else {
                    opt = $('<option />', {
                        value: "N/A",
                        text: "N/A"
                    });
                    opt.appendTo(fixed_var_val);
                    try {
                        fixed_var_val.multiselect('refresh');
                    } catch (err) {
                    }
                }
                selectedVals = [];
            }
        });
    }
}

function updateYvalueCountour(selectedVals) {
    var select = $("#series_var_val_y1_1");
    select.empty();
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedVariable;
        try {
            selectedVariable = $("#series_var_y1_1").multiselect("getChecked").val();
        } catch (err) {
            selectedVariable = $("#series_var_y1_1").find("option:first-child").val();
        }
        var statst = '<stat><fcst_var name="' + $("#fcst_var_y1_1").val() + '" ><val>' + $("#fcst_stat_y1_1").val() + '</val></fcst_var></stat>';
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><stat_field>' + selectedVariable + '</stat_field>' + statst + '</list_val></request>',
            error: function () {
                try {
                    select.multiselect('refresh');
                } catch (err) {
                }
            },
            success: function (data) {
                var values = $(data).find("val");
                var opt, selected;
                var options = [];
                if (values.length > 0) {
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        selected = $.inArray(t.text(), selectedVals) >= 0;
                        if (i == 0 || (i != 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted,
                                selected: selected
                            });
                            options.push(opt);
                        } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }
                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select);
                    }

                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                } else {
                    opt = $('<option />', {
                        value: "N/A",
                        text: "N/A"
                    });
                    opt.appendTo(select);
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                }
                selectedVals = [];

            }
        });
    }
}

function updateDerivedVarVal() {
    var select = $("#derived_var_val_1");
    select.empty();
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedFixedVariable;
        var statst = '<stat><fcst_var name="' + $("#fcst_var_y1_1").val() + '" ><val>' + $("#fcst_stat_y1_1").val() + '</val></fcst_var></stat>';

        try {
            selectedFixedVariable = $("#derived_var_1").multiselect("getChecked").val();
        } catch (err) {
            selectedFixedVariable = $("#derived_var_1" + ' option:first-child').val();
        }
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><stat_field>' + selectedFixedVariable + '</stat_field>' + statst + '</list_val></request>',
            error: function () {
                try {
                    select.multiselect('refresh');
                } catch (err) {
                }
            },
            success: function (data) {
                var values = $(data).find("val");

                var opt, selected;
                var options = [];
                if (values.length > 0) {
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        if (i == 0 || (i != 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted
                            });
                            options.push(opt);
                        } else if (i != 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }
                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select);
                    }

                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                } else {
                    opt = $('<option />', {
                        value: "N/A",
                        text: "N/A"
                    });
                    opt.appendTo(select);
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                }
                updateSeries();
            }
        });
    }
}

function updateFixedVarVal(index, selectedVals, equalize) {
    if (equalize && equalize === "false") {
        $("#fix_var_event_equal_" + index).prop("checked", false);
    }
    var select = $("#fixed_var_val_" + index);
    select.empty();
    //get value of database
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedFixedVariable;
        var selected_mode, statst;
        if (currentTab === 'Perf') {
            selected_mode = 'stat';
            statst = '<stat><fcst_var><val>FAR</val><val>NBR_FAR</val></fcst_var></stat>';
        } else if (currentTab === 'Eclv') {
            selected_mode = 'eclv';
            statst = '<stat><fcst_var><val>NA</val></fcst_var></stat>';
        } else if (currentTab === 'Taylor') {
            selected_mode = 'taylor';
            statst = convertVarsAndStatsToXml();
        } else if (currentTab === 'Contour') {
            selected_mode = 'stat';
            statst = '<stat><fcst_var name="' + $("#fcst_var_y1_1").val() + '" ><val>' + $("#fcst_stat_y1_1").val() + '</val></fcst_var></stat>';
        } else {
            selected_mode = $("#plot_data").multiselect("getChecked").val();
            statst = convertVarsAndStatsToXml();
        }
        try {
            selectedFixedVariable = $("#fixed_var_" + index).multiselect("getChecked").val();
        } catch (err) {
            selectedFixedVariable = $("#fixed_var_" + index + ' option:first-child').val();
        }
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><' + selected_mode + '_field>' + selectedFixedVariable + '</' + selected_mode + '_field>' + statst + '</list_val></request>',
            error: function () {
                try {
                    select.multiselect('refresh');
                } catch (err) {
                }
            },
            success: function (data) {
                fixVarValResponse[index] = data;
                var values = $(data).find("val");

                var opt, selected;
                var options = [];
                if (values.length > 0) {
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        selected = $.inArray(t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&"), selectedVals) >= 0;
                        if (i === 0 || (i !== 0 && t.text() !== $(values[i - 1]).text())) {
                            var text_formatted = t.text().formatAll();
                            opt = $('<option />', {
                                value: text_formatted,
                                text: text_formatted,
                                selected: selected
                            });
                            options.push(opt);
                        } else if (i !== 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }
                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select);
                    }

                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                } else {
                    opt = $('<option />', {
                        value: "N/A",
                        text: "N/A"
                    });
                    opt.appendTo(select);
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                }
                selectedVals = [];
            }
        });
    }
}


function populateIndyVarVal(selectedVals) {
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedFixedVariable;
        var selected_mode, statst;
        if (currentTab === 'Perf') {
            selected_mode = 'stat';
            statst = '<stat><fcst_var><val>FAR</val><val>NBR_FAR</val></fcst_var></stat>';
        } else if (currentTab === 'Contour') {
            selected_mode = 'stat';
            statst = '<stat><fcst_var name="' + $("#fcst_var_y1_1").val() + '" ><val>' + $("#fcst_stat_y1_1").val() + '</val></fcst_var></stat>';
        } else {
            selected_mode = $("#plot_data").multiselect("getChecked").val();
            statst = convertVarsAndStatsToXml();
        }
        try {
            selectedFixedVariable = $("#indy_var").multiselect("getChecked").val();
        } catch (err) {
            selectedFixedVariable = $("#indy_var" + ' option:first-child').val();
        }
        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            dataType: 'xml',
            processData: false,
            contentType: "application/xml",
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><' + selected_mode + '_field>' + selectedFixedVariable + '</' + selected_mode + '_field>' + statst + '</list_val></request>',
            error: function () {
            },
            success: function (data) {
                var values = $(data).find("val");
                if (data !== previousIndVarValResponse) {
                    previousIndVarValResponse = data;
                    var select = $("#indy_var_val");

                    var indy_var_val = $('[name="multiselect_indy_var_val"]');
                    if (indy_var_val && indy_var_val.length > 0) {
                        indy_var_vals_to_attr = {};
                        for (var i = 0; i < indy_var_val.length; i++) {
                            var jqObject = $(indy_var_val[i]);
                            var obj = {};
                            var id = jqObject.attr("id");
                            obj.label = $('#' + id + '_label').val();
                            obj.plot_val = $('#' + id + '_plot_val').val();
                            indy_var_vals_to_attr[indy_var_val[i].value] = obj;
                        }
                    }
                    $("#indy_var_val").multiselect("option", "indy_var_vals_to_attr", indy_var_vals_to_attr);
                    select.empty();
                    var opt, selected;
                    var options = [];
                    if (values.length > 0) {
                        for (var i = 0; i < values.length; i++) {
                            var t = $(values[i]);
                            selected = $.inArray(t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&"), selectedVals) >= 0;
                            if (i === 0 || (i !== 0 && t.text() !== $(values[i - 1]).text())) {
                                var text_formatted = t.text().formatAll();
                                opt = $('<option />', {
                                    value: text_formatted,
                                    text: text_formatted,
                                    selected: selected,
                                    class: "indy-var-option"
                                });
                                options.push(opt);
                            } else if (i !== 0 && t.text() === $(values[i - 1]).text()) {
                                options[options.length - 1].text(options[options.length - 1].text() + '*');
                            }
                        }
                        var length;
                        var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                        for (var i = 0; i < options.length; i++) {
                            if (options[i].text() !== options[i][0].value) {
                                length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                                if (length === databaseNumbers) {
                                    options[i].text(options[i][0].value + "*");
                                } else {
                                    options[i].text(options[i][0].value);
                                }
                            }
                            options[i].appendTo(select);
                        }
                        try {
                            select.multiselect('refresh');
                            if (!(indy_var_val && indy_var_val.length > 0)) {
                                $("#indy_var_val").multiselect("option", "indy_var_vals_to_attr", null);
                            }
                        } catch (err) {
                        }
                    } else {
                        opt = $('<option />', {
                            value: "N/A",
                            text: "N/A"
                        });
                        opt.appendTo(select);
                        try {
                            select.multiselect('refresh');
                        } catch (err) {
                        }
                    }
                }
            }
        });
    }
}

function convertVarsAndStatsToXml() {
    var result = "<stat>";
    var fcst_var, i;
    for (i = 0; i < fcst_var_y1_indexes.length; i++) {
        fcst_var = convertVarAndStatsForAxisToXml("y1", fcst_var_y1_indexes[i]);
        result = result + fcst_var;
    }
    for (i = 0; i < fcst_var_y2_indexes.length; i++) {
        fcst_var = convertVarAndStatsForAxisToXml("y2", fcst_var_y2_indexes[i]);
        result = result + fcst_var;
    }
    return result + "</stat>";
}

function convertVarAndStatsForAxisToXml(y_axis, index) {
    var selectedVariable;
    try {
        selectedVariable = $("#fcst_var_" + y_axis + "_" + index).multiselect("getChecked").val();
    } catch (err) {
        selectedVariable = $("#fcst_var_" + y_axis + "_" + index + ' option:first-child').val();
    }
    if (selectedVariable) {
        selectedVariable = selectedVariable.replace("&", "&amp;").replace(">", "&gt;").replace("<", "&lt;");
    }
    var fcst_var = '<fcst_var name="' + selectedVariable + '" >';
    var fcst_stats = $("#fcst_stat_" + y_axis + "_" + index).val();
    if (fcst_stats) {
        for (var j = 0; j < fcst_stats.length; j++) {
            fcst_var = fcst_var + '<val>' + fcst_stats[j] + '</val>';
        }
    }
    fcst_var = fcst_var + '</fcst_var>';
    return fcst_var;
}

function createStatNameForModeArrt(stat_name, y_axis, fcst_var_index) {
    var fcst_stat_mode_config = $("#fcst_stat_mode_config_" + y_axis + "_" + fcst_var_index);
    //this is mode attribute stat - add code
    var boolDiff = fcst_stat_mode_config.find('[name="mode_stat_diff"]').is(':checked');
    var boolFcst = fcst_stat_mode_config.find('[name="mode_stat_fcst"]').is(':checked');
    var boolObs = fcst_stat_mode_config.find('[name="mode_stat_obs"]').is(':checked');
    var strCode = "_";
    if (listStatModeSingle.indexOf(stat_name) > -1
        || listStatMtd3dSingle.indexOf(stat_name) > -1
        || listStatMtd2d.indexOf(stat_name) > -1) {
        if (boolDiff) {
            strCode += "D";
        } else if (boolFcst && boolObs) {
            strCode += "A";
        } else if (boolFcst) {
            strCode += "F";
        } else if (boolObs) {
            strCode += "O";
        } else {
            strCode += "A";
        }
    }
    //  if the stat is ACOV, return the code
    if (stat_name.startsWith("ACOV")) {
        strCode = stat_name + strCode + "SA";
    } else {

        //  determine the second letter of the code [A|S|C]
        var boolSimp = fcst_stat_mode_config.find('[name="mode_stat_simple"]').is(':checked');
        var boolClus = fcst_stat_mode_config.find('[name="mode_stat_cluster"]').is(':checked');
        if (boolSimp && boolClus) {
            strCode += "A";
        } else if (boolSimp) {
            strCode += "S";
        } else if (boolClus) {
            strCode += "C";
        } else {
            strCode += "A";
        }
        //  determine the third letter of the code [A|M|U]
        var boolMat = fcst_stat_mode_config.find('[name="mode_stat_matched"]').is(':checked');
        var boolUnm = fcst_stat_mode_config.find('[name="mode_stat_unmatched"]').is(':checked');
        if (boolMat && boolUnm) {
            strCode += "A";
        } else if (boolMat) {
            strCode += "M";
        } else if (boolUnm) {
            strCode += "U";
        } else {
            strCode += "A";
        }
        strCode = stat_name + strCode;
    }
    return strCode;

}

function createMapForForecastVar(y_axis, fcst_var_indexes, selected_mode) {
    var forecast_var_to_stat_map = {};
    var stat;
    for (var i = 0; i < fcst_var_indexes.length; i++) {
        var fcst_var = $("#fcst_var_y" + y_axis + "_" + fcst_var_indexes[i]).val();
        if (!forecast_var_to_stat_map.hasOwnProperty(fcst_var)) {
            forecast_var_to_stat_map[fcst_var] = [];
        }
        var statsArr = $("#fcst_stat_y" + y_axis + "_" + fcst_var_indexes[i]).val();
        if (statsArr != null) {
            if (Array.isArray(statsArr)) {
                for (var j = 0; j < statsArr.length; j++) {
                    if ((selected_mode === "mode" && listStatModeRatio.indexOf(statsArr[j]) === -1)
                        || (selected_mode === "mtd" && listStatMtdRatio.indexOf(statsArr[j]) === -1)) {
                        stat = createStatNameForModeArrt(statsArr[j], "y" + y_axis, fcst_var_indexes[i]);
                    } else {
                        stat = statsArr[j];
                    }
                    forecast_var_to_stat_map[fcst_var].push(stat);
                }
            } else {
                forecast_var_to_stat_map[fcst_var].push(statsArr);
            }
        } else {
            if (selected_mode === "mode" || selected_mode === "mtd") {
                statsArr = $("#fcst_stat_mode_y" + y_axis + "_" + fcst_var_indexes[i]).val();
                if (statsArr != null) {
                    stat = createStatNameForModeArrt(statsArr, "y" + y_axis, fcst_var_indexes[i]);
                    forecast_var_to_stat_map[fcst_var].push(stat);
                }
            }
        }
    }
    return forecast_var_to_stat_map;
}

function createSeriesMapForPermutation(fcst_var_indexes, y_axis) {
    var series_var_to_values_map = {};
    var selected_series_val, selected_series, isGroup, seriesName;

    for (var i = fcst_var_indexes.length - 1; i >= 0; i--) {
        var listVal = [];
        selected_series = $("#series_var_" + y_axis + "_" + fcst_var_indexes[i]).multiselect("getChecked")[0].value;
        isGroup = $("#group_series_var_" + y_axis + "_" + fcst_var_indexes[i]).is(':checked');
        try {
            selected_series_val = $("#series_var_val_" + y_axis + "_" + fcst_var_indexes[i]).multiselect("getChecked");
        } catch (err) {
            selected_series_val = [];
        }
        for (var j = 0; j < selected_series_val.length; j++) {
            listVal.push(selected_series_val[j].value);
        }
        if (isGroup) {
            seriesName = "Group_" + y_axis + "_" + fcst_var_indexes[i];
            group_name_to_value_map[seriesName] = listVal;
            listVal = [seriesName];
        }
        var strValCur = series_var_to_values_map[selected_series];
        if (undefined !== strValCur) {
            listVal = listVal.concat(strValCur);
        }
        series_var_to_values_map[selected_series] = listVal;
    }
    return series_var_to_values_map;
}

function createSeriesMapForPermutationEns(fcst_var_indexes, y_axis) {
    var series_var_to_values_map = {};
    var selected_series_val, selected_series;

    for (var i = fcst_var_indexes.length - 1; i >= 0; i--) {
        var listVal = [];
        try {
            selected_series = $("#series_var_" + y_axis + "_" + fcst_var_indexes[i]).multiselect("getChecked")[0].value;
        } catch (err) {
            selected_series = $("#series_var_" + y_axis + "_" + fcst_var_indexes[i]).val();
        }
        try {
            selected_series_val = $("#series_var_val_" + y_axis + "_" + fcst_var_indexes[i]).multiselect("getChecked");
        } catch (err) {
            selected_series_val = [];
        }
        for (var j = 0; j < selected_series_val.length; j++) {
            listVal.push(selected_series_val[j].value);
        }

        var strValCur = series_var_to_values_map[selected_series];
        if (undefined != strValCur) {
            listVal = strValCur.concat(listVal);
        }
        series_var_to_values_map[selected_series] = listVal;
    }
    return series_var_to_values_map;
}

function updateSeriesHist() {
    var table = $("#listdt");
    table.saveCell(lastSelRow, lastSelCol);
    var oldSeriesData = table.jqGrid('getRowData');
    table.jqGrid('clearGridData');

    var series_perm;
    var number_series = 0;
    var series_formatting = {};
    var isFixedFormatting = $("#seriesLock").is(':checked');
    var newSeriesData = [];
    var y_axis = "Y1";
    var plot_ci = [];
    var plot_disp = [];
    var show_signif = [];
    var colors = [];
    var pch = [];
    var lty = [];
    var lwd = [];
    var con_series = [];
    var order_series = [];
    var legend = [];
    var type = [];
    var stat_name;
    if (currentTab === 'Hist') {
        var field_type = $("input:radio[name='hist_line_type']:checked").val();
        if (field_type === 'rhist') {
            stat_name = "Rank Histogram";
        } else if (field_type === 'phist') {
            stat_name = "Probability Histogram";
        } else if (field_type === 'relp') {
            stat_name = "Relative Histogram";
        }
    } else if (currentTab === 'Roc') {
        stat_name = "ROC Curve";
    } else if (currentTab === 'Rely') {
        stat_name = "Reliability Curve";
    } else if (currentTab === 'Taylor') {
        stat_name = $("#fcst_var_y1_1").val();
    } else if (currentTab === 'Eclv') {
        stat_name = "Economic value";
    }

    if (initXML != null) {
        plot_ci = initXML.find("plot").find("plot_ci").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        plot_disp = initXML.find("plot").find("plot_disp").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        show_signif = initXML.find("plot").find("show_signif").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < plot_disp.length; i++) {
            if (plot_disp[i].trim() === "TRUE") {
                plot_disp[i] = "No";
            } else {
                plot_disp[i] = "Yes";
            }
            if (show_signif[i].trim() === "TRUE") {
                show_signif[i] = "No";
            } else {
                show_signif[i] = "Yes";
            }
        }

        colors = initXML.find("plot").find("colors").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < colors.length; i++) {
            colors[i] = colors[i].replace(/FF$/, "");
        }
        pch = initXML.find("plot").find("pch").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lty = initXML.find("plot").find("lty").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lwd = initXML.find("plot").find("lwd").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        con_series = initXML.find("plot").find("con_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        order_series = initXML.find("plot").find("order_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        type = initXML.find("plot").find("type").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        legend = initXML.find("plot").find("legend").text().replace("c(", "").replace(/\)$/, "").replace(/"/g, "").split(",");
        if (legend.length != order_series.length) {
            for (var k = 0; k < order_series.length; k++) {
                legend[k] = "";
            }
        }
    }


    series_perm = permuteSeries(createSeriesMapForPermutationEns(series_var_y1_indexes, "y1"), 0);
    var seriesName;
    if (series_perm.length == 0) {
        series_perm[0] = "";
    }

    if (currentTab == 'Roc' || currentTab == 'Rely' || currentTab == 'Eclv') {
        var selected_stats;
        try {
            selected_stats = $("#summary_curve").multiselect("getChecked");
        } catch (err) {
            selected_stats = [];
        }
        for (var i = 0; i < selected_stats.length; i++) {
            if (selected_stats[i].value != 'none') {
                series_perm.push(selected_stats[i].value);
            }
        }
    }
    for (var series_perm_index = 0; series_perm_index < series_perm.length; series_perm_index++) {
        seriesName = series_perm[series_perm_index] + " " + stat_name;
        //check if this series was their before
        var isSeriesOld = false;
        for (var i = 0; i < oldSeriesData.length; i++) {
            if (oldSeriesData[i]['title'] == seriesName) {
                series_formatting = {};
                series_formatting.title = seriesName;
                series_formatting.y_axis = y_axis;
                series_formatting.order = number_series + 1;
                series_formatting.hide = oldSeriesData[i]['hide'];
                series_formatting.plot_ci = oldSeriesData[i]['plot_ci'];
                series_formatting.show_signif = oldSeriesData[i]['show_signif'];
                series_formatting.color = oldSeriesData[i]['color'];
                series_formatting.pch = oldSeriesData[i]['pch'];
                series_formatting.type = oldSeriesData[i]['type'];
                series_formatting.lty = oldSeriesData[i]['lty'];
                series_formatting.lwd = oldSeriesData[i]['lwd'];
                series_formatting.con_series = oldSeriesData[i]['con_series'];
                series_formatting.legend = oldSeriesData[i]['legend'];
                series_formatting.id = number_series + 1;
                isSeriesOld = true;
                break;
            }
        }
        //if it is a new series
        if (!isSeriesOld) {
            //check if it is the first
            if (isFixedFormatting && number_series > 0 && initXML == null) {
                series_formatting = jQuery.extend(true, {}, newSeriesData[newSeriesData.length - 1]);
                series_formatting.title = seriesName;
                series_formatting.y_axis = y_axis;
                series_formatting.id = number_series + 1;
                series_formatting.order = number_series + 1;
            } else {
                if (initXML != null) {
                    series_formatting = {};
                    series_formatting.title = seriesName;
                    series_formatting.y_axis = y_axis;
                    if (!order_series[number_series] || order_series[number_series] == '') {
                        series_formatting.order = parseInt(i + 1);
                    } else {
                        series_formatting.order = parseInt(order_series[number_series]);
                    }
                    series_formatting.hide = plot_disp[number_series];
                    series_formatting.plot_ci = plot_ci[number_series].trim();
                    series_formatting.show_signif = show_signif[number_series];
                    series_formatting.pch = pch[number_series].trim();
                    series_formatting.type = type[number_series].trim();
                    series_formatting.lty = lty[number_series].trim();
                    series_formatting.lwd = lwd[number_series].trim();
                    series_formatting.con_series = con_series[number_series].trim();
                    series_formatting.legend = legend[number_series].trim();
                    series_formatting.color = colors[number_series].trim();
                    series_formatting.id = number_series + 1;

                } else {
                    series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
                    series_formatting.title = seriesName;
                    series_formatting.y_axis = y_axis;
                    series_formatting.id = number_series + 1;
                    series_formatting.order = number_series + 1;
                }
            }
        }
        number_series++;
        newSeriesData.push(series_formatting);
    }


    //set default color for each series if it is not a upload
    if (initXML == null) {
        colors = rainbow(newSeriesData.length);
        for (var i = 0; i < newSeriesData.length; i++) {
            newSeriesData[i].color = colors[i];
        }
    }

    newSeriesData.sort(SortByOrder);
    for (var i = 0; i < newSeriesData.length; i++) {
        table.jqGrid('addRowData', i + 1, newSeriesData[i]);
    }


    outerLayout.sizePane("south", $('#gbox_listdt').height())
}

function updateSeriesVarValHist(index, selectedVals) {
    $('#listdt').jqGrid('clearGridData');
    var select = $("#series_var_val_y1_" + index);
    select.empty();
    //get value of database
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var selectedSeriesVariable;
        try {
            selectedSeriesVariable = $("#series_var_y1_" + index).multiselect("getChecked").val();
        } catch (err) {
            selectedSeriesVariable = $("#series_var_y1_" + index + ' option:first-child').val();
        }
        var fcst_var = "NA";

        var fcst_vars_stat = "NA";

        var field_type;
        if (currentTab === 'Roc') {
            field_type = "roc";
        } else if (currentTab === 'Rely') {
            field_type = "rely";
        } else if (currentTab === 'Ens_ss') {
            field_type = "ensss";
        } else if (currentTab === 'Perf') {
            field_type = "perf";
        } else if (currentTab === 'Taylor') {
            field_type = "taylor";
        } else if (currentTab === 'Hist') {
            field_type = $("input:radio[name='hist_line_type']:checked").val();
        } else if (currentTab === 'Eclv') {
            field_type = "eclv";
        }

        $.ajax({
            async: false,
            url: "servlet",
            type: "POST",
            processData: false,
            contentType: "application/xml",
            dataType: 'xml',
            data: '<?xml version="1.0" encoding="UTF-8"?><request><db_con>' + selectedDatabase + '</db_con><list_val><' + field_type + '_field>' + selectedSeriesVariable + '</' + field_type + '_field><stat><fcst_var name="' + fcst_var + '"><val>' + fcst_vars_stat + '</val></fcst_var></stat></list_val></request>',
            error: function () {

            },
            success: function (data) {
                seriesY1VarValResponse[index] = data;
                var values = $(data).find("val");
                var opt, selected;
                var options = [];
                if (values.length > 0) {
                    if(selectedVals.length > 0) {
                        $("#series_var_table_y" + index).css("display", '');
                    }
                    for (var i = 0; i < values.length; i++) {
                        var t = $(values[i]);
                        if ($.type(selectedVals) === "string") {
                            selected = t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&") === selectedVals;
                        } else {
                            selected = $.inArray(t.text().replace("&gt;", ">").replace("&lt;", "<").replace("&amp;", "&"), selectedVals) >= 0;
                        }
                        if (i === 0 || (i !== 0 && t.text() !== $(values[i - 1]).text())) {
                            opt = $('<option />', {
                                value: t.text(),
                                text: t.text(),
                                selected: selected
                            });
                            options.push(opt);
                        } else if (i !== 0 && t.text() === $(values[i - 1]).text()) {
                            options[options.length - 1].text(options[options.length - 1].text() + '*');
                        }
                    }
                    var length;
                    var databaseNumbers = $("input[name='multiselect_database']:checked").length - 1;

                    for (var i = 0; i < options.length; i++) {
                        if (options[i].text() !== options[i][0].value) {
                            length = options[i].text().substring(options[i][0].value.length, options[i].text().length).length;
                            if (length === databaseNumbers) {
                                options[i].text(options[i][0].value + "*");
                            } else {
                                options[i].text(options[i][0].value);
                            }
                        }
                        options[i].appendTo(select);
                    }
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                } else {
                    opt = $('<option />', {
                        value: "N/A",
                        text: "N/A"
                    });
                    opt.appendTo(select);
                    try {
                        select.multiselect('refresh');
                    } catch (err) {
                    }
                }
                selectedVals = [];
            }
        });
    }
}

function updateSeriesRely() {
    var rely_event_hist = $('#rely_event_hist').prop("checked");
    var table = $("#listdt");
    table.jqGrid('clearGridData');
    var series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
    series_formatting.title = 'Reliability Curve';
    series_formatting.y_axis = "Y1";
    series_formatting.order = 1;
    series_formatting.color = '#333333';
    series_formatting.id = 1;
    table.jqGrid('addRowData', 1, series_formatting);
    if (rely_event_hist == "true") {
        series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
        series_formatting.title = 'Event Histogram';
        series_formatting.y_axis = "Y1";
        series_formatting.order = 2;
        series_formatting.color = '#AAAAAA';
        series_formatting.id = 2;
        series_formatting.type = "h";
        series_formatting.lwd = 50;
        table.jqGrid('addRowData', 2, series_formatting);
    }
}

function updateSeriesEns() {
    var table = $("#listdt");
    table.saveCell(lastSelRow, lastSelCol);
    var oldSeriesData = table.jqGrid('getRowData');
    table.jqGrid('clearGridData');

    var series_perm;
    var number_series = 0;
    var series_formatting = {};
    var isFixedFormatting = $("#seriesLock").is(':checked');
    var newSeriesData = [];
    var y_axis;
    var plot_ci = [];
    var plot_disp = [];
    var show_signif = [];
    var colors = [];
    var pch = [];
    var lty = [];
    var lwd = [];
    var con_series = [];
    var order_series = [];
    var legend = [];
    var type = [];

    if (initXML != null) {
        plot_ci = initXML.find("plot").find("plot_ci").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        plot_disp = initXML.find("plot").find("plot_disp").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        show_signif = initXML.find("plot").find("show_signif").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < plot_disp.length; i++) {
            if (plot_disp[i].trim() == "TRUE") {
                plot_disp[i] = "No";
            } else {
                plot_disp[i] = "Yes";
            }
            if (show_signif[i].trim() == "TRUE") {
                show_signif[i] = "No";
            } else {
                show_signif[i] = "Yes";
            }
        }

        colors = initXML.find("plot").find("colors").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < colors.length; i++) {
            colors[i] = colors[i].replace(/FF$/, "");
        }
        pch = initXML.find("plot").find("pch").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lty = initXML.find("plot").find("lty").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lwd = initXML.find("plot").find("lwd").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        con_series = initXML.find("plot").find("con_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        order_series = initXML.find("plot").find("order_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        type = initXML.find("plot").find("type").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        legend = initXML.find("plot").find("legend").text().replace("c(", "").replace(/\)$/, "").replace(/"/g, "").split(",");
        if (legend.length != order_series.length) {
            for (var k = 0; k < order_series.length; k++) {
                legend[k] = "";
            }
        }
    }


    series_perm = permuteSeries(createSeriesMapForPermutationEns(series_var_y1_indexes, "y1"), 0);

    var ensss_pts_disp = $("input:radio[name='ensss_pts_disp']:checked").val();

    if (ensss_pts_disp === "true") {
        var new_series_perm = [];
        var j = 0;
        for (var i = 0; i < series_perm.length; i++) {
            new_series_perm[j] = series_perm[i] + " " + "MSE";
            new_series_perm[j + 1] = series_perm[i] + " " + "#PTS";
            j = j + 2;
        }
        series_perm = new_series_perm;
    } else {
        for (var i = 0; i < series_perm.length; i++) {
            series_perm[i] = series_perm[i] + " " + "MSE";
        }
    }


    for (var series_perm_index = 0; series_perm_index < series_perm.length; series_perm_index++) {
        var seriesName = series_perm[series_perm_index];
        //check if this series was their before
        var isSeriesOld = false;
        if (seriesName.indexOf("#PTS") > 0) {
            y_axis = "Y2";
        } else {
            y_axis = "Y1";
        }
        for (var i = 0; i < oldSeriesData.length; i++) {
            if (oldSeriesData[i]['title'] == seriesName) {
                series_formatting = {};
                series_formatting.title = seriesName;
                series_formatting.y_axis = y_axis;
                series_formatting.order = number_series + 1;
                series_formatting.hide = oldSeriesData[i]['hide'];
                series_formatting.plot_ci = oldSeriesData[i]['plot_ci'];
                series_formatting.show_signif = oldSeriesData[i]['show_signif'];
                series_formatting.color = oldSeriesData[i]['color'];
                series_formatting.pch = oldSeriesData[i]['pch'];
                series_formatting.type = oldSeriesData[i]['type'];
                series_formatting.lty = oldSeriesData[i]['lty'];
                series_formatting.lwd = oldSeriesData[i]['lwd'];
                series_formatting.con_series = oldSeriesData[i]['con_series'];
                series_formatting.legend = oldSeriesData[i]['legend'];
                series_formatting.id = number_series + 1;
                isSeriesOld = true;
                break;
            }
        }
        //if it is a new series
        if (!isSeriesOld) {
            //check if it is the first
            if (isFixedFormatting && number_series > 0 && initXML == null) {
                series_formatting = jQuery.extend(true, {}, newSeriesData[newSeriesData.length - 1]);
                series_formatting.title = seriesName;
                series_formatting.y_axis = y_axis;
                series_formatting.id = number_series + 1;
                series_formatting.order = number_series + 1;
            } else {
                if (initXML != null) {
                    series_formatting = {};
                    series_formatting.title = seriesName;
                    series_formatting.y_axis = y_axis;
                    if (!order_series[number_series] || order_series[number_series] == '') {
                        series_formatting.order = parseInt(i + 1);
                    } else {
                        series_formatting.order = parseInt(order_series[number_series]);
                    }
                    series_formatting.hide = plot_disp[number_series];
                    series_formatting.plot_ci = plot_ci[number_series].trim();
                    series_formatting.show_signif = show_signif[number_series];
                    series_formatting.pch = pch[number_series].trim();
                    series_formatting.type = type[number_series].trim();
                    series_formatting.lty = lty[number_series].trim();
                    series_formatting.lwd = lwd[number_series].trim();
                    series_formatting.con_series = con_series[number_series].trim();
                    series_formatting.legend = legend[number_series].trim();
                    series_formatting.color = colors[number_series].trim();
                    series_formatting.id = number_series + 1;

                } else {
                    series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
                    series_formatting.title = seriesName;
                    series_formatting.y_axis = y_axis;
                    series_formatting.id = number_series + 1;
                    series_formatting.order = number_series + 1;
                }
            }
        }
        number_series++;
        newSeriesData.push(series_formatting);
    }


    //set default color for each series if it is not a upload
    if (initXML == null) {
        colors = rainbow(newSeriesData.length);
        for (var i = 0; i < newSeriesData.length; i++) {
            newSeriesData[i].color = colors[i];
        }
    }

    newSeriesData.sort(SortByOrder);
    for (var i = 0; i < newSeriesData.length; i++) {
        table.jqGrid('addRowData', i + 1, newSeriesData[i]);
    }
    outerLayout.sizePane("south", $('#gbox_listdt').height());
}

function updateSeriesPerf() {
    var table = $("#listdt");
    table.saveCell(lastSelRow, lastSelCol);
    var oldSeriesData = table.jqGrid('getRowData');
    table.jqGrid('clearGridData');

    var series_perm;
    var number_series = 0;
    var series_formatting = {};
    var isFixedFormatting = $("#seriesLock").is(':checked');
    var newSeriesData = [];
    var y_axis;
    var plot_ci = [];
    var plot_disp = [];
    var show_signif = [];
    var colors = [];
    var pch = [];
    var lty = [];
    var lwd = [];
    var con_series = [];
    var order_series = [];
    var legend = [];
    var type = [];

    if (initXML != null) {
        plot_ci = initXML.find("plot").find("plot_ci").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        plot_disp = initXML.find("plot").find("plot_disp").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        show_signif = initXML.find("plot").find("show_signif").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < plot_disp.length; i++) {
            if (plot_disp[i].trim() == "TRUE") {
                plot_disp[i] = "No";
            } else {
                plot_disp[i] = "Yes";
            }
            if (show_signif[i].trim() == "TRUE") {
                show_signif[i] = "No";
            } else {
                show_signif[i] = "Yes";
            }
        }

        colors = initXML.find("plot").find("colors").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < colors.length; i++) {
            colors[i] = colors[i].replace(/FF$/, "");
        }
        pch = initXML.find("plot").find("pch").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lty = initXML.find("plot").find("lty").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lwd = initXML.find("plot").find("lwd").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        con_series = initXML.find("plot").find("con_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        order_series = initXML.find("plot").find("order_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        type = initXML.find("plot").find("type").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        legend = initXML.find("plot").find("legend").text().replace("c(", "").replace(/\)$/, "").replace(/"/g, "").split(",");
        if (legend.length != order_series.length) {
            for (var k = 0; k < order_series.length; k++) {
                legend[k] = "";
            }
        }
    }


    series_perm = permuteSeries(createSeriesMapForPermutationEns(series_var_y1_indexes, "y1"), 0);


    for (var series_perm_index = 0; series_perm_index < series_perm.length; series_perm_index++) {
        var seriesName = series_perm[series_perm_index];
        //check if this series was their before
        var isSeriesOld = false;
        for (var i = 0; i < oldSeriesData.length; i++) {
            if (oldSeriesData[i]['title'] == seriesName) {
                series_formatting = {};
                series_formatting.title = seriesName;
                series_formatting.y_axis = "";
                series_formatting.order = number_series + 1;
                series_formatting.hide = oldSeriesData[i]['hide'];
                series_formatting.plot_ci = oldSeriesData[i]['plot_ci'];
                series_formatting.show_signif = oldSeriesData[i]['show_signif'];
                series_formatting.color = oldSeriesData[i]['color'];
                series_formatting.pch = oldSeriesData[i]['pch'];
                series_formatting.type = oldSeriesData[i]['type'];
                series_formatting.lty = oldSeriesData[i]['lty'];
                series_formatting.lwd = oldSeriesData[i]['lwd'];
                series_formatting.con_series = oldSeriesData[i]['con_series'];
                series_formatting.legend = oldSeriesData[i]['legend'];
                series_formatting.id = number_series + 1;
                isSeriesOld = true;
                break;
            }
        }
        //if it is a new series
        if (!isSeriesOld) {
            //check if it is the first
            if (isFixedFormatting && number_series > 0 && initXML == null) {
                series_formatting = jQuery.extend(true, {}, newSeriesData[newSeriesData.length - 1]);
                series_formatting.title = seriesName;
                series_formatting.y_axis = y_axis;
                series_formatting.id = number_series + 1;
                series_formatting.order = number_series + 1;
            } else {
                if (initXML != null) {
                    series_formatting = {};
                    series_formatting.title = seriesName;
                    series_formatting.y_axis = y_axis;
                    if (!order_series[number_series] || order_series[number_series] == '') {
                        series_formatting.order = parseInt(i + 1);
                    } else {
                        series_formatting.order = parseInt(order_series[number_series]);
                    }
                    series_formatting.hide = plot_disp[number_series];
                    series_formatting.plot_ci = plot_ci[number_series].trim();
                    series_formatting.show_signif = show_signif[number_series];
                    series_formatting.pch = pch[number_series].trim();
                    series_formatting.type = type[number_series].trim();
                    series_formatting.lty = lty[number_series].trim();
                    series_formatting.lwd = lwd[number_series].trim();
                    series_formatting.con_series = con_series[number_series].trim();
                    series_formatting.legend = legend[number_series].trim();
                    series_formatting.color = colors[number_series].trim();
                    series_formatting.id = number_series + 1;

                } else {
                    series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
                    series_formatting.title = seriesName;
                    series_formatting.y_axis = y_axis;
                    series_formatting.id = number_series + 1;
                    series_formatting.order = number_series + 1;
                }
            }
        }
        number_series++;
        newSeriesData.push(series_formatting);
    }


    //set default color for each series if it is not a upload
    if (initXML == null) {
        colors = rainbow(newSeriesData.length);
        for (var i = 0; i < newSeriesData.length; i++) {
            newSeriesData[i].color = colors[i];
        }
    }

    newSeriesData.sort(SortByOrder);
    for (var i = 0; i < newSeriesData.length; i++) {
        table.jqGrid('addRowData', i + 1, newSeriesData[i]);
    }
    outerLayout.sizePane("south", $('#gbox_listdt').height());
}

function updateSeries(isCheckAll) {
    var table = $("#listdt");
    table.saveCell(lastSelRow, lastSelCol);
    var oldSeriesData = table.jqGrid('getRowData');
    table.jqGrid('clearGridData');
    group_name_to_value_map = {};

    var series_perm;
    var number_series = 0;
    var series_formatting = {};
    var isFixedFormatting = $("#seriesLock").is(':checked');
    var newSeriesData = [];
    var selected_mode = $("#plot_data").multiselect("getChecked").val();
    var y_axis;
    var fcst_var_indexes;
    var plot_ci = [];
    var plot_disp = [];
    var show_signif = [];
    var colors = [];
    var pch = [];
    var lty = [];
    var lwd = [];
    var con_series = [];
    var order_series = [];
    var legend = [];
    var type = [];

    if (initXML != null) {
        plot_ci = initXML.find("plot").find("plot_ci").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        plot_disp = initXML.find("plot").find("plot_disp").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        show_signif = initXML.find("plot").find("show_signif").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < plot_disp.length; i++) {
            if (plot_disp[i].trim() == "TRUE") {
                plot_disp[i] = "No";
            } else {
                plot_disp[i] = "Yes";
            }
            if (show_signif[i].trim() == "TRUE") {
                show_signif[i] = "Yes";
            } else {
                show_signif[i] = "No";
            }
        }

        colors = initXML.find("plot").find("colors").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        for (var i = 0; i < colors.length; i++) {
            colors[i] = colors[i].replace(/FF$/, "");
        }
        pch = initXML.find("plot").find("pch").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lty = initXML.find("plot").find("lty").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        lwd = initXML.find("plot").find("lwd").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        con_series = initXML.find("plot").find("con_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        var order_series_el = initXML.find("plot").find("order_series").text();
        if (order_series_el && order_series_el.length > 0) {
            order_series = initXML.find("plot").find("order_series").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        } else {
            order_series = [];
            for (var i = 0; i < colors.length; i++) {
                order_series.push(i + 1);
            }
        }


        type = initXML.find("plot").find("type").text().replace("c(", "").replace(")", "").replace(/"/g, "").split(",");
        legend = initXML.find("plot").find("legend").text().replace("c(", "").replace(/\)$/, "").replace(/"/g, "").split(",");
        if (legend.length != order_series.length) {
            for (var k = 0; k < order_series.length; k++) {
                legend[k] = "";
            }
        }
    }
    for (var axis_index = 1; axis_index <= 2; axis_index++) {
        y_axis = "y" + axis_index;
        if (axis_index == 1) {
            fcst_var_indexes = fcst_var_y1_indexes;
            series_perm = permuteSeries(createSeriesMapForPermutation(series_var_y1_indexes, y_axis), 0);
        } else {
            fcst_var_indexes = fcst_var_y2_indexes;
            series_perm = permuteSeries(createSeriesMapForPermutation(series_var_y2_indexes, y_axis), 0);

        }
        for (var fcst_var_index = 0; fcst_var_index < fcst_var_indexes.length; fcst_var_index++) {
            var fcst_var = $("#fcst_var_" + y_axis + "_" + fcst_var_indexes[fcst_var_index]).val();
            var list_stats = [];
            var listSelectedBoxes;
            listSelectedBoxes = $("#fcst_stat_" + y_axis + "_" + fcst_var_indexes[fcst_var_index]).multiselect("getChecked");
            var derivedBoxes = [];
            if (currentTab == 'Contour') {
                for (var i = 0; i < fixed_var_indexes.length; i++) {
                    var valArr = $("#fixed_var_val_" + fixed_var_indexes[i]).val();
                    if (valArr) {
                        for (var j = 0; j < valArr.length; j++) {
                            derivedBoxes.push({'value': valArr[j]});
                        }
                    }
                }

                series_perm = [];
                series_perm[0] = '';
            }
            if (!derivedBoxes || derivedBoxes.length == 0) {
                derivedBoxes = [];
                derivedBoxes[0] = {'value': ''};
            }
            if (listSelectedBoxes.length == 0 && (selected_mode == "mode" || selected_mode == "mtd")) {
                listSelectedBoxes = $("#fcst_stat_mode_" + y_axis + "_" + fcst_var_indexes[fcst_var_index]).multiselect("getChecked");
            }

            for (var i = 0; i < listSelectedBoxes.length; i++) {
                list_stats.push(listSelectedBoxes[i].value);
            }

            for (var list_stats_index = 0; list_stats_index < list_stats.length; list_stats_index++) {

                for (var series_perm_index = 0; series_perm_index < series_perm.length; series_perm_index++) {
                    var stat_name = list_stats[list_stats_index];
                    if ((selected_mode == "mode" && listStatModeRatio.indexOf(stat_name) == -1)
                        || selected_mode == "mtd" && listStatMtdRatio.indexOf(stat_name) == -1) {
                        stat_name = createStatNameForModeArrt(stat_name, y_axis, fcst_var_indexes[fcst_var_index]);
                    }
                    var seriesName = series_perm[series_perm_index] + " " + fcst_var + " " + stat_name;
                    for (var a = 0; a < derivedBoxes.length; a++) {
                        var seriesNameWithDerived = seriesName;
                        if (seriesNameWithDerived.indexOf('<') > -1) {
                            seriesNameWithDerived = seriesNameWithDerived.replace(/</g, '&lt;');
                        }
                        if (derivedBoxes[a].value.length > 0) {
                            seriesNameWithDerived = seriesNameWithDerived + ' ' + derivedBoxes[a].value;
                        }
                        //check if this series was present before
                        var isSeriesOld = false;
                        for (var i = 0; i < oldSeriesData.length; i++) {
                            if (oldSeriesData[i]['title'] == seriesNameWithDerived && oldSeriesData[i]['y_axis'].match(axis_index + "$") == axis_index) {
                                series_formatting = {};
                                series_formatting.title = seriesNameWithDerived;
                                series_formatting.y_axis = "Y" + axis_index;
                                series_formatting.order = number_series + 1;
                                series_formatting.hide = oldSeriesData[i]['hide'];
                                series_formatting.plot_ci = oldSeriesData[i]['plot_ci'];
                                series_formatting.show_signif = oldSeriesData[i]['show_signif'];
                                series_formatting.color = oldSeriesData[i]['color'];
                                series_formatting.pch = oldSeriesData[i]['pch'];
                                series_formatting.type = oldSeriesData[i]['type'];
                                series_formatting.lty = oldSeriesData[i]['lty'];
                                series_formatting.lwd = oldSeriesData[i]['lwd'];
                                series_formatting.con_series = oldSeriesData[i]['con_series'];
                                series_formatting.legend = oldSeriesData[i]['legend'];
                                series_formatting.id = number_series + 1;
                                isSeriesOld = true;
                                break;
                            }
                        }
                        //if it is a new series
                        if (!isSeriesOld) {
                            //check if it is the first
                            if (isFixedFormatting && number_series > 0 && initXML == null) {
                                series_formatting = jQuery.extend(true, {}, newSeriesData[newSeriesData.length - 1]);
                                series_formatting.title = seriesNameWithDerived;
                                series_formatting.y_axis = "Y" + axis_index;
                                series_formatting.id = number_series + 1;
                                series_formatting.order = number_series + 1;
                            } else {
                                if (initXML != null) {
                                    series_formatting = {};
                                    series_formatting.title = seriesNameWithDerived;
                                    series_formatting.y_axis = "Y" + axis_index;
                                    series_formatting.order = parseInt(order_series[number_series]);
                                    series_formatting.hide = plot_disp[number_series];
                                    series_formatting.plot_ci = plot_ci[number_series].trim();
                                    series_formatting.show_signif = show_signif[number_series];
                                    series_formatting.pch = pch[number_series].trim();
                                    series_formatting.type = type[number_series].trim();
                                    series_formatting.lty = lty[number_series].trim();
                                    series_formatting.lwd = lwd[number_series].trim();
                                    series_formatting.con_series = con_series[number_series].trim();
                                    series_formatting.legend = legend[number_series].trim();
                                    series_formatting.color = colors[number_series].trim();
                                    series_formatting.id = number_series + 1;

                                } else {
                                    if (isFixedFormatting && oldSeriesData.length > 0) {
                                        series_formatting = jQuery.extend(true, {}, oldSeriesData[oldSeriesData.length - 1]);
                                    } else {
                                        series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
                                    }
                                    series_formatting.title = seriesNameWithDerived;
                                    series_formatting.y_axis = "Y" + axis_index;
                                    series_formatting.id = number_series + 1;
                                    series_formatting.order = number_series + 1;
                                }
                            }
                        }
                        if (currentTab !== 'Contour') {
                            number_series++;
                        }
                        newSeriesData.push(series_formatting);
                    }
                }
            }
        }
    }

    var seriesDiff = [];
    var diffSeries1, diffSeries2, isDiffSeries1, isDiffSeries2, strSeriesName, oper, operSign;
    for (var i = 0; i < seriesDiffY1.length; i++) {
        diffSeries1 = seriesDiffY1[i].split(",")[0];
        diffSeries2 = seriesDiffY1[i].split(",")[1];
        oper = seriesDiffY1[i].split(",")[2];
        isDiffSeries1 = false;
        isDiffSeries2 = false;
        operSign = '"and"';
        if (oper === "DIFF") {
            operSign = '"-"';
        } else if (oper === "RATIO") {
            operSign = '"/"';
        }
        for (var j = 0; j < newSeriesData.length; j++) {
            if (diffSeries1 == newSeriesData[j].title) {
                isDiffSeries1 = true;
            }
            if (diffSeries2 == newSeriesData[j].title) {
                isDiffSeries2 = true;
            }
        }
        if (isDiffSeries1 && isDiffSeries2) {
            seriesDiff.push(seriesDiffY1[i]);
            strSeriesName = oper + ' ("' + diffSeries1 + operSign + diffSeries2 + '")';
            if (isFixedFormatting && initXML == null) {
                series_formatting = jQuery.extend(true, {}, newSeriesData[newSeriesData.length - 1]);
                series_formatting.title = strSeriesName;
                series_formatting.y_axis = "Y1";
                series_formatting.id = number_series + 1;
                series_formatting.order = number_series + 1;
            } else {
                if (initXML != null) {
                    series_formatting = {};
                    series_formatting.title = strSeriesName;
                    series_formatting.y_axis = "Y1";
                    series_formatting.order = parseInt(order_series[number_series]);
                    series_formatting.hide = plot_disp[number_series];
                    series_formatting.plot_ci = plot_ci[number_series].trim();
                    series_formatting.show_signif = show_signif[number_series].trim();
                    series_formatting.pch = pch[number_series].trim();
                    series_formatting.type = type[number_series].trim();
                    series_formatting.lty = lty[number_series].trim();
                    series_formatting.lwd = lwd[number_series].trim();
                    series_formatting.con_series = con_series[number_series].trim();
                    series_formatting.legend = legend[number_series].trim();
                    series_formatting.color = colors[number_series].trim();
                    series_formatting.id = number_series + 1;

                } else {
                    series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
                    series_formatting.title = strSeriesName;
                    series_formatting.y_axis = "Y1";
                    series_formatting.id = number_series + 1;
                    series_formatting.order = number_series + 1;
                }
            }
            number_series++;
            newSeriesData.push(series_formatting);
        }
    }
    seriesDiffY1 = seriesDiff;
    seriesDiff = [];
    for (var i = 0; i < seriesDiffY2.length; i++) {
        diffSeries1 = seriesDiffY2[i].split(",")[0];
        diffSeries2 = seriesDiffY2[i].split(",")[1];
        oper = seriesDiffY1[i].split(",")[2];
        isDiffSeries1 = false;
        isDiffSeries2 = false;
        if (oper === "DIFF") {
            operSign = '"-"';
        } else if (oper === "RATIO") {
            operSign = '"/"';
        }
        for (var j = 0; j < newSeriesData.length; j++) {
            if (diffSeries1 == newSeriesData[j].title) {
                isDiffSeries1 = true;
            }
            if (diffSeries2 == newSeriesData[j].title) {
                isDiffSeries2 = true;
            }
        }
        if (isDiffSeries1 && isDiffSeries2) {
            seriesDiff.push(seriesDiffY2[i]);
            strSeriesName = oper + ' ("' + diffSeries1 + operSign + diffSeries2 + '")';

            if (isFixedFormatting && initXML == null) {
                series_formatting = jQuery.extend(true, {}, newSeriesData[newSeriesData.length - 1]);
                series_formatting.title = strSeriesName;
                series_formatting.y_axis = "Y2";
                series_formatting.id = number_series + 1;
                series_formatting.order = number_series + 1;
            } else {
                if (initXML != null) {
                    series_formatting = {};
                    series_formatting.title = strSeriesName;
                    series_formatting.y_axis = "Y2";
                    series_formatting.order = parseInt(order_series[number_series]);
                    series_formatting.hide = plot_disp[number_series];
                    series_formatting.plot_ci = plot_ci[number_series].trim();
                    series_formatting.show_signif = show_signif[number_series];
                    series_formatting.pch = pch[number_series].trim();
                    series_formatting.type = type[number_series].trim();
                    series_formatting.lty = lty[number_series].trim();
                    series_formatting.lwd = lwd[number_series].trim();
                    series_formatting.con_series = con_series[number_series].trim();
                    series_formatting.legend = legend[number_series].trim();
                    series_formatting.color = colors[number_series].trim();
                    series_formatting.id = number_series + 1;

                } else {
                    series_formatting = jQuery.extend(true, {}, firstSeriesFormatting);
                    series_formatting.title = strSeriesName;
                    series_formatting.y_axis = "Y2";
                    series_formatting.id = number_series + 1;
                    series_formatting.order = number_series + 1;
                }
            }
            number_series++;
            newSeriesData.push(series_formatting);
        }
    }
    seriesDiffY2 = seriesDiff;


    //set default color for each series if it is not a upload
    if (initXML == null) {
        if (currentTab === 'Contour') {
            for (var i = 0; i < newSeriesData.length; i++) {
                colors.push("#000000");
            }
        } else {
            colors = rainbow(newSeriesData.length);
        }

        var colors_new = [];
        if (isCheckAll) {
            colors_new = colors;
        } else {
            for (var i = 0; i < colors.length; i++) {
                for (var j = 0; j < newSeriesData.length; j++) {
                    if (newSeriesData[j].color && newSeriesData[j].color.length > 0
                        && newSeriesData[j].color.substr(newSeriesData[j].color.length - 6).toUpperCase() === colors[i].substr(colors[i].length - 6).toUpperCase()
                        && i != j) {
                        colors_new[j] = colors[i];
                        colors_new[i] = colors[j];
                    }
                }
            }
            for (var i = 0; i < colors.length; i++) {
                if (!colors_new[i]) {
                    colors_new[i] = colors[i];
                }
            }
        }
        for (var i = 0; i < newSeriesData.length; i++) {
            if (!newSeriesData[i].color || newSeriesData[i].color.length == 0) {
                newSeriesData[i].color = colors_new[i];
            }
        }
    }


    if (currentTab === 'Contour') {
        newSeriesData.reverse();
    } else {
        newSeriesData.sort(SortByOrder);
    }

    for (var i = 0; i < newSeriesData.length; i++) {
        table.jqGrid('addRowData', i + 1, newSeriesData[i]);
        if (currentTab === 'Contour' && i !== 0) {
            $("#" + (i + 1), "#gbox_listdt").css({display: "none"});
        }

    }
    outerLayout.sizePane("south", $('#gbox_listdt').height());
}


/**
 * @return {number}
 */
function SortByOrder(a, b) {
    var aOrder = a.order;
    var bOrder = b.order;
    return (aOrder - bOrder);
}

/**
 * Construct a list of RGBA color hex represenations with the specified length
 * and format #RRGGBBAA, where the colors are spaced equally along the rainbow
 * spectrum.
 */
function rainbow(num) {
    if (1 > num) {
        return [];
    }
    if (1 == num) {
        return ["#FF0000"];
    }

    var listRet = [];
    var dblInc = 1.0 / (num - 1);
    var dblVal = 0;
    for (var i = 0; i < num; i++, dblVal += dblInc) {
        listRet.push("#" + interpolateColor(dblVal));
    }
    return listRet;
}

/**
 * Create a hex representation of the specified "rainbow" color along the
 * spectrum from 0 (red, FF0000) to 1 (violet, FF00FF).
 */
function interpolateColor(rel) {
    if (rel < 0.0) {
        return "FF0000";
    } else if (rel > 1.0) {
        return "FF00FF";
    }

    var min = 0;
    var max = 1;

    switch (Math.floor(rel / .2)) {
        case 0:
            return hex(max) + hex(max * (min + (1 - min) * (rel / .2))) + hex(min);
        case 1:
            rel -= .2;
            return hex(min + max * (1 - min) * (1 - rel / .2)) + hex(max) + hex(min);
        case 2:
            rel -= .4;
            return hex(min) + hex(max) + hex(max * (min + (1 - min) * (rel / .2)));
        case 3:
            rel -= .6;
            return hex(min) + hex(max * (1 - min) * (1 - rel / .2)) + hex(max);
        case 4:
            rel -= .8;
            return hex(max * (min + (1 - min) * (rel / .2)) * .5) + hex(min) + hex(max);
        default:
            return hex(max * .5) + hex(min) + hex(max);
    }
}

/**
 * Create the two character hexadecimal representation of specified value,
 * multiplied by 255. The intended use is to create an RGB representation with
 * 8-bit color depth.
 */
function hex(val) {
    var strRet = Math.round(val * 255).toString(16).toUpperCase();
    while (2 > strRet.length) {
        strRet = "0" + strRet;
    }
    return strRet;
}

function permuteSeries(map, intIndex) {

    var keys = Object.keys(map);
    if (1 > keys.length) {
        return [];
    }
    var strVar = keys[intIndex];
    var listVal = map[strVar];

    //  if the index has reached the end of the list, return the selected values
    //  from the last control
    if (keys.length == intIndex + 1) {

        return listVal;
    }

    //  otherwise, get the list for the next fcst_var and build upon it
    var listValNext = permuteSeries(map, intIndex + 1);
    if (1 > listVal.length) {
        return listValNext;
    }

    var listRet = [];
    for (var j = 0; j < listValNext.length; j++) {
        for (var i = 0; i < listVal.length; i++) {

            listRet.push(listVal[i] + " " + listValNext[j]);
        }
    }
    return listRet;
}


function createNewDerivedSeriesName(yAxis) {
    var val1 = $('#series1Y' + yAxis).val();
    var val2 = $('#series2Y' + yAxis).val();
    var oper = jQuery('input[name=derive_oper]:checked').val();
    var operSign = '"and"';
    if (oper === "DIFF") {
        operSign = '"-"';
    } else if (oper === "RATIO") {
        operSign = '"/"';
    }
    if (val1 && val2) {
        $('#newDiffSeriesName').text(oper + ' ( "' + val1 + operSign + val2 + '" )');
    } else {
        $('#newDiffSeriesName').text("N/A");
    }
}

function changeYAxis(yAxis) {
    if (yAxis == 2) {
        $('#series1Y2').removeAttr('disabled');
        $('#series2Y2').removeAttr('disabled');
        $('#series1Y1').attr("disabled", "disabled");
        $('#series2Y1').attr("disabled", "disabled");
        createNewDerivedSeriesName(2);
    } else {
        $('#series1Y2').attr("disabled", "disabled");
        $('#series2Y2').attr("disabled", "disabled");
        $('#series1Y1').removeAttr('disabled');
        $('#series2Y1').removeAttr('disabled');
        createNewDerivedSeriesName(1);
    }
}

function sendXml() {
    var xml;
    var template;
    var selectedDatabase = getSelectedDatabases();
    if (selectedDatabase) {
        var result = $('<request />');
        result.append($('<db_con />').text(selectedDatabase));
        var plot = $('<plot />');
        if (currentTab === 'Series' || currentTab === 'Contour') {
            if (currentTab === 'Series') {
                var statistic = $("input:radio[name ='statistics']:checked").val();
                if (statistic === 'revision_statistics') {
                    template = $('<template>revision_series_plot.R_tmpl</template>');
                } else {
                    template = $('<template>series_plot.R_tmpl</template>');
                }

            } else {
                template = $('<template>contour_plot.R_tmpl</template>');
            }
            plot.append(template);
            plot = createXMLSeries(plot);
            plot = createXMLCommon(plot);
            if (currentTab === 'Contour') {
                plot.append($('<contour_intervals />').text($('#contour_intervals').val()));
                plot.append($('<color_palette />').text($('#color_palette').val()));
                plot.append($('<add_color_bar />').text($('#add_color_bar').is(':checked')));
                plot.append($('<reverse_y />').text($('#reverse_y').is(':checked')));
                plot.append($('<reverse_x />').text($('#reverse_x').is(':checked')));
                plot.append($('<add_contour_overlay />').text($('#add_contour_overlay').is(':checked')));

            }
        } else if (currentTab === 'Box') {
            var statistic = $("input:radio[name ='statistics']:checked").val();
            if (statistic === 'revision_statistics') {
                template = $('<template>revision_box_plot.R_tmpl</template>');
            } else {
                template = $('<template>box_plot.R_tmpl</template>');
            }
            plot.append(template);
            plot = createXMLBox(plot);
        } else if (currentTab === 'Bar') {
            template = $('<template>bar_plot.R_tmpl</template>');
            plot.append(template);
            plot = createXMLBox(plot);
        } else if (currentTab === 'Hist') {
            var field_type = $("input:radio[name='hist_line_type']:checked").val();
            if (field_type === 'rhist') {
                template = $('<template>rhist.R_tmpl</template>');
            } else if (field_type === 'phist') {
                template = $('<template>phist.R_tmpl</template>');
            } else if (field_type === 'relp') {
                template = $('<template>relp.R_tmpl</template>');
            }
            plot.append(template);
            plot = createXMLHist(plot);
        } else if (currentTab === 'Roc') {
            template = $('<template>roc.R_tmpl</template>');
            plot.append(template);
            plot = createXMLRoc(plot);
        } else if (currentTab === 'Rely') {
            template = $('<template>rely.R_tmpl</template>');
            plot.append(template);
            plot = createXMLRely(plot);
        } else if (currentTab === 'Ens_ss') {
            template = $('<template>ens_ss.R_tmpl</template>');
            plot.append(template);
            plot = createXMLEns(plot);
        } else if (currentTab === 'Perf') {
            template = $('<template>performance.R_tmpl</template>');
            plot.append(template);
            plot = createXMLPerf(plot);
            plot = createXMLCommon(plot);
        } else if (currentTab === 'Taylor') {
            template = $('<template>taylor_plot.R_tmpl</template>');
            plot.append(template);
            plot = createXMLTaylor(plot);
            plot = createXMLCommon(plot);
        } else if (currentTab === 'Eclv') {
            template = $('<template>eclv.R_tmpl</template>');
            plot.append(template);
            plot = createXMLEclv(plot);
        }
        result.append(plot);
        xml = $('<root />').append(result).html().replace(/label=\"</g, 'label="&lt;').replace(/label=\">/g, 'label="&gt;');

        $.ajax({
            url: 'servlet',
            processData: false,
            contentType: "application/xml",
            type: "POST",  // type should be POST
            data: xml, // send the string directly
            dataType: 'xml',
            success: function (response) {
                try {
                    var xml = $(response);
                    var plot = xml.find("plot");
                    var error = xml.find("error");
                    if (error.length === 0) {
                        updateResult(plot.text());
                        var r_error = xml.find("r_error");
                        if (r_error && r_error.length > 0) {
                            updateResult(plot.text());
                            $("#r_error_message_text").empty().text(r_error.text());
                            $("#r_error_message").dialog("open");
                        }
                    } else {
                        updateResult(plot.text());
                        $("#error_message_text").empty().text(xml.find("error").text());
                        $("#error_message").dialog("open");
                    }
                } catch (err) {
                    $("#error_message_text").empty().text(response);
                    $("#error_message").dialog("open");
                }
            },
            error: function (response) {
                alert("error creating a plot or Proxy timeout: " + response);
            }
        });
    }
}

function createXMLEns(plot) {

    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));
    plot = createXMLPlotFix(plot);
    plot.append($('<ensss_pts />').text($("#ensss_pts").val()));
    plot.append($('<ensss_pts_disp />').text($("input:radio[name='ensss_pts_disp']:checked").val()));
    plot = createXMLCommon(plot);
    return plot;
}

function createXMLRoc(plot) {
    try {
        $("#listdt").saveCell(lastSelRow, lastSelCol);
    } catch (err) {
        console.log("Can't save row " + lastSelRow);
    }
    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));
    plot = createXMLPlotFix(plot);
    var roc_calc = $('<roc_calc />');
    var roc_type = $("input:radio[name='roc_type']:checked").val();
    if (roc_type == "pct") {
        roc_calc.append($('<roc_pct />').text("true"));
        roc_calc.append($('<roc_ctc />').text("false"));
    } else {
        roc_calc.append($('<roc_pct />').text("false"));
        roc_calc.append($('<roc_ctc />').text("true"));
    }
    plot.append(roc_calc);
    var selected_stats;
    var summary_curve = $('<summary_curve />');
    try {
        selected_stats = $("#summary_curve").multiselect("getChecked");
    } catch (err) {
        selected_stats = [];
    }
    for (var i = 0; i < selected_stats.length; i++) {
        if (selected_stats[i].value != 'none') {
            summary_curve.append($('<val />').text(selected_stats[i].value));
        }
    }
    var add_point_thresholds = $('<add_point_thresholds />');
    add_point_thresholds.text($('#add_point_thresholds').prop("checked"));

    var reverse_connection_order = $('<reverse_connection_order />');
    reverse_connection_order.text($('#reverse_connection_order').prop("checked"));

    plot.append(summary_curve);
    plot.append(add_point_thresholds);
    plot.append(reverse_connection_order);
    plot = createXMLCommon(plot);
    return plot;
}

function createXMLEclv(plot) {
    try {
        $("#listdt").saveCell(lastSelRow, lastSelCol);
    } catch (err) {
        console.log("Can't save row " + lastSelRow);
    }
    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));
    plot = createXMLPlotFix(plot);
    var statistic = $("input:radio[name ='statistics']:checked").val();

    var calc_stat_val = $('#calc_stat').val();
    var agg_stat_val = $('#agg_stat').val();
    if (statistic === 'aggregation_statistics' && agg_stat_val !== "none") {
        var agg_stat = $('<agg_stat />');
        agg_stat.append($('<agg_' + agg_stat_val + ' />').text("true"));
        agg_stat.append($('<boot_repl />').text($('#boot_repl').val()));
        agg_stat.append($('<boot_random_seed />').text($('#boot_random_seed').val()));
        agg_stat.append($('<boot_ci />').text($('#boot_ci').val()));
        agg_stat.append($('<eveq_dis />').text($('#eveq_dis').is(':checked')));
        agg_stat.append($('<cl_step />').text($('#cl_step').val()));
        plot.append(agg_stat);
    } else if (statistic === 'calculations_statistics' && calc_stat_val !== "none") {
        var calc_stat = $('<calc_stat />');
        calc_stat.append($('<calc_' + calc_stat_val + ' />').text("true"));
        plot.append(calc_stat);
    }
    plot.append($('<plot_stat />').text($('#plot_stat').val()));
    plot = createXMLCommon(plot);

    return plot;
}

function createXMLHist(plot) {
    try {
        $("#listdt").saveCell(lastSelRow, lastSelCol);
    } catch (err) {
        console.log("Can't save row " + lastSelRow);
    }
    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));
    plot = createXMLPlotFix(plot);
    plot.append($('<normalized_histogram />').text($("input:radio[name='normalized_histogram']:checked").val()));
    plot = createXMLCommon(plot);
    return plot;
}

function createXMLRely(plot) {
    try {
        $("#listdt").saveCell(lastSelRow, lastSelCol);
    } catch (err) {
        console.log("Can't save row " + lastSelRow);
    }
    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));
    plot = createXMLPlotFix(plot);
    var rely_event_hist = $('<rely_event_hist />');
    rely_event_hist.text($('#rely_event_hist').prop("checked"));
    plot.append(rely_event_hist);
    var selected_stats;
    var summary_curve = $('<summary_curve />');
    try {
        selected_stats = $("#summary_curve").multiselect("getChecked");
    } catch (err) {
        selected_stats = [];
    }
    for (var i = 0; i < selected_stats.length; i++) {
        if (selected_stats[i].value != 'none') {
            summary_curve.append($('<val />').text(selected_stats[i].value));
        }
    }
    plot.append(summary_curve);
    var add_skill_line = $('<add_skill_line />');
    add_skill_line.text($('#add_skill_line').prop("checked"));
    plot.append(add_skill_line);
    var add_noskill_line = $('<add_noskill_line />');
    add_noskill_line.text($('#add_noskill_line').prop("checked"));
    plot.append(add_noskill_line);
    var add_reference_line = $('<add_reference_line />');
    add_reference_line.text($('#add_reference_line').prop("checked"));
    plot.append(add_reference_line);
    var inset_hist = $('<inset_hist />');
    inset_hist.text($('#inset_hist').prop("checked"));
    plot.append(inset_hist);
    var agg_stat = $('<agg_stat />');
    agg_stat.append($('<agg_pct />').text("true"));
    agg_stat.append($('<boot_repl />').text($('#boot_repl').val()));
    agg_stat.append($('<boot_random_seed />').text($('#boot_random_seed').val()));
    agg_stat.append($('<boot_ci />').text($('#boot_ci').val()));
    agg_stat.append($('<eveq_dis />').text($('#eveq_dis').is(':checked')));
    agg_stat.append($('<cl_step />').text($('#cl_step').val()));
    plot.append(agg_stat);
    plot = createXMLCommon(plot);
    return plot;
}

function createXMLBox(plot) {
    plot = createXMLSeries(plot);
    plot = createXMLCommon(plot);
    plot.append($('<box_pts />').text($('#box_pts').is(':checked')));
    plot.append($('<box_outline />').text($('#box_outline').is(':checked')));
    plot.append($('<box_notch />').text($('#box_notch').is(':checked')));
    plot.append($('<box_avg />').text($('#box_avg').is(':checked')));
    plot.append($('<box_boxwex />').text($('#box_boxwex').val()));
    return plot;
}

function createXMLPlotFix(plot) {
    var plot_fix = $('<plot_fix />');
    if ($('#fixed_var_table').css("display") !== 'none') {
        for (var i = 0; i < fixed_var_indexes.length; i++) {
            var field = $('<field />').attr("name", $("#fixed_var_" + fixed_var_indexes[i]).val()).attr("equalize", $("#fix_var_event_equal_" + fixed_var_indexes[i]).is(':checked'));
            var set = $('<set />').attr("name", $("#fixed_var_" + fixed_var_indexes[i]).val() + "_" + i);
            var valArr = $("#fixed_var_val_" + fixed_var_indexes[i]).val();
            if (valArr) {
                for (var j = 0; j < valArr.length; j++) {
                    set.append($('<val />').text(valArr[j]));
                }
                field.append(set);
                plot_fix.append(field);
            }
        }
    }
    plot.append(plot_fix);
    return plot;
}

function createXMLPerf(plot) {

    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));

    plot = createXMLPlotFix(plot);
    plot.append($('<plot_cond />').text($('#txtPlotCond').val()));
    plot.append($('<annotation_template />').text($('#annotation').val()));
    var indep = $('<indep />').attr("name", $('#indy_var').val());
    var indy_var_val = $('[name="multiselect_indy_var_val"]');
    if ($("#indy_var_val").multiselect("getChecked").length > 0) {
        for (var i = 0; i < indy_var_val.length; i++) {
            var jqObject = $(indy_var_val[i]);
            if (jqObject.prop('checked')) {
                var id = jqObject.attr("id");
                indep.append($('<val />').attr("label", $('#' + id + '_label').val()).attr("plot_val", $('#' + id + '_plot_val').val()).text(jqObject.val()));
            }
        }
    } else {
        var start = moment.tz($("#date_period_start").val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');//2007-08-15 12:00:00
        var end = moment.tz($("#date_period_end").val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
        var by = $("#date_period_by").val().trim();
        var unit = $("#date_period_by_unit").val();
        var dates = $(previousIndVarValResponse).find("val");
        if (by.length === 0) {
            for (var i = 0; i < dates.length; i++) {
                var t = moment.tz($(dates[i]).text(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                if (t.isSame(start) || t.isSame(end) || t.isBetween(start, end)) {
                    indep.append($('<val />').attr("label", $(dates[i]).text()).attr("plot_val", "").text($(dates[i]).text()));
                }
            }
        } else {
            by = parseInt(by);
            if (unit === "days") {
                by = by * 24;
            }
            var current_date = start.clone();
            while (current_date <= end) {
                var current_date_str = current_date.format('YYYY-MM-DD HH:mm:ss');
                var isFound = false;
                for (var i = 0; i < dates.length; i++) {
                    if ($(dates[i]).text() == current_date_str) {
                        isFound = true;
                        break;
                    }
                }
                if (isFound) {
                    indep.append($('<val />').attr("label", current_date_str).attr("plot_val", "").text(current_date_str));
                }
                current_date.add(by, 'hour');
            }
        }
    }
    plot.append(indep);
    var statistic = $("input:radio[name ='statistics']:checked").val();

    var calc_stat_val = $('#calc_stat').val();
    var agg_stat_val = $('#agg_stat').val();

    if (statistic === 'aggregation_statistics' && agg_stat_val !== "none") {
        var agg_stat = $('<agg_stat />');
        agg_stat.append($('<agg_' + agg_stat_val + ' />').text("true"));
        agg_stat.append($('<boot_repl />').text($('#boot_repl').val()));
        agg_stat.append($('<boot_random_seed />').text($('#boot_random_seed').val()));
        agg_stat.append($('<boot_ci />').text($('#boot_ci').val()));
        agg_stat.append($('<eveq_dis />').text($('#eveq_dis').is(':checked')));
        agg_stat.append($('<cache_agg_stat />').text($('#cacheAggStat').is(':checked')));
        plot.append(agg_stat);
    } else if (statistic === 'calculations_statistics' && calc_stat_val !== "none") {
        var calc_stat = $('<calc_stat />');
        calc_stat.append($('<calc_' + calc_stat_val + ' />').text("true"));
        plot.append(calc_stat);
    }
    plot.append($('<plot_stat />').text($('#plot_stat').val()));
    return plot;


}

function createXMLTaylor(plot) {
    try {
        $("#listdt").saveCell(lastSelRow, lastSelCol);
    } catch (err) {
        console.log("Can't save row " + lastSelRow);
    }


    var dep = $('<dep />');
    dep.append(createDepElementForAxis(1, fcst_var_y1_indexes, selected_mode));
    plot.append(dep);
    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));

    plot = createXMLPlotFix(plot);
    plot.append($('<plot_cond />').text($('#txtPlotCond').val()));
    plot.append($('<taylor_voc />').text($("input:radio[name='taylor_voc']:checked").val()));
    plot.append($('<taylor_show_gamma />').text($("input:radio[name='show_gamma']:checked").val()));

    return plot;


}

function createXMLSeries(plot) {
    try {
        $("#listdt").saveCell(lastSelRow, lastSelCol);
    } catch (err) {
        console.log("Can't save row " + lastSelRow);
    }
    var selected_mode = $("#plot_data").multiselect("getChecked").val();


    var dep = $('<dep />');
    dep.append(createDepElementForAxis(1, fcst_var_y1_indexes, selected_mode));
    dep.append(createDepElementForAxis(2, fcst_var_y2_indexes, selected_mode));
    plot.append(dep);
    plot.append(createSeriesElementForAxis(1, series_var_y1_indexes));
    plot.append(createSeriesElementForAxis(2, series_var_y2_indexes));

    plot = createXMLPlotFix(plot);
    plot.append($('<plot_cond />').text($('#txtPlotCond').val()));
    var indep = $('<indep />').attr("name", $('#indy_var').val()).attr("equalize", $('#indy_var_event_equal').is(':checked'));
    var indy_var_val = $('[name="multiselect_indy_var_val"]');
    if ($("#indy_var_val").multiselect("getChecked").length > 0) {
        for (var i = 0; i < indy_var_val.length; i++) {
            var jqObject = $(indy_var_val[i]);
            if (jqObject.prop('checked')) {
                var id = jqObject.attr("id");
                indep.append($('<val />').attr("label", $('#' + id + '_label').val())
                    .attr("plot_val", $('#' + id + '_plot_val').val()).text(jqObject.val()));
            }
        }
    } else {
        var start = moment.tz($("#date_period_start").val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');//2007-08-15 12:00:00
        var end = moment.tz($("#date_period_end").val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
        var by = $("#date_period_by").val().trim();
        var unit = $("#date_period_by_unit").val();
        var dates = $(previousIndVarValResponse).find("val");
        if (by.length === 0) {
            for (var i = 0; i < dates.length; i++) {
                var t = moment.tz($(dates[i]).text(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                if (t.isSame(start) || t.isSame(end) || t.isBetween(start, end)) {
                    indep.append($('<val />').attr("label", $(dates[i]).text()).attr("plot_val", "").text($(dates[i]).text()));
                }
            }
        } else {
            by = parseInt(by);
            if (unit === "days") {
                by = by * 24;
            }
            var current_date = start.clone();
            while (current_date <= end) {
                var current_date_str = current_date.format('YYYY-MM-DD HH:mm:ss');
                var isFound = false;
                for (var i = 0; i < dates.length; i++) {
                    if ($(dates[i]).text() === current_date_str) {
                        isFound = true;
                        break;
                    }
                }
                if (isFound) {
                    indep.append($('<val />').attr("label", current_date_str).attr("plot_val", "").text(current_date_str));
                }
                current_date.add(by, 'hour');
            }
        }
    }
    plot.append(indep);
    var statistic = $("input:radio[name ='statistics']:checked").val();
    var calc_stat_val = $('#calc_stat').val();
    var agg_stat_val = $('#agg_stat').val();
    var revis_stat_val = $('#revis_stat').val();

    if (statistic === 'aggregation_statistics' && agg_stat_val !== "none") {
        var agg_stat = $('<agg_stat />');
        agg_stat.append($('<agg_' + agg_stat_val + ' />').text("true"));
        agg_stat.append($('<boot_repl />').text($('#boot_repl').val()));
        agg_stat.append($('<boot_random_seed />').text($('#boot_random_seed').val()));
        agg_stat.append($('<boot_ci />').text($('#boot_ci').val()));
        agg_stat.append($('<eveq_dis />').text($('#eveq_dis').is(':checked')));
        agg_stat.append($('<cache_agg_stat />').text($('#cacheAggStat').is(':checked')));
        agg_stat.append($('<circular_block_bootstrap />').text($('#is_cbb').is(':checked')));

        plot.append(agg_stat);
    } else if ((currentTab === 'Bar' || statistic === 'calculations_statistics')
        && calc_stat_val !== "none") {
        var calc_stat = $('<calc_stat />');
        calc_stat.append($('<calc_' + calc_stat_val + ' />').text("true"));
        plot.append(calc_stat);
    } else if (statistic === 'revision_statistics') {
        var revis_stat = $('<revis_stat />');
        if (revis_stat_val !== "none") {
            revis_stat.append($('<calc_' + revis_stat_val + ' />').text("true"));
        }
        revis_stat.append($('<revision_ac />').text($('#revision_ac').prop('checked')));
        revis_stat.append($('<revision_run />').text($('#revision_run').prop('checked')));
        plot.append(revis_stat);
    }
    plot.append($('<plot_stat />').text($('#plot_stat').val()));
    return plot;


}

function createXMLCommon(plot) {
    var tmpl = $('<tmpl />');
    tmpl.append($('<title />').text($('#plot_title').val()));
    tmpl.append($('<x_label />').text($('#x_label_title').val()));
    tmpl.append($('<y1_label />').text($('#y1_label_title').val()));
    tmpl.append($('<y2_label />').text($('#y2_label_title').val()));
    tmpl.append($('<caption />').text($('#caption').val()));
    tmpl.append($('<job_title />').text($('#job_title').val()));
    tmpl.append($('<keep_revisions />').text($('#keep_revisions').is(':checked')));


    var seriesDiffY1List = [];
    var arr;
    if (seriesDiffY1.length > 0) {
        for (var i = 0; i < seriesDiffY1.length; i++) {
            arr = seriesDiffY1[i].split(",");
            seriesDiffY1List.push('c("' + arr[0] + '","' + arr[1] + '","' + arr[2] + '")');
        }
    }
    var seriesDiffY2List = [];
    if (seriesDiffY2.length > 0) {
        for (var i = 0; i < seriesDiffY2.length; i++) {
            arr = seriesDiffY2[i].split(",");
            seriesDiffY2List.push('c("' + arr[0] + '","' + arr[1] + '","' + arr[2] + '")');
        }
    }
    tmpl.append($('<listDiffSeries1 />').text("list(" + seriesDiffY1List.join() + ")"));
    tmpl.append($('<listDiffSeries2 />').text("list(" + seriesDiffY2List.join() + ")"));
    plot.append(tmpl);

    if ($('#is_python').is(':checked')) {
        plot.append($('<execution_type />').text("Python"));
    } else {
        plot.append($('<execution_type />').text("Rscript"));
    }

    plot.append($('<event_equal />').text($('#event_equal').is(':checked')));
    plot.append($('<vert_plot />').text($('#vert_plot').is(':checked')));
    plot.append($('<x_reverse />').text($('#x_reverse').is(':checked')));
    plot.append($('<num_stats />').text($('#num_stats').is(':checked')));
    plot.append($('<indy1_stag />').text($('#indy1_stag').is(':checked')));
    plot.append($('<indy2_stag />').text($('#indy2_stag').is(':checked')));
    plot.append($('<grid_on />').text($('#grid_on').is(':checked')));
    plot.append($('<sync_axes />').text($('#sync_axes').is(':checked')));
    plot.append($('<dump_points1 />').text($('#dump_points1').is(':checked')));
    plot.append($('<dump_points2 />').text($('#dump_points2').is(':checked')));
    plot.append($('<log_y1 />').text($('#log_y1').is(':checked')));
    plot.append($('<log_y2 />').text($('#log_y2').is(':checked')));
    plot.append($('<varianceInflationFactor />').text($('#varianceInflationFactor').is(':checked')));
    plot.append($('<plot_type />').text($('#plot_type').val()));
    plot.append($('<plot_height />').text($('#plot_height').val()));
    plot.append($('<plot_width />').text($('#plot_width').val()));
    plot.append($('<plot_res />').text($('#plot_res').val()));
    plot.append($('<plot_units />').text($('#plot_units').val()));
    var mar_bottom = $("#mar_bottom").val().trim();
    var mar_left = $("#mar_left").val().trim();
    var mar_top = $("#mar_top").val().trim();
    var mar_right = $("#mar_right").val().trim();
    if (mar_bottom.length === 0) {
        mar_bottom = 0;
    }
    if (mar_left.length === 0) {
        mar_left = 0;
    }
    if (mar_top.length === 0) {
        mar_top = 0;
    }
    if (mar_right.length === 0) {
        mar_right = 0;
    }
    plot.append($('<mar />').text("c(" + mar_bottom + "," + mar_left + "," + mar_top + "," + mar_right + ")"));

    var mgp_title = $("#mgp_title").val().trim();
    var mgp_labels = $("#mgp_labels").val().trim();
    var mgp_line = $("#mgp_line").val().trim();
    if (mgp_title.length === 0) {
        mgp_title = 0;
    }
    if (mgp_labels.length === 0) {
        mgp_labels = 0;
    }
    if (mgp_line.length === 0) {
        mgp_line = 0;
    }
    plot.append($('<mgp />').text("c(" + mgp_title + "," + mgp_labels + "," + mgp_line + ")"));
    plot.append($('<cex />').text($('#cex').val()));
    plot.append($('<title_weight />').text($('#title_weight').val()));
    plot.append($('<title_size />').text($('#title_size').val()));
    plot.append($('<title_offset />').text($('#title_offset').val()));
    plot.append($('<title_align />').text($('#title_align').val()));
    plot.append($('<xtlab_orient />').text($('#xtlab_orient').val()));
    plot.append($('<xtlab_perp />').text($('#xtlab_perp').val()));
    plot.append($('<xtlab_horiz />').text($('#xtlab_horiz').val()));
    plot.append($('<xtlab_freq />').text($('#xtlab_freq').val()));
    plot.append($('<xtlab_size />').text($('#xtlab_size').val()));
    plot.append($('<xlab_weight />').text($('#xlab_weight').val()));
    plot.append($('<xlab_size />').text($('#xlab_size').val()));
    plot.append($('<xlab_offset />').text($('#xlab_offset').val()));
    plot.append($('<xlab_align />').text($('#xlab_align').val()));
    plot.append($('<ytlab_orient />').text($('#ytlab_orient').val()));
    plot.append($('<ytlab_perp />').text($('#ytlab_perp').val()));
    plot.append($('<ytlab_horiz />').text($('#ytlab_horiz').val()));
    plot.append($('<ytlab_size />').text($('#ytlab_size').val()));
    plot.append($('<ylab_weight />').text($('#ylab_weight').val()));
    plot.append($('<ylab_size />').text($('#ylab_size').val()));
    plot.append($('<ylab_offset />').text($('#ylab_offset').val()));
    plot.append($('<ylab_align />').text($('#ylab_align').val()));
    plot.append($('<grid_lty />').text($('#grid_lty').val()));

    var grid_col = $('#grid_col').val();
    if (grid_col.startsWith("#")) {
        plot.append($('<grid_col />').text(grid_col));
    } else {
        plot.append($('<grid_col />').text("#" + grid_col));
    }
    plot.append($('<grid_lwd />').text($('#grid_lwd').val()));
    plot.append($('<grid_x />').text($('#grid_x').val()));
    plot.append($('<x2tlab_orient />').text($('#x2tlab_orient').val()));
    plot.append($('<x2tlab_perp />').text($('#x2tlab_perp').val()));
    plot.append($('<x2tlab_horiz />').text($('#x2tlab_horiz').val()));
    plot.append($('<x2tlab_size />').text($('#x2tlab_size').val()));
    plot.append($('<x2lab_size />').text($('#x2lab_size').val()));
    plot.append($('<x2lab_offset />').text($('#x2lab_offset').val()));
    plot.append($('<x2lab_align />').text($('#x2lab_align').val()));
    plot.append($('<y2tlab_orient />').text($('#y2tlab_orient').val()));
    plot.append($('<y2tlab_perp />').text($('#y2tlab_perp').val()));
    plot.append($('<y2tlab_horiz />').text($('#y2tlab_horiz').val()));
    plot.append($('<y2tlab_size />').text($('#y2tlab_size').val()));
    plot.append($('<y2lab_size />').text($('#y2lab_size').val()));
    plot.append($('<y2lab_offset />').text($('#y2lab_offset').val()));
    plot.append($('<y2lab_align />').text($('#y2lab_align').val()));
    plot.append($('<legend_box />').text($('#legend_box').val()));

    if ($('#legend_inset_min').val().trim().length == 0 || $('#legend_inset_max').val().trim().length == 0) {
        plot.append($('<legend_inset />').text("c()"));
    } else {
        plot.append($('<legend_inset />').text("c(" + $('#legend_inset_min').val() + "," + $('#legend_inset_max').val() + ")"));
    }
    plot.append($('<legend_ncol />').text($('#legend_ncol').val()));
    plot.append($('<legend_size />').text($('#legend_size').val()));
    plot.append($('<caption_weight />').text($('#caption_weight').val()));

    var caption_col = $('#caption_col').val();
    if (caption_col.startsWith("#")) {
        plot.append($('<caption_col />').text(caption_col));
    } else {
        plot.append($('<caption_col />').text("#" + caption_col));
    }
    plot.append($('<caption_size />').text($('#caption_size').val()));
    plot.append($('<caption_offset />').text($('#caption_offset').val()));
    plot.append($('<caption_align />').text($('#caption_align').val()));
    plot.append($('<ci_alpha />').text($('#ci_alpha').val()));
    plot.append($('<eqbound_low />').text($('#eqbound_low').val()));
    plot.append($('<eqbound_high />').text($('#eqbound_high').val()));


    var allSeries = sortSeries();
    var ciArr = [], dispArr = [], colorsArr = [], pchArr = [], typeArr = [], ltyArr = [], lwdArr = [], conArr = [],
        orderArr = [], legendArr = [], showSignArr = [];
    for (var i = 0; i < allSeries.length; i++) {
        ciArr.push('"' + allSeries[i].plot_ci + '"');
        if (allSeries[i].hide === "No") {
            dispArr.push("TRUE");
        } else {
            dispArr.push("FALSE");
        }
        if (allSeries[i].show_signif === "No") {
            showSignArr.push("FALSE");
        } else {
            showSignArr.push("TRUE");
        }
        colorsArr.push('"' + allSeries[i].color + 'FF"');
        pchArr.push(allSeries[i].pch);
        typeArr.push('"' + allSeries[i].type + '"');
        ltyArr.push(allSeries[i].lty);
        lwdArr.push(allSeries[i].lwd);
        conArr.push(allSeries[i].con_series);
        orderArr.push(allSeries[i].order);
        legendArr.push('"' + allSeries[i].legend + '"');
    }
    plot.append($('<plot_ci />').text("c(" + ciArr.join() + ")"));
    plot.append($('<show_signif />').text("c(" + showSignArr.join() + ")"));
    plot.append($('<plot_disp />').text("c(" + dispArr.join() + ")"));
    plot.append($('<colors />').text("c(" + colorsArr.join() + ")"));
    plot.append($('<pch />').text("c(" + pchArr.join() + ")"));
    plot.append($('<type />').text("c(" + typeArr.join() + ")"));
    plot.append($('<lty />').text("c(" + ltyArr.join() + ")"));
    plot.append($('<lwd />').text("c(" + lwdArr.join() + ")"));
    plot.append($('<con_series />').text("c(" + conArr.join() + ")"));
    plot.append($('<order_series />').text("c(" + orderArr.join() + ")"));
    plot.append($('<plot_cmd />').text($('#plot_cmd').val()));
    plot.append($('<legend />').text("c(" + legendArr.join() + ")"));
    plot.append($('<create_html />').text("TRUE"));


    if ($('#y1_lim_min').val().trim().length === 0 || $('#y1_lim_max').val().trim().length === 0) {
        plot.append($('<y1_lim />').text("c()"));
    } else {
        plot.append($('<y1_lim />').text("c(" + $('#y1_lim_min').val() + "," + $('#y1_lim_max').val() + ")"));
    }
    if ($('#x1_lim_min').val().trim().length === 0 || $('#x1_lim_max').val().trim().length === 0) {
        plot.append($('<x1_lim />').text("c()"));
    } else {
        plot.append($('<x1_lim />').text("c(" + $('#x1_lim_min').val() + "," + $('#x1_lim_max').val() + ")"));
    }
    plot.append($('<y1_bufr />').text($('#y1_bufr').val()));
    if ($('#y2_lim_min').val().trim().length === 0 || $('#y2_lim_max').val().trim().length === 0) {
        plot.append($('<y2_lim />').text("c()"));
    } else {
        plot.append($('<y2_lim />').text("c(" + $('#y2_lim_min').val() + "," + $('#y2_lim_max').val() + ")"));
    }


    return plot;
}

function sortSeries() {
    $("#listdt").saveCell(lastSelRow, lastSelCol);
    var allSeries = $("#listdt").jqGrid('getRowData');
    var allSeriesActual = [];
    //remove series with display:none
    for (var i = 0; i < allSeries.length; i++) {
        if ($("#" + (i + 1), "#gbox_listdt").css("display") !== "none") {
            allSeriesActual.push(allSeries[i]);
        }
    }
    if (allSeriesActual.length === 1) {
        allSeriesActual[0].order = 1;
    } else {
        allSeriesActual = allSeriesActual.sort(function (a, b) {
            return (parseInt(a.id) > parseInt(b.id)) ? 1 : ((parseInt(a.id) < parseInt(b.id)) ? -1 : 0);

        });
    }

    return allSeriesActual;
}

function createSeriesElementForAxis(y_axis, series_var_indexes) {
    var series = $('<series' + y_axis + ' />');
    for (var i = 0; i < series_var_indexes.length; i++) {
        var field = $('<field />').attr("name", $("#series_var_y" + y_axis + "_" + series_var_indexes[i]).val());
        var isGroup = $("#group_series_var_y" + y_axis + "_" + series_var_indexes[i]).is(':checked');
        var valArr;
        try {
            valArr = $("#series_var_val_y" + y_axis + "_" + series_var_indexes[i]).multiselect("getChecked");
        } catch (e) {
        }
        if (!valArr) {
            valArr = [];
        }

        if (Array.isArray(valArr)) {
            if (valArr.length > 0) {
                if (isGroup) {
                    var vals = "";
                    for (var j = 0; j < valArr.length; j++) {
                        vals = vals + text(valArr[j]);
                        if (j !== valArr.length - 1) {
                            vals = vals + ':';
                        }
                    }
                    field.append($('<val />').text(vals));
                } else {
                    for (var j = 0; j < valArr.length; j++) {
                        field.append($('<val />').text(valArr[j]));
                    }
                }
                series.append(field);
            }
        } else {
            if (typeof (valArr) === 'object') {
                if (isGroup) {
                    var vals = "";
                    for (var j = 0; j < valArr.length; j++) {
                        vals = vals + $(valArr[j]).val();
                        if (j !== valArr.length - 1) {
                            vals = vals + ':';
                        }
                    }
                    field.append($('<val />').text(vals));
                } else {
                    for (var j = 0; j < valArr.length; j++) {
                        var val = $(valArr[j]).val();
                        if (val.length > 0) {
                            field.append($('<val />').text(val));
                        }
                    }
                }
            } else {
                field.append($('<val />').text(valArr));
            }
            series.append(field);
        }

    }
    return series;
}

function createDepElementForAxis(y_axis, fcst_var_indexes, selected_mode) {
    var depAxis = $('<dep' + y_axis + ' />');

    var forecast_var_to_stat_map = createMapForForecastVar(y_axis, fcst_var_indexes, selected_mode);
    for (var name in forecast_var_to_stat_map) {
        var fcst_var = $('<fcst_var />').attr("name", name.replace("&", "&amp;").replace(">", "&gt;").replace("<", "&lt;"));
        for (var i = 0; i < forecast_var_to_stat_map[name].length; i++) {
            fcst_var.append($('<stat />').text(forecast_var_to_stat_map[name][i]));
        }
        depAxis.append(fcst_var);
    }
    return depAxis;
}

function refreshHistory() {
    $('#history_content').empty();
    var result = $('<request />');
    var history = $('<history />');
    var isShowAll = false;
    if ($("input:radio[name='show_history_choice']:checked").val() == 'show_history_all') {
        isShowAll = true;
    }
    history.append($('<show_all>' + isShowAll + '</show_all>'));
    result.append(history);
    $.ajax({
        url: 'servlet',
        processData: false,
        type: "POST",
        dataType: 'xml',
        contentType: "application/xml",
        data: $('<root />').append(result).html(), // send the string directly
        success: function (response) {
            var xml = $(response);
            var results = $(xml.find("results")[0]).find("file");
            for (var i = 0; i < results.length; i++) {
                var name = $(results[i]).attr("name");
                var success = $(results[i]).attr("success");
                var color;
                if (success === "true") {
                    color = "#000000"
                } else {
                    color = "#B39A9A"
                }
                $('#history_content').append($('<tr/>').append($('<td/>').append($('<button />').attr("id", name).addClass('view-image').text("Image"))).append($('<td/>').append($('<button />').attr("id", name).addClass('load-image').text("XML"))).append($('<td/>').css("color", color).text(name)));
            }
            $(".view-image").button({
                icons: {
                    primary: "ui-icon-image"
                },
                text: false
            }).click(function () {
                viewImage($(this).attr('id'));
            });
            $(".load-image").button({
                icons: {
                    primary: "ui-icon-document"
                },
                text: false
            }).click(function () {
                $('#uploadLocalId').val($(this).prop('id'));
                loadImage($(this).attr('id'));
            });


        },
        error: function (response) {
            alert(response);
        }
    });
}

function loadImage(id) {
    boxID = boxID + 1;
    window_center = window_center + 20;
    window_top = window_top + 20;
    var dialog = $('<div>').attr("id", boxID + "dialog").dialog({
        height: 400,
        width: 600,
        resizable: true,
        closeOnEscape: true,
        autoOpen: false,
        focus: true,
        dialogClass: "dialog-box-" + boxID,
        title: id,
        position: {
            my: ("center+" + window_center + " top+" + window_top),
            at: "center top",
            of: window
        },
        close: function (e) {
            $(this).empty();
            $(this).dialog('destroy');
            window_center = window_center - 20;
            window_top = window_top - 20;
        },
        buttons: {
            "Load to Page": function () {
                $('#formUploadLocal').submit();
                $(this).dialog("close");
            },
            "Download to Disk": function () {
                var inputs = '';
                inputs += '<input type="hidden" name="plot" value="plot_' + id + '" />';
                inputs += '<input type="hidden" name="type" value="plot_xml_url" />';
                $('<form action="download" method="' + 'get' + '">' + inputs + '</form>').appendTo('body').submit().remove();
                $(this).dialog("close");
            }
        },
        create: function (event, ui) {
            $.ajax({
                async: false,
                type: "GET",
                url: urlOutput + "xml/plot_" + id + ".xml",
                dataType: "xml",
                success: function (data) {
                    var xmlString;
                    if (jQuery.browser == "msie") {
                        xmlString = data.xml;
                    } else {
                        xmlString = (new XMLSerializer()).serializeToString(data);
                    }
                    try {
                        $("#" + boxID + "dialog").append(formatXml(xmlString).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/ /g, '&nbsp;').replace(/\n/g, '<br />'));
                    } catch (e) {
                        console.log(e + " " + "can't append xml");
                    }
                }
            });
        }
    });

    dialog.dialog("open");
}

function formatXml(xml) {
    var formatted = '';
    var reg = /(>)(<)(\/*)/g;
    xml = xml.replace(reg, '$1\r\n$2$3');
    var pad = 0;
    jQuery.each(xml.split('\r\n'), function (index, node) {
        var indent = 0;
        if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
        } else if (node.match(/^<\/\w/)) {
            if (pad != 0) {
                pad -= 1;
            }
        } else if (node.match(/^<\w[^>]*[^\/]>.*$/)) {
            indent = 1;
        } else {
            indent = 0;
        }

        var padding = '';
        for (var i = 0; i < pad; i++) {
            padding += ' ';
        }

        formatted += padding + node + '\r\n';
        pad += indent;
    });

    return formatted;
}

function resetFormatting() {
    // $('#file_name').val("");
    $('#plot_title').val("test title");
    $('#x_label_title').val("test x_label");
    $('#y1_label_title').val("test y_label");
    $('#y2_label_title').val("");
    $('#caption').val("");
    $('#job_title').val("");
    $('#keep_revisions').prop('checked', false);

    $("#is_python").prop('checked', false);
    $("#vert_plot").prop('checked', false);
    $("#x_reverse").prop('checked', false);
    $("#num_stats").prop('checked', false);
    $("#grid_on").prop('checked', true);
    $("#sync_axes").prop('checked', false);
    $("#dump_points1").prop('checked', false);
    $("#dump_points2").prop('checked', false);
    $("#indy1_stag").prop('checked', false);
    $("#indy2_stag").prop('checked', false);
    $("#varianceInflationFactor").prop('checked', true);
    $("#ci_alpha").val("0.05");
    $("#eqbound_low").val("-0.001");
    $("#eqbound_high").val("0.001");

    $("#plot_type").val("png16m");
    $("#plot_height").val("8.5");
    $("#plot_width").val("11");
    $("#plot_units").val("in");
    $("#cex").val("1");
    $("#plot_res").val("72");
    $("#mar_bottom").val("8");
    $("#mar_left").val("4");
    $("#mar_top").val("5");
    $("#mar_right").val("4");

    $("#mgp_title").val("1");
    $("#mgp_labels").val("1");
    $("#mgp_line").val("0");
    $("#title_align").val("0.5");
    $("#title_offset").val("-2");
    $("#title_size").val("1.4");
    $("#title_weight").val("2");
    $("#grid_lty").val("3");
    $("#grid_lwd").val("1");
    $("#grid_x").val("listX");
    $("#plot_cmd").val("");

    $("#xlab_align").val("0.5");
    $("#xlab_offset").val("2");
    $("#xlab_size").val("1");
    $("#xlab_weight").val("1");
    $("#xtlab_horiz").val("0.5");
    $("#xtlab_perp").val("-0.75");
    $("#xtlab_size").val("1");
    $("#xtlab_freq").val("0");
    $("#xtlab_orient").val("1");

    $("#x2lab_align").val("0.5");
    $("#x2lab_offset").val("-0.5");
    $("#x2lab_size").val("0.8");
    $("#x2lab_weight").val("1");
    $("#x2tlab_horiz").val("0.5");
    $("#x2tlab_perp").val("1");
    $("#x2tlab_size").val("0.8");
    $("#x2tlab_orient").val("1");

    $("#ylab_align").val("0.5");
    $("#ylab_offset").val("-2");
    $("#ylab_size").val("1");
    $("#ylab_weight").val("1");
    $("#ytlab_horiz").val("0.5");
    $("#ytlab_perp").val("0.5");
    $("#ytlab_size").val("1");
    $("#ytlab_orient").val("1");
    $("#y1_lim_min").val("");
    $("#y1_lim_max").val("");
    $("#y1_bufr").val("0.04");


    $("#y2lab_align").val("0.5");
    $("#y2lab_offset").val("1");
    $("#y2lab_size").val("1");
    $("#y2lab_weight").val("1");
    $("#y2tlab_horiz").val("0.5");
    $("#y2tlab_perp").val("0.5");
    $("#y2tlab_size").val("1");
    $("#y2tlab_orient").val("1");
    $("#y2_bufr").val("0");

    $("#legend_size").val("0.8");
    $("#legend_inset_min").val("0");
    $("#legend_inset_max").val(" -.25");
    $("#legend_box").val("o");
    $("#legend_ncol").val("3");
    $("#caption_align").val("0");
    $("#caption_offset").val("3");
    $("#caption_size").val("0.8");
    $("#caption_weight").val("1");
    $("#x1_lim_min").val("");
    $("#x1_lim_max").val("");


}

function removeFixedVarHist(id) {
    var id_array = id.split("_");
    var index = id_array[id_array.length - 1];
    //destroy selects
    var select = $("#fixed_var_" + index);
    select.multiselect("destroy");
    $("#fixed_var_val_" + index).multiselect("destroy");

    var index_of_removing_el = jQuery.inArray(parseInt(index), fixed_var_indexes);
    if (index_of_removing_el > -1) {
        fixed_var_indexes.splice(index_of_removing_el, 1);
        fixVarValResponse[parseInt(index)] = null;
    }
    if (fixed_var_indexes.length == 1) {
        $("#remove_fixed_var_" + fixed_var_indexes[0]).button({disabled: true});
    }
    select.parent().parent().remove();
}

function removeFixedVar(id) {
    var id_array = id.split("_");
    var index = id_array[id_array.length - 1];
    //destroy selects
    try {
        $("#fixed_var_" + index).multiselect("destroy");
        $("#fixed_var_val_" + index).multiselect("destroy");
        $("#fixed_var_val_date_period_" + index).dialog("destroy");
        $("#fixed_var_val_date_period_" + index).remove();
        $("#fixed_var_val_date_period_button_" + index).button("destroy");
        $("#fixed_var_val_date_range_button_" + index).button("destroy");
    } catch (e) {
    }

    var index_of_removing_el = jQuery.inArray(parseInt(index), fixed_var_indexes);
    if (index_of_removing_el > -1) {
        fixed_var_indexes.splice(index_of_removing_el, 1);
    }
    if (fixed_var_indexes.length > 0) {
        $("#fixed_var_" + index).parent().parent().remove();
    } else {
        $('#fixed_var_table').css("display", "none");
    }

}


function addFixedVarHist() {
    var last_index;
    if (fixed_var_indexes.length > 0) {
        last_index = parseInt(fixed_var_indexes[fixed_var_indexes.length - 1]);
    } else {
        last_index = 1;
    }

    var new_index = last_index;
    var is_not_visible = $('#fixed_var_table').css("display") === 'none';
    var isEq = $('#event_equal').prop("checked");

    var fixed_var, remove_var, fixed_var_val, fixed_var_val_date_period_button, fixed_var_val_date_range_button,
        fixed_var_val_date_range, dialog,
        fix_var_event_equal, fix_var_event_equal_label;

    if (is_not_visible) {
        if (fixed_var_indexes.length === 0) {
            fixed_var_indexes.push(new_index);
        }
        $('#fixed_var_table').css("display", "");
        fixed_var = $("#fixed_var_" + new_index);
        $("#remove_fixed_var_" + new_index).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        });
        fixed_var_val = $("#fixed_var_val_" + new_index);
        fixed_var_val_date_period_button = $("#fixed_var_val_date_period_button_" + new_index);
        fixed_var_val_date_range_button = $("#fixed_var_val_date_range_button_" + new_index);
        dialog = $("#fixed_var_val_date_period_" + new_index);
        $("#fix_var_event_equal_" + new_index).prop("checked", isEq).prop('disabled', !isEq);

    } else {
        new_index = parseInt(last_index) + 1;
        fixed_var_indexes.push(new_index);
        fixed_var = $("#fixed_var_" + last_index).clone(false);
        fixed_var.prop("id", 'fixed_var_' + new_index);
        fixed_var.css("display", '');
        fixed_var.val(fixed_var.find(" option:first").val());

    }


    if (!is_not_visible) {

        remove_var = $(' <button id="remove_fixed_var_"' + new_index + '" class="remove_fixed_var">Remove</button>').button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeFixedVarHist("remove_fixed_var_" + new_index);
        });


        fixed_var_val = $("#fixed_var_val_" + last_index).clone(false);
        fixed_var_val.prop("id", 'fixed_var_val_' + new_index);
        fixed_var_val.css("display", '');
        fixed_var.val(fixed_var.find(" option:first").val());

        fixed_var_val_date_period_button = $("<button>", {
            text: 'Select multiple options',
            id: 'fixed_var_val_date_period_button_' + new_index
        }).css('display', 'none');
        fixed_var_val_date_range = $("#fixed_var_val_date_range_" + last_index).clone(false);
        fixed_var_val_date_range.prop("id", 'fixed_var_val_date_range_' + new_index);
        fixed_var_val_date_range_button = $("<button>", {
            text: 'Select multiple options',
            id: 'fixed_var_val_date_range_button_' + new_index
        }).css('display', 'none');

        dialog = $("#fixed_var_val_date_period_" + (last_index)).clone(false).appendTo("body");
        dialog.prop("id", "fixed_var_val_date_period_" + new_index);
        dialog.find("#fixed_var_val_date_period_start_" + (last_index)).prop('id', 'fixed_var_val_date_period_start_' + new_index);
        dialog.find("#fixed_var_val_date_period_end_" + (last_index)).prop('id', 'fixed_var_val_date_period_end_' + new_index);
        dialog.find("#fixed_var_val_date_period_by_" + (last_index)).prop('id', 'fixed_var_val_date_period_by_' + new_index);
        dialog.find("#fixed_var_val_date_period_by_unit_" + (last_index)).prop('id', 'fixed_var_val_date_period_by_unit_' + new_index);
        fix_var_event_equal = $("#fix_var_event_equal_" + last_index).clone(true)
            .prop("id", 'fix_var_event_equal_' + new_index).prop("checked", isEq).prop('disabled', !isEq);
        if ($("#fix_var_event_equal_" + last_index).find('label').size() > 0) {
            fix_var_event_equal_label = $('<label for="fix_var_event_equal_' + new_index + '">Equalize</label>');
        }
        $('body').append(dialog);

        $('#fixed_var_table').append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(fixed_var))
            .append($('<td>').append(fixed_var_val)).append($('<td>').append(fixed_var_val_date_period_button))
            .append($('<td>').append(fixed_var_val_date_range).append(fixed_var_val_date_range_button))
            .append($('<td>').append(fix_var_event_equal).append(fix_var_event_equal_label)));
    }
    createValDatePeriodDialog('fixed_var_val', new_index);

    fixed_var_val.multiselect({
        selectedList: 100, // 0-based index
        noneSelectedText: "Select value",
        position: {
            my: 'center center',
            at: 'right center'
        }
    });
    fixed_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        height: 300,
        click: function (event, ui) {
            $('#fixed_var_val_date_period_start_' + new_index).empty();
            $('#fixed_var_val_date_period_end_' + new_index).empty();

            if (ui.value === "fcst_init_beg" || ui.value === "fcst_valid_beg" || ui.value === "fcst_valid" || ui.value === "fcst_init") {
                $("#fixed_var_val_date_period_button_" + new_index).css("display", "block");
                $("#fixed_var_val_date_range_button_" + new_index).css("display", "block");
            } else {
                $("#fixed_var_val_date_period_button_" + new_index).css("display", "none");
                $("#fixed_var_val_date_range_button_" + new_index).css("display", "none");
            }
            var id_array = this.id.split("_");
            updateFixedVarValHist(id_array[id_array.length - 1], []);
        }
    });
    fixed_var_val_date_period_button.button({
        icons: {
            primary: "ui-icon-check",
            secondary: "ui-icon-circlesmall-plus"
        },
        text: false
    }).click(function () {
        $("#fixed_var_val_date_period_" + new_index).dialog("open");
    });
    fixed_var_val_date_range_button.button({
        icons: {
            primary: "ui-icon-calendar"
        },
        text: false
    }).click(function (evt) {
        evt.stopPropagation();
        var dates = $(fixVarValResponse[new_index]).find("val");
        var start = $(dates[0]).text();
        var end = $(dates[dates.length - 1]).text();
        try {
            $("#fixed_var_val_date_range_" + new_index).unbind("datepicker-apply");
            $("#fixed_var_val_date_range_" + new_index).data('dateRangePicker').destroy();
        } catch (error) {
            console.log(error);
        }
        $("#fixed_var_val_date_range_" + new_index).dateRangePicker({
            startOfWeek: 'sunday',
            separator: ' - ',
            format: 'YYYY-MM-DD HH:mm',
            autoClose: false,
            time: {
                enabled: true
            },
            startDate: moment.tz(start, 'YYYY-MM-DD HH:mm:ss', 'UTC'),
            endDate: moment.tz(end, 'YYYY-MM-DD HH:mm:ss', 'UTC'),
            showShortcuts: true,
            shortcuts: {
                'prev-days': [3, 7, 30],
                'prev': ['week', 'month', 'year'],
                'next-days': null,
                'next': null
            },
            monthSelect: true,
            yearSelect: true,
            container: document.getElementById('fixed_var_table').parentElement,
            customTopBar: function () {
                return createCalendarTopBarNoFormat(new_index);
            }
        }).bind('datepicker-apply', function (event, obj) {
            onIndyCalendarClose(obj, new_index);
        });
        $("#fixed_var_val_date_range_" + new_index).data('dateRangePicker').open();
    });
    updateFixedVarValHist(new_index, []);

}

function addFixedVar() {
    var last_index;

    if (fixed_var_indexes.length > 0) {
        last_index = parseInt(fixed_var_indexes[fixed_var_indexes.length - 1]);
    } else {
        var firstSelect = $("#fixed_var_table select:first-child");
        if (firstSelect) {
            last_index = parseInt(firstSelect.prop("id").split("fixed_var_")[1]);
        } else {
            last_index = 1;
        }
    }
    var new_index = last_index;


    var fixed_var, remove_var, fixed_var_val, fixed_var_val_date_period_button, fixed_var_val_date_range_button,
        fixed_var_val_date_range, dialog,
        fix_var_event_equal, fix_var_event_equal_label;
    var is_not_visible = $('#fixed_var_table').css("display") === 'none';
    var isEq = $('#event_equal').prop("checked");

    if (is_not_visible) {
        if (fixed_var_indexes.length === 0) {
            fixed_var_indexes.push(new_index);
        }
        $('#fixed_var_table').css("display", "");
        fixed_var = $("#fixed_var_" + new_index);
        if ($("#fixed_var_" + new_index + ' option').length === 0) {
            if (currentTab === 'Perf') {
                $.each(perf_fixed_var_map, function (key, val) {
                    fixed_var.append('<option value="' + key + '">' + val + '</option>');
                });
            } else {
                if (selected_mode === "stat") {
                    $.each(fix_var_value_to_title_stat_map, function (key, val) {
                        fixed_var.append('<option value="' + key + '">' + val + '</option>');
                    });
                } else if (selected_mode === "mode") {
                    $.each(fix_var_value_to_title_mode_map, function (key, val) {
                        fixed_var.append('<option value="' + key + '">' + val + '</option>');
                    });
                } else {
                    $.each(fix_var_value_to_title_mtd_map, function (key, val) {
                        fixed_var.append('<option value="' + key + '">' + val + '</option>');
                    });
                }
            }
        }
        $("#remove_fixed_var_" + new_index).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        });
        fixed_var_val = $("#fixed_var_val_" + new_index);

        fixed_var_val_date_period_button = $("#fixed_var_val_date_period_button_" + new_index);
        fixed_var_val_date_range_button = $("#fixed_var_val_date_range_button_" + new_index);
        fixed_var_val_date_range = $("#fixed_var_val_date_range_" + new_index);
        dialog = $("#fixed_var_val_date_period_" + new_index);
        $("#fix_var_event_equal_" + new_index).prop("checked", isEq).prop('disabled', !isEq);

    } else {
        new_index = parseInt(last_index) + 1;
        fixed_var_indexes.push(new_index);
        fixed_var = $("#fixed_var_" + last_index).clone(false);
        fixed_var.prop("id", 'fixed_var_' + new_index);
        fixed_var.css("display", '');
        fixed_var.val(fixed_var.find(" option:first").val());

    }

    if (!is_not_visible) {
        remove_var = $('<button id="remove_fixed_var_' + new_index + '" class="remove_fixed_var">Remove</button>');


        fixed_var_val = $("#fixed_var_val_" + last_index).clone(false);
        fixed_var_val.prop("id", 'fixed_var_val_' + new_index);
        fixed_var_val.css("display", '');
        fixed_var.val(fixed_var.find(" option:first").val());
        fixed_var_val_date_period_button = $("<button>", {
            text: 'Select multiple options',
            id: 'fixed_var_val_date_period_button_' + new_index
        }).css('display', 'none');
        fixed_var_val_date_range = $("#fixed_var_val_date_range_" + last_index).clone(false);
        fixed_var_val_date_range.prop("id", 'fixed_var_val_date_range_' + new_index);
        fixed_var_val_date_range_button = $("<button>", {
            text: 'Select multiple options',
            id: 'fixed_var_val_date_range_button_' + new_index
        }).css('display', 'none');
        dialog = $("#fixed_var_val_date_period_" + (last_index)).clone(false).appendTo("body");
        dialog.prop("id", "fixed_var_val_date_period_" + new_index);
        dialog.find("#fixed_var_val_date_period_start_" + (last_index)).prop('id', 'fixed_var_val_date_period_start_' + new_index);
        dialog.find("#fixed_var_val_date_period_end_" + (last_index)).prop('id', 'fixed_var_val_date_period_end_' + new_index);
        dialog.find("#fixed_var_val_date_period_by_" + (last_index)).prop('id', 'fixed_var_val_date_period_by_' + new_index);
        dialog.find("#fixed_var_val_date_period_by_unit_" + (last_index)).prop('id', 'fixed_var_val_date_period_by_unit_' + new_index);
        fix_var_event_equal = $("#fix_var_event_equal_" + last_index).clone(true)
            .prop("id", 'fix_var_event_equal_' + new_index).prop("checked", isEq).prop('disabled', !isEq);
        if ($("#fix_var_event_equal_" + last_index).find('label').size() > 0) {
            fix_var_event_equal_label = $('<label for="fix_var_event_equal_' + new_index + '">Equalize</label>');
        }
        $('body').append(dialog);

        $('#fixed_var_table').append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(fixed_var)).append($('<td>')
            .append(fixed_var_val))
            .append($('<td>').append(fixed_var_val_date_period_button))
            .append($('<td>').append(fixed_var_val_date_range).append(fixed_var_val_date_range_button))
            .append($('<td>').append(fix_var_event_equal).append(fix_var_event_equal_label)));

        remove_var.button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeFixedVar($(this).attr('id'));
        });
    }

    createValDatePeriodDialog('fixed_var_val', new_index);
    if (currentTab === 'Contour') {
        fixed_var_val.multiselect({
            selectedList: 100, // 0-based index
            noneSelectedText: "Select value",
            position: {
                my: 'center center',
                at: 'right center'
            },

            close: function () {
                updateSeries();
            }
        });
    } else {
        fixed_var_val.multiselect({
            selectedList: 100, // 0-based index
            noneSelectedText: "Select value",
            position: {
                my: 'center center',
                at: 'right center'
            }
        });
    }


    fixed_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        height: 300,
        click: function (event, ui) {
            $('#fixed_var_val_date_period_start_' + new_index).empty();
            $('#fixed_var_val_date_period_end_' + new_index).empty();

            if (ui.value === "fcst_init_beg" || ui.value === "fcst_valid_beg" || ui.value === "fcst_valid" || ui.value === "fcst_init") {
                $("#fixed_var_val_date_period_button_" + new_index).css("display", "block");
                $("#fixed_var_val_date_range_button_" + new_index).css("display", "block");
            } else {
                $("#fixed_var_val_date_period_button_" + new_index).css("display", "none");
                $("#fixed_var_val_date_range_button_" + new_index).css("display", "none");
            }
            var id_array = this.id.split("_");
            updateFixedVarVal(id_array[id_array.length - 1], []);
        }
    });
    fixed_var_val_date_period_button.button({
        icons: {
            primary: "ui-icon-check",
            secondary: "ui-icon-circlesmall-plus"
        },
        text: false
    }).click(function () {
        $("#fixed_var_val_date_period_" + new_index).dialog("open");
    });
    fixed_var_val_date_range_button.button({
        icons: {
            primary: "ui-icon-calendar"
        },
        text: false
    }).click(function (evt) {
        evt.stopPropagation();
        var dates = $(fixVarValResponse[new_index]).find("val");
        var start = $(dates[0]).text();
        var end = $(dates[dates.length - 1]).text();
        try {
            $("#fixed_var_val_date_range_" + new_index).unbind("datepicker-apply");
            $("#fixed_var_val_date_range_" + new_index).data('dateRangePicker').destroy();
        } catch (error) {
            console.log(error);
        }
        $("#fixed_var_val_date_range_" + new_index).dateRangePicker({
            startOfWeek: 'sunday',
            separator: ' - ',
            format: 'YYYY-MM-DD HH:mm',
            autoClose: false,
            time: {
                enabled: true
            },
            startDate: moment.tz(start, 'YYYY-MM-DD HH:mm:ss', 'UTC'),
            endDate: moment.tz(end, 'YYYY-MM-DD HH:mm:ss', 'UTC'),
            showShortcuts: true,
            shortcuts: {
                'prev-days': [3, 7, 30],
                'prev': ['week', 'month', 'year'],
                'next-days': null,
                'next': null
            },
            monthSelect: true,
            yearSelect: true,
            container: document.getElementById('fixed_var_table').parentElement,
            customTopBar: function () {
                return createCalendarTopBarNoFormat(new_index);
            }
        }).bind('datepicker-apply', function (event, obj) {
            onIndyCalendarClose(obj, new_index);
        });
        $("#fixed_var_val_date_range_" + new_index).data('dateRangePicker').open();
    });

    updateFixedVarVal(new_index, []);
}

function removeSeriesVarCommon(id) {
    var id_array = id.split("_");
    var index = id_array[id_array.length - 1];
    var y_axis = id_array[id_array.length - 2];
    var index_of_removing_el;
    //destroy selects
    try {
        $("#series_var_" + y_axis + "_" + index).multiselect("destroy");
    } catch (err) {
    }
    try {
        $("#series_var_val_" + y_axis + "_" + index).multiselect("destroy");
    } catch (err) {
    }
    if (y_axis === 'y1') {
        index_of_removing_el = jQuery.inArray(parseInt(index), series_var_y1_indexes);
        if (index_of_removing_el > -1) {
            series_var_y1_indexes.splice(index_of_removing_el, 1);
            seriesY1VarValResponse[parseInt(index)] = null;
        }

        if (series_var_y1_indexes.length > 0) {
            $("#series_var_" + y_axis + "_" + index).parent().parent().remove();
        } else {
            $('#series_var_table_' + y_axis).css("display", "none");
        }
    } else {
        index_of_removing_el = jQuery.inArray(parseInt(index), series_var_y2_indexes);
        if (index_of_removing_el > -1) {
            series_var_y2_indexes.splice(index_of_removing_el, 1);
            seriesY1VarValResponse[parseInt(index)] = null;
        }

        if (series_var_y2_indexes.length > 0) {
            $("#series_var_" + y_axis + "_" + index).parent().parent().remove();
        } else {
            $('#series_var_table_' + y_axis).css("display", "none");
        }
    }

}

function removeSeriesVar(id) {
    removeSeriesVarCommon(id);
    if (series_var_y1_indexes.length == 1) {
        $("#remove_series_var_y1_" + (series_var_y1_indexes[0])).button("disable");
    }
    updateSeries();
}

function addSeriesVarEns() {
    var last_index;

    if (series_var_y1_indexes.length > 0) {
        last_index = series_var_y1_indexes[series_var_y1_indexes.length - 1];
    } else {
        last_index = 0;
    }
    series_var_y1_indexes.push(last_index + 1);

    var series_var, remove_var, series_var_val;
    if (last_index == 0) {
        $('#series_var_table_y1').css("display", "");
        series_var = $("#series_var_y1_" + (last_index + 1));
        $("#remove_series_var_y1_" + (last_index + 1)).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeSeriesVar($(this).attr('id'));
        });
        series_var_val = $("#series_var_val_y1_" + (last_index + 1));

    } else {
        series_var = $("#series_var_y1_" + last_index).clone(false);
        series_var.attr("id", 'series_var_y1_' + (last_index + 1));
        series_var.css("display", '');
    }

    if (last_index > 0) {
        remove_var = $("#remove_series_var_y1_" + last_index).button("enable").clone(true)
            .attr("id", 'remove_series_var_y1_' + (last_index + 1));

        series_var_val = $("#series_var_val_y1_" + last_index).clone(false);
        series_var_val.attr("id", 'series_var_val_y1_' + (last_index + 1));
        series_var_val.css("display", '');


        $('#series_var_table_y1').append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(series_var)).append($('<td>').append(series_var_val)));
    }
    series_var_val.multiselect({
        selectedList: 100, // 0-based index
        noneSelectedText: "Select value",
        click: function () {
            updateSeriesEns();
        },
        checkAll: function () {
            updateSeries(true);
        },
        uncheckAll: function () {
            updateSeries();
        }

    });
    try {
        series_var_val.multiselect("uncheckAll");
    } catch (err) {

    }
    series_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        click: function () {
            var id_array = this.id.split("_");
            updateSeriesVarValEns(id_array[id_array.length - 1], []);
        }
    });
}

function addSeriesVarPerf() {
    var last_index;

    if (series_var_y1_indexes.length > 0) {
        last_index = series_var_y1_indexes[series_var_y1_indexes.length - 1];
    } else {
        last_index = 0;
    }
    series_var_y1_indexes.push(last_index + 1);

    var series_var, remove_var, series_var_val;
    if (last_index == 0) {
        $('#series_var_table_y1').css("display", "");
        series_var = $("#series_var_y1_" + (last_index + 1));
        $("#remove_series_var_y1_" + (last_index + 1)).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeSeriesVar($(this).attr('id'));
        });
        series_var_val = $("#series_var_val_y1_" + (last_index + 1));

    } else {
        series_var = $("#series_var_y1_" + last_index).clone(false);
        series_var.attr("id", 'series_var_y1_' + (last_index + 1));
        series_var.css("display", '');
    }

    if (last_index > 0) {
        remove_var = $("#remove_series_var_y1_" + last_index).button("enable").clone(true)
            .attr("id", 'remove_series_var_y1_' + (last_index + 1));

        series_var_val = $("#series_var_val_y1_" + last_index).clone(false);
        series_var_val.attr("id", 'series_var_val_y1_' + (last_index + 1));
        series_var_val.css("display", '');


        $('#series_var_table_y1').append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(series_var)).append($('<td>').append(series_var_val)));
    }
    series_var_val.multiselect({
        selectedList: 100, // 0-based index
        noneSelectedText: "Select value",
        click: function () {
            updateSeriesPerf();
        },
        checkAll: function () {
            updateSeriesPerf(true);
        },
        uncheckAll: function () {
            updateSeriesPerf();
        }

    });
    try {
        series_var_val.multiselect("uncheckAll");
    } catch (err) {

    }
    series_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        click: function () {
            var id_array = this.id.split("_");
            updateSeriesVarValHist(id_array[id_array.length - 1], []);
        }
    });
}

function addSeriesVarHist() {
    var last_index;

    if (series_var_y1_indexes.length > 0) {
        last_index = series_var_y1_indexes[series_var_y1_indexes.length - 1];
    } else {
        last_index = 0;
    }
    series_var_y1_indexes.push(last_index + 1);

    var series_var, remove_var, series_var_val, var_val_date_period_button, dialog;
    if (last_index === 0) {
        $('#series_var_table_y1').css("display", "");
        series_var = $("#series_var_y1_" + (last_index + 1));
        $("#remove_series_var_y1_" + (last_index + 1)).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeSeriesVarCommon($(this).attr('id'));
            updateSeriesHist();
        });
        series_var_val = $("#series_var_val_y1_" + (last_index + 1));
        var_val_date_period_button = $("#series_var_val_y1_date_period_button_" + (last_index + 1));
        dialog = $("#series_var_val_y1_date_period_" + (last_index + 1));


    } else {
        series_var = $("#series_var_y1_" + last_index).clone(false);
        series_var.attr("id", 'series_var_y1_' + (last_index + 1));
        series_var.css("display", '');
    }

    if (last_index > 0) {
        remove_var = $("#remove_series_var_y1_" + last_index).button("enable").clone(true)
            .attr("id", 'remove_series_var_y1_' + (last_index + 1));

        series_var_val = $("#series_var_val_y1_" + last_index).clone(false);
        series_var_val.attr("id", 'series_var_val_y1_' + (last_index + 1));
        series_var_val.css("display", '');

        var_val_date_period_button = $("<button>", {
            text: 'Select multiple options',
            id: 'series_var_val_y1_date_period_button_' + (last_index + 1)
        }).css('display', 'none');
        dialog = $("#series_var_val_y1_date_period_" + (last_index)).clone(false).appendTo("body");
        dialog.prop("id", "series_var_val_y1_date_period_" + (last_index + 1));
        dialog.find("#series_var_val_y1_date_period_start_" + (last_index)).prop('id', 'series_var_val_y1_date_period_start_' + (last_index + 1));
        dialog.find("#series_var_val_y1_date_period_end_" + (last_index)).prop('id', 'series_var_val_y1_date_period_end_' + (last_index + 1));
        dialog.find("#series_var_val_y1_date_period_by_" + (last_index)).prop('id', 'series_var_val_y1_date_period_by_' + (last_index + 1));
        dialog.find("#series_var_val_y1_date_period_by_unit_" + (last_index)).prop('id', 'series_var_val_y1_date_period_by_unit_' + (last_index + 1));
        $('body').append(dialog);


        $('#series_var_table_y1').append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(series_var)).append($('<td>').append(series_var_val)).append($('<td>').append(var_val_date_period_button)));
    }
    createValDatePeriodDialog("series_var_val_y1", (last_index + 1));

    series_var_val.multiselect({
        selectedList: 100, // 0-based index
        noneSelectedText: "Select value",
        click: function () {
            updateSeriesHist();
        },
        checkAll: function () {
            updateSeriesHist();
        },
        uncheckAll: function () {
            updateSeriesHist();
        }

    });
    try {
        series_var_val.multiselect("uncheckAll");
    } catch (err) {

    }
    series_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        click: function (event, ui) {
            $('#series_var_val_y1_date_period_start_' + (last_index + 1)).empty();
            $('#series_var_val_y1_date_period_end_' + (last_index + 1)).empty();

            if (ui.value == "fcst_init_beg" || ui.value == "fcst_valid_beg" || ui.value == "fcst_valid" || ui.value == "fcst_init") {
                $("#series_var_val_y1_date_period_button_" + (last_index + 1)).css("display", "block");
            } else {
                $("#series_var_val_y1_date_period_button_" + (last_index + 1)).css("display", "none");
            }
            var id_array = this.id.split("_");
            updateSeriesVarValHist(id_array[id_array.length - 1], []);
        }
    });
    var_val_date_period_button.button({
        icons: {
            primary: "ui-icon-check",
            secondary: "ui-icon-circlesmall-plus"
        },
        text: false
    }).click(function () {
        $("#series_var_val_y1_date_period_" + (last_index + 1)).dialog("open");
    });
}

function addSeriesVar(y_axis) {
    var last_index;
    if (y_axis == 'y1') {
        if (series_var_y1_indexes.length > 0) {
            last_index = series_var_y1_indexes[series_var_y1_indexes.length - 1];
        } else {
            last_index = 0;
        }
        series_var_y1_indexes.push(last_index + 1);
    } else {
        if (series_var_y2_indexes.length > 0) {
            last_index = series_var_y2_indexes[series_var_y2_indexes.length - 1];
        } else {
            last_index = 0;
        }
        series_var_y2_indexes.push(last_index + 1);
    }
    var series_var, remove_var, series_var_val, group_series_var, group_series_var_label, var_val_date_period_button,
        dialog;
    if (last_index == 0) {
        $('#series_var_table_' + y_axis).css("display", "");
        series_var = $("#series_var_" + y_axis + "_" + (last_index + 1));
        $("#remove_series_var_" + y_axis + "_" + (last_index + 1)).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeSeriesVar($(this).attr('id'));
        });
        series_var_val = $("#series_var_val_" + y_axis + "_" + (last_index + 1));
        var_val_date_period_button = $("#series_var_val_" + y_axis + "_date_period_button_" + (last_index + 1));
        dialog = $("#series_var_val_" + y_axis + "_date_period_" + (last_index + 1));


    } else {
        series_var = $("#series_var_" + y_axis + "_" + last_index).clone(false);
        series_var.attr("id", 'series_var_' + y_axis + "_" + (last_index + 1));
        series_var.css("display", '');
    }

    if (last_index > 0) {
        remove_var = $("#remove_series_var_" + y_axis + "_" + last_index).button("enable").clone(true)
            .attr("id", 'remove_series_var_' + y_axis + "_" + (last_index + 1));

        series_var_val = $("#series_var_val_" + y_axis + "_" + last_index).clone(false);
        series_var_val.attr("id", 'series_var_val_' + y_axis + "_" + (last_index + 1));
        series_var_val.css("display", '');

        group_series_var = $("#group_series_var_" + y_axis + "_" + last_index).clone(false);
        group_series_var.attr("id", 'group_series_var_' + y_axis + "_" + (last_index + 1)).prop('checked', false);
        group_series_var.click(function () {
            updateSeries();
        });
        group_series_var_label = $('<label for="' + 'group_series_var_' + y_axis + "_" + (last_index + 1) + '">Group_' + y_axis + '_' + (last_index + 1) + '</label>');
        var_val_date_period_button = $("<button>", {
            text: 'Select multiple options',
            id: 'series_var_val_' + y_axis + '_date_period_button_' + (last_index + 1)
        }).css('display', 'none');
        dialog = $("#series_var_val_" + y_axis + "_date_period_" + (last_index)).clone(false).appendTo("body");
        dialog.prop("id", "series_var_val_" + y_axis + "_date_period_" + (last_index + 1));
        dialog.find("#series_var_val_" + y_axis + "_date_period_start_" + (last_index)).prop('id', 'series_var_val_' + y_axis + '_date_period_start_' + (last_index + 1));
        dialog.find("#series_var_val_" + y_axis + "_date_period_end_" + (last_index)).prop('id', 'series_var_val_' + y_axis + '_date_period_end_' + (last_index + 1));
        dialog.find("#series_var_val_" + y_axis + "_date_period_by_" + (last_index)).prop('id', 'series_var_val_' + y_axis + '_date_period_by_' + (last_index + 1));
        dialog.find("#series_var_val_" + y_axis + "_date_period_by_unit_" + (last_index)).prop('id', 'series_var_val_' + y_axis + '_date_period_by_unit_' + (last_index + 1));
        $('body').append(dialog);

        $('#series_var_table_' + y_axis).append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(series_var)).append($('<td>').append(series_var_val)).append($('<td>').append(var_val_date_period_button)).append($('<td>').append(group_series_var).append(group_series_var_label)));
    }
    createValDatePeriodDialog("series_var_val_" + y_axis, (last_index + 1));

    series_var_val.multiselect({
        selectedList: 100, // 0-based index
        noneSelectedText: "Select value",
        click: function () {
            updateSeries();
        },
        checkAll: function () {
            updateSeries(true);
        },
        uncheckAll: function () {
            updateSeries();
        }
    });
    try {
        series_var_val.multiselect("uncheckAll");
    } catch (err) {
    }
    series_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        click: function (event, ui) {
            $('#series_var_val_' + y_axis + '_date_period_start_' + (last_index + 1)).empty();
            $('#series_var_val_' + y_axis + '_date_period_end_' + (last_index + 1)).empty();

            if (ui.value == "fcst_init_beg" || ui.value == "fcst_valid_beg" || ui.value == "fcst_valid" || ui.value == "fcst_init") {
                $("#series_var_val_" + y_axis + "_date_period_button_" + (last_index + 1)).css("display", "block");
                $("#series_var_val_" + y_axis + "_date_range_button_" + (last_index + 1)).css("display", "block");
            } else {
                $("#series_var_val_" + y_axis + "_date_period_button_" + (last_index + 1)).css("display", "none");
                $("#series_var_val_" + y_axis + "_date_range_button_" + (last_index + 1)).css("display", "none");
            }
            var id_array = this.id.split("_");
            updateSeriesVarVal(id_array[id_array.length - 2], id_array[id_array.length - 1], []);
        }
    });
    var_val_date_period_button.button({
        icons: {
            primary: "ui-icon-check",
            secondary: "ui-icon-circlesmall-plus"
        },
        text: false
    }).click(function () {
        $("#series_var_val_" + y_axis + "_date_period_" + (last_index + 1)).dialog("open");
    });
}


function removeFcstVar(id) {
    var id_array = id.split("_");
    var index = id_array[id_array.length - 1];
    var y_axis = id_array[id_array.length - 2];
    var index_of_removing_el;
    //destroy selects
    $("#fcst_var_" + y_axis + "_" + index).multiselect("destroy");
    $("#fcst_stat_" + y_axis + "_" + index).multiselect("destroy");

    if (y_axis == 'y1') {
        index_of_removing_el = jQuery.inArray(parseInt(index), fcst_var_y1_indexes);
        if (index_of_removing_el > -1) {
            fcst_var_y1_indexes.splice(index_of_removing_el, 1);
        }
        if (fcst_var_y1_indexes.length == 1) {
            $("#remove_fcst_var_" + y_axis + "_" + (fcst_var_y1_indexes[0])).button("disable");
        }
        if (fcst_var_y1_indexes.length > 0) {
            $("#fcst_var_" + y_axis + "_" + index).parent().parent().remove();
        } else {
            $('#dependent_var_table_' + y_axis).css("display", "none");
        }
    } else {
        index_of_removing_el = jQuery.inArray(parseInt(index), fcst_var_y2_indexes);
        if (index_of_removing_el > -1) {
            fcst_var_y2_indexes.splice(index_of_removing_el, 1);
        }

        if (fcst_var_y2_indexes.length > 0) {
            $("#fcst_var_" + y_axis + "_" + index).parent().parent().remove();
        } else {
            $('#dependent_var_table_' + y_axis).css("display", "none");
        }
    }
    updateSeries();
}

function addFcstVar(y_axis) {
    var last_index;
    var selected_mode = $("#plot_data").multiselect("getChecked").val();
    if (y_axis == 'y1') {
        if (fcst_var_y1_indexes.length > 0) {
            last_index = fcst_var_y1_indexes[fcst_var_y1_indexes.length - 1];
        } else {
            last_index = 0;
        }
        fcst_var_y1_indexes.push(last_index + 1);
    } else {
        if (fcst_var_y2_indexes.length > 0) {
            last_index = fcst_var_y2_indexes[fcst_var_y2_indexes.length - 1];
        } else {
            last_index = 0;
        }
        fcst_var_y2_indexes.push(last_index + 1);
    }

    var fcst_var, remove_var, fcst_stat, fcst_stat_mode, fcst_stat_mode_config;
    if (last_index == 0) {
        $('#dependent_var_table_' + y_axis).css("display", "");
        fcst_var = $("#fcst_var_" + y_axis + "_" + (last_index + 1));
        $("#remove_fcst_var_" + y_axis + "_" + (last_index + 1)).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        }).click(function () {
            removeFcstVar($(this).attr('id'));
        });
        fcst_stat = $("#fcst_stat_" + y_axis + "_" + (last_index + 1));
        fcst_stat_mode = $("#fcst_stat_mode_" + y_axis + "_" + last_index);


    } else {
        fcst_var = $("#fcst_var_" + y_axis + "_" + last_index).clone(false);
        fcst_var.attr("id", 'fcst_var_' + y_axis + "_" + (last_index + 1));
        fcst_var.css("display", '');
    }

    if (last_index > 0) {
        remove_var = $("#remove_fcst_var_" + y_axis + "_" + last_index).button("enable").clone(true)
            .attr("id", 'remove_fcst_var_' + y_axis + "_" + (last_index + 1));

        fcst_stat = $("#fcst_stat_" + y_axis + "_" + last_index).clone(false);
        fcst_stat.attr("id", 'fcst_stat_' + y_axis + "_" + (last_index + 1));
        fcst_stat.css("display", '');

        fcst_stat_mode = $("#fcst_stat_mode_" + y_axis + "_" + last_index).clone(false);
        fcst_stat_mode.attr("id", 'fcst_stat_mode_' + y_axis + "_" + (last_index + 1));
        fcst_stat_mode_config = $("#fcst_stat_mode_config_" + y_axis + "_" + last_index).clone(true);
        fcst_stat_mode_config.attr("id", 'fcst_stat_mode_config_' + y_axis + "_" + (last_index + 1));
        fcst_stat_mode_config.css("display", 'none');

        $('#dependent_var_table_' + y_axis).append($('<tr>').append($('<td>').append(remove_var)).append($('<td>').append(fcst_var)).append($('<td>').append(fcst_stat).append('<br/>').append(fcst_stat_mode)).append($('<td>').append(fcst_stat_mode_config)));
    }
    fcst_var.multiselect({
        multiple: false,
        selectedList: 1,
        header: false,
        minWidth: 'auto',
        height: 200,
        click: function () {
            var id_array = this.id.split("_");
            updateStats(id_array[id_array.length - 2], id_array[id_array.length - 1], []);
            var selectedSeriesVarVal;
            try {
                selectedSeriesVarVal = $("#series_var_val_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]).multiselect("getChecked").val();
            } catch (err) {
                selectedSeriesVarVal = $("#series_var_val_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1] + ' option:first-child').val();
            }

            if (selectedSeriesVarVal == null) {
                selectedSeriesVarVal = [];
            }
            updateSeriesVarVal(id_array[id_array.length - 2], id_array[id_array.length - 1], selectedSeriesVarVal);
        }
    });
    if (selected_mode == "stat") {
        fcst_stat.multiselect({
            selectedList: 100, // 0-based index
            noneSelectedText: "Select attribute stat",
            click: function (event, ui) {
                updateSeries();
            },
            position: {
                my: 'right center',
                at: 'right center'
            },
            checkAll: function () {

                updateSeries();
            },
            uncheckAll: function () {
                updateSeries();
            }
        });

    } else {

        fcst_stat.multiselect({
            selectedList: 100, // 0-based index
            noneSelectedText: "Select ratio stat",
            position: {
                my: 'right center',
                at: 'right center'
            },
            click: function (event, ui) {
                var id_array = this.id.split("_");
                $("#fcst_stat_mode_config_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]).css("display", "none");
                try {
                    $("#fcst_stat_mode_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]).multiselect("uncheckAll");
                } catch (err) {
                    console.log("Error " + err);
                }
                $("input[name=statistics][value=aggregation_statistics]").prop('checked', true);
                $('#agg_stat').val('mode');
                try {
                    $('#agg_stat').multiselect('refresh');
                } catch (e) {
                }
                $('#aggregation_statistics').show();
                $('#calculations_statistics').hide();
                $('#revision_statistics').hide();
                updateSeries();
            },
            checkAll: function () {
                updateSeries();
            },
            uncheckAll: function () {
                updateSeries();
            }
        });
        if ($("#fcst_var_" + y_axis + "_" + (last_index + 1)).multiselect("getChecked").val() == "N/A") {
            fcst_stat.multiselect("disable");
        } else {
            fcst_stat.multiselect("enable");
        }
        fcst_stat_mode.multiselect({
            multiple: false,
            selectedList: 1,
            header: false,
            minWidth: 225,
            height: 300,
            noneSelectedText: "Select attribute stat",
            allUnselected: true,
            position: {
                my: 'right center',
                at: 'right center'

            },
            click: function (event, ui) {
                var id_array = this.id.split("_");
                try {
                    $("#fcst_stat_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]).multiselect("uncheckAll");
                } catch (err) {

                }
                var config_table = $("#fcst_stat_mode_config_" + id_array[id_array.length - 2] + "_" + id_array[id_array.length - 1]);
                config_table.css("display", "block");
                if (ui.value == "ACOV") {
                    config_table.find(".non-acov").attr("disabled", true);
                } else {
                    config_table.find(".non-acov").removeAttr("disabled");
                }
                if (listStatModePair.indexOf(ui.value) > -1) {
                    config_table.find(".non-pair").attr("disabled", true);
                } else {
                    config_table.find(".non-pair").removeAttr("disabled");
                }
                $("input[name=statistics][value=calculations_statistics]").prop('checked', true);
                $('#calc_stat').val('none');
                try {
                    $('#calc_stat').multiselect('refresh');
                } catch (e) {
                }
                $('#aggregation_statistics').hide();
                $('#calculations_statistics').show();
                $('#revision_statistics').show();

                updateSeries();
            }
        });
    }
}

function loadXMLStatistics(fcst_stat) {
    if (initXML.find("plot").find("agg_stat").length > 0) {
        $("input[name=statistics][value=aggregation_statistics]").prop('checked', true);
        $('#calculations_statistics').hide();
        $('#revision_statistics').hide();
        $('#aggregation_statistics').show();

        if ($(initXML.find("plot").find("agg_stat").find("agg_ctc")).text() === "TRUE") {
            $('#agg_stat').val('ctc');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_sl1l2")).text() === "TRUE") {
            $('#agg_stat').val('sl1l2');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_grad")).text() === "TRUE") {
            $('#agg_stat').val('grad');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_sal1l2")).text() === "TRUE") {
            $('#agg_stat').val('sal1l2');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_pct")).text() === "TRUE") {
            $('#agg_stat').val('pct');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_nbrcnt")).text() === "TRUE") {
            $('#agg_stat').val('nbrcnt');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_ssvar")).text() === "TRUE") {
            $('#agg_stat').val('ssvar');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_vl1l2")).text() === "TRUE") {
            $('#agg_stat').val('vl1l2');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_val1l2")).text() === "TRUE") {
            $('#agg_stat').val('val1l2');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_ecnt")).text() === "TRUE") {
            $('#agg_stat').val('ecnt');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_rps")).text() === "TRUE") {
            $('#agg_stat').val('rps');
        } else if ($(initXML.find("plot").find("agg_stat").find("agg_mctc")).text() === "TRUE") {
            $('#agg_stat').val('mctc');
        } else {
            if (selected_mode === "mode" && listStatModeRatio.indexOf(fcst_stat[0]) !== -1) {
                $('#agg_stat').val('mode');
            }
        }
        try {
            $('#agg_stat').multiselect('refresh');
        } catch (e) {
        }
        $("#boot_repl").val($(initXML.find("plot").find("agg_stat").find("boot_repl")).text());
        var seed = $(initXML.find("plot").find("agg_stat").find("boot_random_seed")).text();
        if (Number.isInteger(parseInt(seed))) {
            $("#boot_random_seed").val(seed);
        } else {
            $("#boot_random_seed").val("");
        }
        $("#boot_ci").val($(initXML.find("plot").find("agg_stat").find("boot_ci")).text());
        $('#cacheAggStat').prop('checked', $(initXML.find("plot").find("agg_stat").find("cache_agg_stat")).text() == "TRUE");
        $("#is_cbb").prop('checked', $(initXML.find("plot").find("circular_block_bootstrap")).text() == "true");

    } else if (initXML.find("plot").find("calc_stat").length > 0) {
        $("input[name=statistics][value=calculations_statistics]").prop('checked', true);
        $('#calculations_statistics').show();
        $('#aggregation_statistics').hide();
        $('#revision_statistics').hide();
        if ($(initXML.find("plot").find("calc_stat").find("calc_ctc")).text() == "TRUE") {
            $('#calc_stat').val('ctc');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_sl1l2")).text() == "TRUE") {
            $('#calc_stat').val('sl1l2');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_grad")).text() == "TRUE") {
            $('#calc_stat').val('grad');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_sal1l2")).text() == "TRUE") {
            $('#calc_stat').val('sal1l2');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_vl1l2")).text() == "TRUE") {
            $('#calc_stat').val('vl1l2');
        }
        try {
            $('#calc_stat').multiselect('refresh');
        } catch (e) {
        }
    } else if (initXML.find("plot").find("revis_stat").length > 0) {
        $("input[name=statistics][value=revision_statistics]").prop('checked', true);
        $('#calculations_statistics').hide();
        $('#aggregation_statistics').hide();
        $('#revision_statistics').show();
        if ($(initXML.find("plot").find("revis_stat").find("calc_ctc")).text() == "TRUE") {
            $('#revis_stat').val('ctc');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_sl1l2")).text() == "TRUE") {
            $('#revis_stat').val('sl1l2');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_grad")).text() == "TRUE") {
            $('#revis_stat').val('grad');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_sal1l2")).text() == "TRUE") {
            $('#revis_stat').val('sal1l2');
        } else if ($(initXML.find("plot").find("calc_stat").find("calc_vl1l2")).text() == "TRUE") {
            $('#revis_stat').val('vl1l2');
        }
        try {
            $('#revis_stat').multiselect('refresh');
        } catch (e) {
        }
        $('#revision_ac').prop('checked', $(initXML.find("plot").find("revis_stat").find("revision_ac")).text() == "TRUE");
        $('#revision_run').prop('checked', $(initXML.find("plot").find("revis_stat").find("revision_run")).text() == "TRUE");
    } else {
        if (typeof selected_mode === 'undefined' || selected_mode === "stat") {
            $("input[name=statistics][value=calculations_statistics]").prop('checked', true);
            $('#aggregation_statistics ').hide();
            $('#none').show();
        } else {
            if (listStatModeRatio.indexOf(fcst_stat[0]) !== -1) {
                $("input[name=statistics][value=aggregation_statistics]").prop('checked', true);
                $('#agg_stat').val('mode');
                try {
                    $('#agg_stat').multiselect('refresh');
                } catch (e) {
                }
                $('#aggregation_statistics').show();
                $('#calculations_statistics').hide();
                $('#revision_statistics').hide();
            } else {
                $("input[name=statistics][value=calculations_statistics]").prop('checked', true);
                $('#aggregation_statistics ').hide();
                $('#none').show();
            }

        }

    }
}


function loadXMLEclv() {
    var series_var_val;
    if (initXML.find("plot").find("series1").children().length > 0) {
        var series_arr = initXML.find("plot").find("series1").children();
        for (var i = 0; i < series_arr.length; i++) {
            series_var_val = [];
            addSeriesVarHist();

            var value = $(series_arr[i]).attr('name');
            try {
                $("#series_var_y1_" + (i + 1)).val(value).multiselect("refresh");
            } catch (err) {
            }
            $(series_arr[i]).find("val").each(function () {
                series_var_val.push($(this).text());
            });
            if (value === "fcst_init_beg" || value === "fcst_valid_beg" || value === "fcst_valid" || value === "fcst_init") {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "block");
            } else {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "none");
            }
            updateSeriesVarValHist((i + 1), series_var_val);

        }
    } else {
        series_var_val = $("#series_var_y1_1").first().val();
        updateSeriesVarValHist(1, series_var_val);
    }
    try {
        $("#plot_stat").val(initXML.find("plot").find("plot_stat").text()).multiselect("refresh");
    } catch (e) {
    }
    loadXMLStatistics();
    updatePlotFix();
}

function loadXMLRoc() {
    var series_var_val;
    $("#event_equal").prop('checked', $(initXML.find("plot").find("event_equal")).text() == "true").trigger("change");

    if (initXML.find("plot").find("series1").children().length > 0) {
        var series_arr = initXML.find("plot").find("series1").children();
        for (var i = 0; i < series_arr.length; i++) {

            series_var_val = [];

            var value = $(series_arr[i]).attr('name');
            try {
                $("#series_var_y1_" + (i + 1)).val(value).multiselect("refresh");
            } catch (err) {
            }
            $(series_arr[i]).find("val").each(function () {
                series_var_val.push($(this).text());
            });
            if (value === "fcst_init_beg" || value === "fcst_valid_beg" || value === "fcst_valid" || value === "fcst_init") {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "block");
            } else {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "none");
            }
            updateSeriesVarValHist((i + 1), series_var_val);

            if (i === 0){
                $("#series_var_val_y1_1").multiselect({
                    selectedList: 100, // 0-based index
                    noneSelectedText: "Select value",
                    click: function () {
                        updateSeriesHist();
                    },
                    checkAll: function () {
                        updateSeriesHist();
                    },
                    uncheckAll: function () {
                        updateSeriesHist();
                    }
                });
                $("#series_var_y1_1").multiselect({
                    multiple: false,
                    selectedList: 1,
                    header: false,
                    minWidth: 'auto',
                    click: function (event, ui) {
                        $('#series_var_val_y1_date_period_start_' + (last_index + 1)).empty();
                        $('#series_var_val_y1_date_period_end_' + (last_index + 1)).empty();

                        if (ui.value == "fcst_init_beg" || ui.value == "fcst_valid_beg" || ui.value == "fcst_valid" || ui.value == "fcst_init") {
                            $("#series_var_val_y1_date_period_button_1").css("display", "block");
                        } else {
                            $("#series_var_val_y1_date_period_button_1").css("display", "none");
                        }
                        var id_array = this.id.split("_");
                        updateSeriesVarValHist(id_array[id_array.length - 1], []);
                    }
                });
                $("#series_var_val_y1_date_period_button_1").button({
                    icons: {
                        primary: "ui-icon-check",
                        secondary: "ui-icon-circlesmall-plus"
                    },
                    text: false
                }).click(function () {
                    $("#series_var_val_y1_date_period_1").dialog("open");
                });
            }

            if (i<series_arr.length-1) {
                addSeriesVarHist();
            }


        }
    } else {
        series_var_val = $("#series_var_y1_1").first().val();
        updateSeriesVarValHist(1, []);
    }
    updatePlotFix();
    var roc_pct = $(initXML.find("plot").find("roc_calc").find("roc_pct")).text();
    var roc_ctc = $(initXML.find("plot").find("roc_calc").find("roc_ctc")).text();
    $("input[name=roc_type][value=pct]").prop('checked', roc_pct == "TRUE");
    $("input[name=roc_type][value=ctc]").prop('checked', roc_ctc == "TRUE");
    $('#roc_type').buttonset('refresh');


    if (initXML.find("plot").find("summary_curve") && initXML.find("plot").find("summary_curve").children().length > 0) {
        var stats = initXML.find("plot").find("summary_curve").children();
        for (var i = 0; i < stats.length; i++) {
            $("#summary_curve option[value='" + stats[i] + "']").prop('selected', true);
        }
        try {
            $("#summary_curve").multiselect("refresh");
        } catch (err) {
        }
    }
    var is_check = true;
    if (initXML.find("plot").find("add_point_thresholds")) {
        is_check = initXML.find("plot").find("add_point_thresholds").text();
    }
    if (is_check === 'true') {
        $('#add_point_thresholds').prop('checked', true);
    } else {
        $('#add_point_thresholds').prop('checked', false);
    }

}

function loadXMLHist() {
    var series_var_val;
    var type = $(initXML.find("plot").find("template")).text();
    if (type === 'rhist.R_tmpl') {
        $("input[name=hist_line_type][value=rhist]").prop('checked', true);
        changeFixedVarHist('rhist');
    } else if (type === 'phist.R_tmpl') {
        $("input[name=hist_line_type][value=phist]").prop('checked', true);
        changeFixedVarHist('phist');
    } else if (type === 'relp.R_tmpl') {
        $("input[name=hist_line_type][value=relp]").prop('checked', true);
        changeFixedVarHist('relp');
    }
    if (initXML.find("plot").find("series1").children().length > 0) {
        var series_arr = initXML.find("plot").find("series1").children();

        for (var i = 0; i < series_arr.length; i++) {
            series_var_val = [];
            addSeriesVarHist();
            var value = $(series_arr[i]).attr('name');
            try {
                $("#series_var_y1_" + (i + 1)).val(value).multiselect("refresh");
            } catch (err) {
            }
            $(series_arr[i]).find("val").each(function () {
                var vals = $(this).text().match(/\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}/g);
                if (!vals  || vals.length === 0){
                    vals = $(this).text().split(":");
                }
                for (var k = 0; k < vals.length; k++) {
                    series_var_val.push(vals[k]);
                }
            });
            if (value == "fcst_init_beg" || value == "fcst_valid_beg" || value == "fcst_valid" || value == "fcst_init") {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "block");
            } else {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "none");
            }
            updateSeriesVarValHist((i + 1), series_var_val);

        }
    } else {
        series_var_val = $("#series_var_1" + "_1").first().val();
        updateSeriesVarValHist(1, series_var_val);
    }
    updatePlotFix();
    $("input[name=normalized_histogram][value=" + $(initXML.find("plot").find("normalized_histogram")).text() + "]").prop('checked', true);


}

function loadXMLRely() {
    var series_var_val;
    if (initXML.find("plot").find("series1").children().length > 0) {
        var series_arr = initXML.find("plot").find("series1").children();
        for (var i = 0; i < series_arr.length; i++) {
            series_var_val = [];
            addSeriesVarHist();

            var value = $(series_arr[i]).attr('name');
            try {
                $("#series_var_y1_" + (i + 1)).val(value).multiselect("refresh");
            } catch (err) {
            }
            $(series_arr[i]).find("val").each(function () {
                series_var_val.push($(this).text());
            });
            if (value == "fcst_init_beg" || value == "fcst_valid_beg" || value == "fcst_valid" || value == "fcst_init") {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "block");
            } else {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "none");
            }
            updateSeriesVarValHist((i + 1), series_var_val);

        }
    } else {
        //series_var_val = $("#series_var_y1_1").first().val();
        updateSeriesVarValHist(1, []);
    }

    updatePlotFix();


    
    if (initXML.find("plot").find("summary_curve") && initXML.find("plot").find("summary_curve").children().length > 0) {
        var stats = initXML.find("plot").find("summary_curve").children();
        for (var i = 0; i < stats.length; i++) {
            $("#summary_curve option[value='" + stats[i] + "']").prop('selected', true);
        }
        try {
            $("#summary_curve").multiselect("refresh");
        } catch (err) {
        }
    }
    var is_check = true;
    is_check = $(initXML.find("plot").find("rely_event_hist")).text();
    if (is_check === 'TRUE' || is_check === 'true') {
        $('#rely_event_hist').prop('checked', true);
    } else {
        $('#rely_event_hist').prop('checked', false);
    }
    if (initXML.find("plot").find("add_skill_line")) {
        is_check = $(initXML.find("plot").find("add_skill_line")).text();
        if (is_check === 'true') {
            $('#add_skill_line').prop('checked', true);
        } else {
            $('#add_skill_line').prop('checked', false);
        }
    }
    if (initXML.find("plot").find("inset_hist")) {
        is_check = $(initXML.find("plot").find("inset_hist")).text();
        if (is_check === 'true') {
            $('#inset_hist').prop('checked', true);
        } else {
            $('#inset_hist').prop('checked', false);
        }
    }
    if (initXML.find("plot").find("add_noskill_line")) {
        is_check = $(initXML.find("plot").find("add_noskill_line")).text();
        if (is_check === 'true') {
            $('#add_noskill_line').prop('checked', true);
        } else {
            $('#add_noskill_line').prop('checked', false);
        }
    }
    if (initXML.find("plot").find("add_reference_line")) {
        is_check = $(initXML.find("plot").find("add_reference_line")).text();
        if (is_check === 'true') {
            $('#add_reference_line').prop('checked', true);
        } else {
            $('#add_reference_line').prop('checked', false);
        }
    }
    loadXMLStatistics();
}

function loadXMLEns() {
    var series_var_val;
    if (initXML.find("plot").find("series1").children().length > 0) {
        var series_arr = initXML.find("plot").find("series1").children();
        for (var i = 0; i < series_arr.length; i++) {
            series_var_val = [];
            if (i != 0) {
                addSeriesVarEns();
            }
            var value = $(series_arr[i]).attr('name');
            try {
                $("#series_var_y1_" + (i + 1)).val(value).multiselect("refresh");
            } catch (err) {
            }
            $(series_arr[i]).find("val").each(function () {
                series_var_val.push($(this).text());
            });
            if (value == "fcst_init_beg" || value == "fcst_valid_beg" || value == "fcst_valid" || value == "fcst_init") {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "block");
            } else {
                $("#series_var_val_y1_date_period_button_" + (i + 1)).css("display", "none");
            }
            updateSeriesVarValEns((i + 1), series_var_val);
        }
    } else {
        series_var_val = $("#series_var_y1_1").first().val();
        updateSeriesVarValEns(1, series_var_val);
    }

    updatePlotFix();
    var ensss_pts = $(initXML.find("plot").find("ensss_pts")).text();
    $("#ensss_pts").val(ensss_pts);

    var ensss_pts_disp = $(initXML.find("plot").find("ensss_pts_disp")).text();
    $("input[name=ensss_pts_disp][value=true]").prop('checked', ensss_pts_disp == "TRUE" || ensss_pts_disp == "true");
    $("input[name=ensss_pts_disp][value=false]").prop('checked', ensss_pts_disp == "FALSE" || ensss_pts_disp == "false");

    updateSeriesEns();
}

function updatePlotFix() {
    if ($(initXML.find("plot").find("plot_fix")).children().length > 0) {
        var plot_fix_arr = $(initXML.find("plot").find("plot_fix")).children();
        for (var i = 0; i < plot_fix_arr.length; i++) {
            var fixed_var_vals = [];
            var equalize = $(plot_fix_arr[i]).attr('equalize');
            if (i > 0) {
                addFixedVarHist();
            }
            var value = $(plot_fix_arr[i]).attr('name');
            try {
                $("#fixed_var_" + (i + 1)).val(value).multiselect("refresh");
            } catch (e) {
            }

            $(plot_fix_arr[i]).find("set").find("val").each(function () {
                fixed_var_vals.push($(this).text());
            });
            if (value === "fcst_init_beg" || value === "fcst_valid_beg" || value === "fcst_valid" || value === "fcst_init") {
                $("#fixed_var_val_date_period_button_" + (i + 1)).css("display", "block");
            } else {
                $("#fixed_var_val_date_period_button_" + (i + 1)).css("display", "none");
            }
            updateFixedVarValHist((i + 1), fixed_var_vals, equalize);
        }

    }
}

function updatePlotFixSeries() {
    if ($(initXML.find("plot").find("plot_fix")).children().length > 0) {
        var plot_fix_arr = $(initXML.find("plot").find("plot_fix")).children();
        for (var i = 0; i < plot_fix_arr.length; i++) {
            var fixed_var_vals = [];
            var equalize = $(plot_fix_arr[i]).attr('equalize');
            addFixedVar();
            var value = $(plot_fix_arr[i]).attr('name');
            try {
                $("#fixed_var_" + (i + 1)).val(value).multiselect("refresh");
            } catch (e) {
            }

            $(plot_fix_arr[i]).find("set").find("val").each(function () {
                fixed_var_vals.push($(this).text());
            });
            if (value === "fcst_init_beg" || value === "fcst_valid_beg" || value === "fcst_valid" || value === "fcst_init") {
                $("#fixed_var_val_date_period_button_" + (i + 1)).css("display", "block");
                $("#fixed_var_val_date_range_button_" + (i + 1)).css("display", "block");
            } else {
                $("#fixed_var_val_date_period_button_" + (i + 1)).css("display", "none");
                $("#fixed_var_val_date_range_button_" + (i + 1)).css("display", "none");
            }
            updateFixedVarVal((i + 1), fixed_var_vals, equalize);
        }

    }
}


function loadXMLSeries() {

    //Parse the plot_type from _strInitXML using assumptions about the first stat
    $("#event_equal").prop('checked', $(initXML.find("plot").find("event_equal")).text() == "true").trigger("change");

    var stat = $(initXML.find("plot").find("dep").find("dep1").find("stat")[0]).text();
    var selected_mode;
    if (isModeStat(stat)) {
        selected_mode = "mode";
    } else if (isMtdStat(stat)) {
        selected_mode = "mtd";
    } else {
        selected_mode = "stat";
    }
    updateIndyVar(selected_mode);
    try {
        $("#plot_data").val(selected_mode).multiselect("refresh");
    } catch (e) {
    }
    updateForecastVariables();
    updateFixVar(selected_mode);

    try {
        $("#plot_stat").val(initXML.find("plot").find("plot_stat").text()).multiselect("refresh");
    } catch (e) {
    }

    var value, number_of_axis;
    if (currentTab === 'Perf' || currentTab === 'Taylor' || currentTab === 'Contour') {
        number_of_axis = 1
    } else {
        number_of_axis = 2;
    }
    var fcst_stat;
    for (var y_axis_index = 1; y_axis_index <= number_of_axis; y_axis_index++) {
        var y_axis = "y" + y_axis_index;
        var index = 0;

        if (initXML.find("plot").find("dep").find("dep" + y_axis_index).children().length > 0) {
            var dep_arr = initXML.find("plot").find("dep").find("dep" + y_axis_index).children();
            for (var i = 0; i < dep_arr.length; i++) {
                fcst_stat = [];
                value = $(dep_arr[i]).attr('name');
                if (index === 0 && y_axis_index === 1) {
                    try {
                        $("#fcst_var_" + y_axis + "_" + (index + 1)).val(value).multiselect("refresh");
                    } catch (e) {
                    }
                } else {
                    addFcstVar(y_axis);
                    try {
                        $("#fcst_var_" + y_axis + "_" + (index + 1)).val(value).multiselect("refresh");
                    } catch (e) {
                    }
                }
                $(dep_arr[i]).find("stat").each(function () {
                    fcst_stat.push($(this).text());
                });


                if (selected_mode === 'stat') {
                    updateStats(y_axis, index + 1, fcst_stat);
                    index++;
                } else {
                    if ($.isArray(fcst_stat)) {
                        for (var fcst_stat_ind = 0; fcst_stat_ind < fcst_stat.length; fcst_stat_ind++) {
                            if (fcst_stat_ind > 0) {
                                addFcstVar(y_axis);
                                try {
                                    $("#fcst_var_" + y_axis + "_" + (index + 1)).val($(dep_arr[i]).attr('name')).multiselect("refresh");
                                } catch (e) {
                                }
                            }
                            if (selected_mode === 'mode') {
                                updateMode(y_axis, index + 1, fcst_stat[fcst_stat_ind]);
                            } else {
                                updateMtd(y_axis, index + 1, fcst_stat[fcst_stat_ind]);
                            }
                            index++;
                        }
                    } else {
                        if (selected_mode === 'mode') {
                            updateMode(y_axis, index + 1, fcst_stat);
                        } else {
                            updateMtd(y_axis, index + 1, fcst_stat);
                        }
                        index++;
                    }
                }
            }
        } else {
            if (selected_mode === 'stat') {
                updateStats(y_axis, 1, "");
            } else if (selected_mode === 'mode') {
                updateMode(y_axis, 1, "");
            } else {
                updateMtd(y_axis, 1, "");
            }
        }
        var series_var_val, isGroup;
        if (initXML.find("plot").find("series" + y_axis_index).children().length > 0) {
            var series_arr = initXML.find("plot").find("series" + y_axis_index).children();

            for (var i = 0; i < series_arr.length; i++) {
                series_var_val = [];
                isGroup = false;
                value = $(series_arr[i]).attr('name');
                if (i === 0 && y_axis_index === 1) {
                    try {
                        $("#series_var_" + y_axis + "_" + (i + 1)).val(value).multiselect("refresh");
                    } catch (err) {
                    }
                } else {
                    if (currentTab === 'Taylor') {
                        addSeriesVarHist();
                    } else if (currentTab === 'Perf') {
                        addSeriesVarPerf();
                    } else {
                        addSeriesVar(y_axis);
                    }
                    try {
                        $("#series_var_" + y_axis + "_" + (i + 1)).val(value).multiselect("refresh");
                    } catch (err) {
                    }
                }
                $(series_arr[i]).find("val").each(function () {
                    var vals = $(this).text().match(/\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}/g);
                    if (!vals  || vals.length === 0){
                        vals = $(this).text().split(":");
                    }
                    if (vals.length > 2) {
                        isGroup = true;
                    }
                    for (var k = 0; k < vals.length; k++) {
                        series_var_val.push(vals[k]);
                    }
                });
                if (value == "fcst_init_beg" || value == "fcst_valid_beg" || value == "fcst_valid" || value == "fcst_init") {
                    $("#series_var_val_" + y_axis + "_date_period_button_" + (i + 1)).css("display", "block");
                    $("#series_var_val_" + y_axis + "_date_range_button_" + (i + 1)).css("display", "block");
                } else {
                    $("#series_var_val_" + y_axis + "_date_period_button_" + (i + 1)).css("display", "none");
                    $("#series_var_val_" + y_axis + "_date_range_button_" + (i + 1)).css("display", "none");
                }
                updateSeriesVarVal(y_axis, (i + 1), series_var_val);
                if (isGroup === true) {
                    $('#group_series_var_' + y_axis + "_" + (i + 1)).prop('checked', true);
                }else {
                    $('#group_series_var_' + y_axis + "_" + (i + 1)).prop('checked', false);
                }
            }
        } else {
            series_var_val = $("#series_var_" + y_axis + "_1").first().val();
            updateSeriesVarVal(y_axis, 1, series_var_val);
        }
    }

    updatePlotFixSeries();
    $("#txtPlotCond").val(initXML.find("plot").find("plot_cond").text());
    try {
        $("#annotation").val(initXML.find("plot").find("annotation_template").text());
    } catch (err) {
    }
    //update indy var for mode
    if (selected_mode === 'mode') {
        updateIndyVar(selected_mode);
    }

    value = $(initXML.find("plot").find("indep")[0]).attr('name');
    try {
        $("#indy_var").val(value).multiselect("refresh");
    } catch (e) {
    }
    if (value === "fcst_init_beg" || value === "fcst_valid_beg" || value === "fcst_valid" || value === "fcst_init") {
        $("#date_period_button").css("display", "block");
        $("#date_range_button").css("display", "block");
    } else {
        $("#date_period_button").css("display", "none");
        $("#date_range_button").css("display", "none");
    }
    var indy_var_vals = [];
    indy_var_vals_to_attr = {};
    $(initXML.find("plot").find("indep")[0]).find("val").each(function () {
        indy_var_vals.push($(this).text());
        var obj = {};
        obj.label = $(this)[0].attributes.label.nodeValue;
        obj.plot_val = $(this)[0].attributes.plot_val.nodeValue;
        indy_var_vals_to_attr[$(this).text()] = obj;
    });
    if (indy_var_vals.length > 0) {
        $("#indy_var_val").multiselect("option", "indy_var_vals_to_attr", indy_var_vals_to_attr);
        populateIndyVarVal(indy_var_vals);
    }

    loadXMLStatistics(fcst_stat);


    var listdiffseries1 = $(initXML.find("plot").find("tmpl").find("listDiffSeries1")).text();
    if (listdiffseries1.length === 0) {
        listdiffseries1 = "list()";
    }

    var listdiffseries2 = $(initXML.find("plot").find("tmpl").find("listDiffSeries2")).text();
    if (listdiffseries2.length === 0) {
        listdiffseries2 = "list()";
    }
    if (listdiffseries1 !== "list()") {
        var t1 = listdiffseries1.split("c(");
        for (var i = 1; i < t1.length; i++) {
            t1[i] = t1[i].replace(/\(/g, "").replace(/\)/g, "").replace(/"/g, "");
            seriesDiffY1.push(t1[i]);
        }
    }
    if (listdiffseries2 !== "list()") {
        var t2 = listdiffseries2.split("c(");
        for (var i = 1; i < t2.length; i++) {
            t2[i] = t2[i].replace(")", "").replace(")", "").replace("\"", "");
            seriesDiffY2.push(t2[i]);
        }
    }
    if (currentTab === 'Perf') {
        updateSeriesPerf();
    } else if (currentTab === 'Taylor') {
        updateSeriesHist();
        var taylor_voc = $(initXML.find("plot").find("taylor_voc")).text().toLowerCase();
        $("input[name=taylor_voc][value=" + taylor_voc + "]").prop('checked', true);

        var taylor_show_gamma = $(initXML.find("plot").find("taylor_show_gamma")).text().toLowerCase();
        $("input[name=taylor_show_gamma][value=" + taylor_show_gamma + "]").prop('checked', true);
        if (taylor_voc === 'true') {
            $('#is_show_gamma').buttonset("enable");
        } else {
            $('#is_show_gamma').buttonset("disable");
        }
    } else {
        updateSeries();
    }


}


function loadXMLContour() {
    $("#event_equal").prop('checked', $(initXML.find("plot").find("event_equal")).text() == "true").trigger("change");
    var stat = $(initXML.find("plot").find("dep").find("dep1").find("stat")[0]).text();
    updateForecastVariables();
    try {
        $("#plot_stat").val(initXML.find("plot").find("plot_stat").text()).multiselect("refresh");
    } catch (e) {
    }

    $.each(fix_var_value_to_title_stat_map, function (key, val) {
        $('#fixed_var_1').append('<option value="' + key + '">' + val + '</option>');
    });
    var value;
    var dep_arr = initXML.find("plot").find("dep").find("dep1").children();

    var fcst_stat = [];
    value = $(dep_arr[0]).attr('name');

    try {
        $("#fcst_var_y1_1").val(value).multiselect("refresh");
    } catch (e) {
    }
    $(dep_arr[0]).find("stat").each(function () {
        fcst_stat.push($(this).text());
    });
    updateStats("y1", 1, fcst_stat);

    if (initXML.find("plot").find("series1").children().length > 0) {
        var series_arr = initXML.find("plot").find("series1").children();
        var series_var_val = [];
        value = $(series_arr[0]).attr('name');
        try {
            $("#series_var_y1_1").val(value).multiselect("refresh");
        } catch (err) {
        }
        $(series_arr[0]).find("val").each(function () {
            var vals = $(this).text().match(/\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}/g);
            if (!vals  || vals.length === 0){
                vals = $(this).text().split(":");
            }
            for (var k = 0; k < vals.length; k++) {
                series_var_val.push(vals[k]);
            }
        });
        updateYvalueCountour(series_var_val);
    }
    updatePlotFixSeries();
    $("#txtPlotCond").val(initXML.find("plot").find("plot_cond").text());
    value = $(initXML.find("plot").find("indep")[0]).attr('name');
    try {
        $("#indy_var").val(value).multiselect("refresh");
    } catch (e) {
    }
    if (value === "fcst_init_beg" || value === "fcst_valid_beg" || value === "fcst_valid" || value === "fcst_init") {
        $("#date_period_button").css("display", "block");
    } else {
        $("#date_period_button").css("display", "none");
    }
    var indy_var_vals = [];
    indy_var_vals_to_attr = {};
    $(initXML.find("plot").find("indep")[0]).find("val").each(function () {
        indy_var_vals.push($(this).text());
        var obj = {};
        obj.label = $(this)[0].attributes.label.nodeValue;
        obj.plot_val = $(this)[0].attributes.plot_val.nodeValue;
        indy_var_vals_to_attr[$(this).text()] = obj;
    });
    if (indy_var_vals.length > 0) {
        $("#indy_var_val").multiselect("option", "indy_var_vals_to_attr", indy_var_vals_to_attr);
        populateIndyVarVal(indy_var_vals);
    }

    loadXMLStatistics(fcst_stat);
    var listdiffseries1 = $(initXML.find("plot").find("tmpl").find("listDiffSeries1")).text();
    if (listdiffseries1.length === 0) {
        listdiffseries1 = "list()";
    }
    if (listdiffseries1 !== "list()") {
        var t1 = listdiffseries1.split("c(");
        for (var i = 1; i < t1.length; i++) {
            t1[i] = t1[i].replace(/\(/g, "").replace(/\)/g, "").replace(/"/g, "");
            seriesDiffY1.push(t1[i]);
        }
    }
    try {
        $("#contour_intervals").val(initXML.find("plot").find("contour_intervals").text());
    } catch (e) {
    }
    try {
        $("#color_palette").val(initXML.find("plot").find("color_palette").text());
    } catch (e) {
    }
    try {
        $("#add_color_bar").prop('checked', $(initXML.find("plot").find("add_color_bar")).text() == "true");
    } catch (e) {
    }

    try {
        $("#reverse_y").prop('checked', $(initXML.find("plot").find("reverse_y")).text() == "true");
    } catch (e) {
    }
    try {
        $("#reverse_x").prop('checked', $(initXML.find("plot").find("reverse_x")).text() == "true");
    } catch (e) {
    }
    try {
        $("#add_contour_overlay").prop('checked', $(initXML.find("plot").find("add_contour_overlay")).text() == "true");
    } catch (e) {
    }

    updateSeries();
}

function requestDBUpdate() {

    $.ajax({
        async: false,
        url: "servlet",
        type: "POST",
        dataType: 'xml',
        processData: false,
        contentType: "application/xml",
        data: '<?xml version="1.0" encoding="UTF-8"?><request><list_db_update></list_db_update></request>',
        error: function (jqXHR, textStatus, errorThrown) {

        },
        success: function (data) {
            categories = $(data).find("groups").find('group');
            try {
                $('#listdt').jqGrid('GridUnload');
            } catch (err) {

            }

            initPage();
        }
    });

}

function updateFixVar(selected_mode) {
    //remove fixed values
    var fixed_var_indexes_copy = fixed_var_indexes.slice();
    for (var i = 0; i < fixed_var_indexes_copy.length; i++) {
        removeFixedVar("fixed_var_" + fixed_var_indexes_copy[i]);
    }
    //find an id of the remaining fixed_var
    var remaining_fixed_var_id = $(".remove_fixed_var").prop("id").split("remove_fixed_var_")[1];
    try {
        $('#fixed_var_val_' + remaining_fixed_var_id).multiselect('uncheckAll');
        $('#fixed_var_val_' + remaining_fixed_var_id).multiselect('refresh');
    } catch (err) {
    }
    fixed_var_indexes.push(parseInt(remaining_fixed_var_id));
    $('#fixed_var_' + remaining_fixed_var_id).empty();
    if (currentTab === 'Perf') {
        $.each(perf_fixed_var_map, function (key, val) {
            $('#fixed_var_' + remaining_fixed_var_id).append('<option value="' + key + '">' + val + '</option>');
        });
    } else {

        if (selected_mode === "stat") {
            $.each(fix_var_value_to_title_stat_map, function (key, val) {
                $('#fixed_var_' + remaining_fixed_var_id).append('<option value="' + key + '">' + val + '</option>');
            });
        } else if (selected_mode === "mode") {
            $.each(fix_var_value_to_title_mode_map, function (key, val) {
                $('#fixed_var_' + remaining_fixed_var_id).append('<option value="' + key + '">' + val + '</option>');
            });
        } else {
            $.each(fix_var_value_to_title_mtd_map, function (key, val) {
                $('#fixed_var_' + remaining_fixed_var_id).append('<option value="' + key + '">' + val + '</option>');
            });
        }
    }
    try {
        $('#fixed_var_' + remaining_fixed_var_id).multiselect('uncheckAll');
        $('#fixed_var_' + remaining_fixed_var_id).multiselect('refresh');
    } catch (err) {
    }


}

function updateIndyVar(selected_mode) {

    $('#indy_var').empty();
    if (selected_mode === "stat") {
        $.each(indy_var_value_to_title_stat_map, function (key, val) {
            $('#indy_var').append('<option value="' + key + '">' + val + '</option>');
        });
    } else if (selected_mode === "mode") {
        $.each(indy_var_value_to_title_mode_map, function (key, val) {
            $('#indy_var').append('<option value="' + key + '">' + val + '</option>');
        });
    } else {
        $.each(indy_var_value_to_title_mtd_map, function (key, val) {
            $('#indy_var').append('<option value="' + key + '">' + val + '</option>');
        });
    }
    try {
        $('#indy_var').multiselect('refresh');
    } catch (err) {
    }
    $("#date_period").css("display", "none");

}

String.prototype.endsWith = function (suffix) {
    return this.indexOf(suffix, this.length - suffix.length) !== -1;
};

function createValDatePeriodDialog(prefix, var_index) {
    var start_el = $('#' + prefix + '_date_period_start_' + (var_index));
    var end_el = $('#' + prefix + '_date_period_end_' + (var_index));

    $("#" + prefix + "_date_period_" + (var_index)).dialog({
        width: 295,
        autoOpen: false,
        position: {
            my: "left bottom",
            at: 'left top',
            of: "#" + prefix + "_date_period_button_" + (var_index)
        },
        resizable: false,
        draggable: false,
        buttons: {
            "Select values": function () {
                if (start_el.val() && end_el.val()) {
                    var start = moment.tz(start_el.val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');//2007-08-15 12:00:00
                    var end = moment.tz(end_el.val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                    var by = $("#" + prefix + "_date_period_by_" + (var_index)).val().trim();
                    var unit = $("#" + prefix + "_date_period_by_unit_" + (var_index)).val();

                    if (by.length === 0) {
                        by = 3600;
                    }
                    by = parseFloat(by);
                    if (unit === "min") {
                        by = by * 60;
                    } else if (unit === "hours") {
                        by = by * 3600;
                    } else if (unit === "days") {
                        by = by * 86400;
                    }
                    var dates;
                    if (prefix === 'fixed_var_val') {
                        dates = $(fixVarValResponse[var_index]).find("val");
                    } else if (prefix === 'series_var_val_y1') {
                        dates = $(seriesY1VarValResponse[var_index]).find("val");
                    } else if (prefix === 'series_var_val_y2') {
                        dates = $(seriesY2VarValResponse[var_index]).find("val");
                    }
                    var current_date = start.clone();
                    while (current_date <= end) {
                        var current_date_str = current_date.format('YYYY-MM-DD HH:mm:ss');
                        var isFound = false;
                        for (var i = 0; i < dates.length; i++) {
                            if ($(dates[i]).text() == current_date_str) {
                                isFound = true;
                                break;
                            }
                        }
                        if (isFound) {
                            $("#" + prefix + "_" + (var_index)).find('option[value="' + current_date_str + '"]').prop('selected', true);
                        }
                        current_date.add(by, 'seconds');
                    }
                    try {
                        $("#" + prefix + "_" + (var_index)).multiselect("refresh");
                    } catch (err) {
                        console.log(err)
                    }
                    if (prefix !== 'fixed_var_val') {
                        if (currentTab === "Series" || currentTab === "Box" || currentTab === "Bar") {
                            updateSeries();
                        } else if (currentTab === "Roc" || currentTab === "Rely" || currentTab === "Hist" || currentTab === "Eclv") {
                            updateSeriesHist();
                        } else if (currentTab = "Ens_ss") {
                            updateSeriesEns();
                        }

                    }
                }

                $(this).dialog("close");
            }
        },
        open: function (event, ui) {
            var dates;
            if (prefix == 'fixed_var_val') {
                dates = $(fixVarValResponse[var_index]).find("val");
            } else if (prefix == 'series_var_val_y1') {
                dates = $(seriesY1VarValResponse[var_index]).find("val");
            } else if (prefix == 'series_var_val_y2') {
                dates = $(seriesY2VarValResponse[var_index]).find("val");
            }
            start_el.empty();
            end_el.empty();
            for (var i = 0; i < dates.length; i++) {
                var t = $(dates[i]);
                var option = $("<option/>")
                    .attr("value", t.text())
                    .text(t.text());
                if (t.text() == start_el.val()) {
                    option.prop("selected", true);
                }
                start_el.append(option);
                if (t.text() == end_el.val()) {
                    option.prop("selected", true);
                } else {
                    option.prop("selected", false);
                }
                end_el.append(option.clone());
            }
            end_el.find('option').last().prop('selected', true);
            if (dates.length > 1) {
                var start = moment.tz($(dates[0]).text(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                var end = moment.tz($(dates[1]).text(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                var d = moment.duration({from: start, to: end});
                $("#" + prefix + "_date_period_by_" + (var_index)).val(d.as('hours'));
            }
        }
    });


}

function createDatePeriodDialog() {
    var start_el = $('#date_period_start');
    var end_el = $('#date_period_end');
    var indy_var_val = $('#indy_var_val');
    $("#date_period_dialog").dialog({
        width: 295,
        autoOpen: false,
        position: {
            my: "left bottom",
            at: 'left top',
            of: "#date_period_button"
        },
        resizable: false,
        draggable: false,
        buttons: {
            "Select values": function () {
                if (start_el.val() && end_el.val()) {
                    var start = moment.tz(start_el.val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');//2007-08-15 12:00:00
                    var end = moment.tz(end_el.val(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                    var by = $("#date_period_by").val().trim();
                    var unit = $("#date_period_by_unit").val();

                    if (by.length === 0) {
                        by = 3600;
                    }
                    by = parseInt(by);
                    if (unit === "min") {
                        by = by * 60;
                    } else if (unit === "hours") {
                        by = by * 3600;
                    } else if (unit === "days") {
                        by = by * 86400;
                    }
                    var dates = $(previousIndVarValResponse).find("val");
                    var current_date = start.clone();
                    while (current_date <= end) {
                        var current_date_str = current_date.format('YYYY-MM-DD HH:mm:ss');
                        var isFound = false;
                        for (var i = 0; i < dates.length; i++) {
                            if ($(dates[i]).text() === current_date_str) {
                                isFound = true;
                                break;
                            }
                        }
                        if (isFound) {
                            indy_var_val.find('option[value="' + current_date_str + '"]').prop('selected', true);
                        }
                        current_date.add(by, 'seconds');
                    }
                    try {
                        indy_var_val.multiselect("refresh");
                    } catch (err) {
                    }
                }

                $(this).dialog("close");
            }
        },
        open: function (event, ui) {
            var values = indy_var_val.val();
            if (values == null) {
                values = [];
            }
            populateIndyVarVal(values);

            var dates = $(previousIndVarValResponse).find("val");
            var start_val = start_el.val();
            var end_val = end_el.val();

            start_el.empty();
            end_el.empty();
            for (var i = 0; i < dates.length; i++) {
                var t = $(dates[i]);
                var option = $("<option/>")
                    .attr("value", t.text())
                    .text(t.text());
                if (t.text() == start_val) {
                    option.prop("selected", true);
                }
                start_el.append(option);
                if (t.text() === end_val) {
                    option.prop("selected", true);
                } else {
                    option.prop("selected", false);
                }

                end_el.append(option.clone());

            }
            end_el.find('option').last().prop('selected', true);
            if (dates.length > 1) {
                var start = moment.tz($(dates[0]).text(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                var end = moment.tz($(dates[1]).text(), 'YYYY-MM-DD HH:mm:ss', 'UTC');
                var d = moment.duration({from: start, to: end});
                $("#date_period_by").val(d.as('hours'));
            }
        }
    });
}

function myelem(value, options) {
    var el = document.createElement("input");
    el.type = "text";
    el.value = value;
    el.className = "cp-basic";
    el.style.width = "60px";
    $(el).colorpicker({
        parts: ['header', 'map', 'bar', 'hex', 'rgb', 'alpha', 'preview', 'swatches', 'footer'],
        showOn: 'both',
        buttonColorize: true,
        buttonImageOnly: true
    });
    return el;
}

function myvalue(elem, operation, value) {
    if (operation === 'get') {
        return $(elem).val(); // change this to get value from color picker
    } else if (operation === 'set') {
        $('input', elem).val(value); // change this to set value of color picker
    }
}

if (typeof String.prototype.startsWith != 'function') {
    // see below for better implementation!
    String.prototype.startsWith = function (str) {
        return this.indexOf(str) === 0;
    };
}

function colorDisplayFmatter(cellvalue, options, rowObject) {
    return '<input id="color_' + rowObject.id + '" type="text" value="' + rowObject.color + '" size="8" style="background-color:' + rowObject.color + ';">';
}

function colorDisplayUnmatter(cellvalue, options, cell) {
    var colorRGB = jQuery('input', cell).css('background-color');
    var parts = colorRGB.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    // delete(parts[0]);
    parts[0] = '#';
    for (var i = 1; i <= 3; ++i) {
        parts[i] = parseInt(parts[i]).toString(16);
        if (parts[i].length === 1) parts[i] = '0' + parts[i];
    }

    return parts.join('');
}

function querySt(Key) {
    var url = window.location.href;
    var KeysValues = url.split(/[\?&]+/);
    for (var i = 0; i < KeysValues.length; i++) {
        var KeyValue = KeysValues[i].split("=");
        if (KeyValue[0] === Key) {
            return KeyValue[1];
        }
    }
}

function downloadPlot(e) {

    var inputs = '';
    inputs += '<input type="hidden" name="plot" value="' + resultName + '" />';
    inputs += '<input type="hidden" name="type" value="' + currentPlotTab + '" />';
    $('<form action="download" method="' + 'get' + '">' + inputs + '</form>').appendTo('body').submit().remove();
}

function viewImage(id) {
    boxID = boxID + 1;
    window_center = window_center + 20;
    window_top = window_top + 20;
    var d = $('<div>').dialog({
        height: '655',
        width: '815',
        autoOpen: false,
        resizable: true,
        closeOnEscape: true,
        focus: true,
        dialogClass: "dialog-box-" + boxID,
        title: id,
        position: {
            my: ("center+" + window_center + " top+" + window_top),
            at: "center top",
            of: window
        },
        close: function (e) {
            $(this).empty();
            $(this).dialog('destroy');
            window_center = window_center - 20;
            window_top = window_top - 20;
        },
        open: function (e) {
            $(this).html('<img src="' + urlOutput + 'plots/plot_' + id
                + '.png?' + (new Date()).getTime()
                + '" onError="this.src=\'images/no_image.png\';"/>');
        }

    });
    d.dialog("open");

}

function updateResult(result) {
    resultName = result;

    $('#plot_display_inner_header').text(resultName.replace("plot_", ""));

    $("#plot_image").empty();

    $.get(urlOutput + 'plots/' + resultName + '.html', function (data) {
        //var style =  $(data).find('div').attr('style');
        //var size = style.match(/\d+/g);

        //var k_h = $('#plot_image').outerHeight()/size[0];
        //var k_w = $('#plot_image').outerWidth()/size[1];
        //var k_d = 90 * k_h;

        //var new_style = "<div style=\"transform: translateY(-" + k_d + "px) scale(" + k_w + "," + k_h + " ) ; width: 100%; height: 100%;\">";
        //data = data.replace("<div>", new_style);

        $('#plot_image').append(data);

    }).fail(function () {
        var img = $('<img>');
        img.attr('width', '100%');
        img.attr('height', '100%');
        img.appendTo('#plot_image');
        img.error(function () {
            $(this).attr("src", 'images/no_image.png');
        }).attr("src", urlOutput + 'plots/' + resultName + '.png' + '?' + (new Date()).getTime());
    });

    $.ajax({
        type: "GET",
        url: urlOutput + "xml/" + resultName + ".xml",
        dataType: "xml",
        success: function (data) {
            var xmlString;
            if (jQuery.browser === "msie") {
                xmlString = data.xml;
            } else {
                xmlString = (new XMLSerializer()).serializeToString(data);
            }
            document.getElementById('plot_xml').innerHTML = formatXml(xmlString).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/ /g, '&nbsp;').replace(/\n/g, '<br />');
        },
        error: function () {
            document.getElementById('plot_xml').innerHTML = "";
        }
    });
    $.ajax({
        type: "GET",
        url: urlOutput + "xml/" + resultName + ".sql",
        dataType: "text",
        contentType: 'text/plain',
        mimeType: 'text',
        complete: function (data) {
            document.getElementById('plot_sql').innerHTML = (data.responseText).replace(/\n/g, '<br />');
        },
        error: function () {
            document.getElementById('plot_sql').innerHTML = "";
        }
    });
    $.ajax({
        type: "GET",
        url: urlOutput + "scripts/" + resultName + ".R",
        dataType: "text",
        contentType: 'text/plain',
        mimeType: 'text',
        complete: function (data) {
            document.getElementById('r_script').innerHTML = (data.responseText).replace(/\n/g, '<br />');
        },
        error: function () {
            document.getElementById('r_script').innerHTML = "";
        }
    });
    $.ajax({
        type: "GET",
        url: urlOutput + "xml/" + resultName + ".log",
        dataType: "text",
        contentType: 'text/plain',
        mimeType: 'text',
        complete: function (data) {
            document.getElementById('plot_log').innerHTML = (data.responseText).replace(/\n/g, '<br />');
        },
        error: function () {
            document.getElementById('plot_log').innerHTML = "";
        }
    });

    $('#ui-tabs-1').empty();
    $("#r_data_url").prop("href", urlOutput + "data/" + resultName + ".data");
    $("#y1_points_url").prop("href", urlOutput + "data/" + resultName + ".points1");
    $("#y2_points_url").prop("href", urlOutput + "data/" + resultName + ".points2");


}

function initPage() {
    $('#uncheck_all').click(function () {
        $("input[name='multiselect_database']").each(function () {
            this.checked = false;
        });
        var textnode = document.createTextNode('Select database');
        var item = document.getElementById("categories1").childNodes[0];
        item.replaceChild(textnode, item.childNodes[0]);
        updatePages();
    });

    outerLayout = $("body").layout({
        name: "outer" // used for button binding
        , north__paneSelector: "#header"
        , south__paneSelector: "#series_formatting"
        , north__closable: false
        , north__resizable: false
        , north__spacing_open: 0
        , north__size: 55
        , east__paneSelector: "#plot_display"
        , center__paneSelector: "#plot_config"
        , south__minSize: 112
        , east__size: '50%'
        , east__minSize: 100
        , east__maxSize: 800
        , east__onresize: 'innerLayout.resizeAll'
        , resizeWhileDragging: true
        , east__closable: false
        , west__resizable: true
        , west__spacing_closed: 15
        , west__togglerLength_closed: 20
        , west__togglerAlign_closed: "top"		// align to top of resizer
        , west__paneSelector: "#history"
        , west__initClosed: true
        , west__togglerLength_open: 0
        , west__initClose: true
        , west__togglerTip_open: "Close History"
        , west__togglerTip_closed: "Open History"
        , west__togglerClass: "history-toggler"
        , west__fxName: "slide"		// none, slide, drop, scale
        , autoBindCustomButtons: true
        , south__togglerLength_open: 10
        , west__onopen_start: function () {
            refreshHistory();
        }

        , useStateCookie: false
    });
    $("#plot_display_inner").tabs({
        heightStyle: "content",
        beforeActivate: function (event, ui) {
            currentPlotTab = ui.newPanel.attr("aria-labelledby");
        },

        load: function (event, ui) {
            var pre = $("<pre/>").text(ui.panel.text());
            ui.panel.empty();
            ui.panel.append(pre);
        },
        create: function (event, ui) {
        }
    });

    $("#tab-south").tabs({collapsible: false});

    innerLayout = $("#plot_display").layout({
        name: "inner" // used for button binding
        , closable: false
        , center__paneSelector: "#plot_display_inner"
        , center__size: "70%"
        , center__spacing_closed: 20
        , center__togglerLength_closed: 20
        , center__resizable: true
        , center__closable: false
        , center__togglerAlign_closed: "top"
        , center__minSize: 0
        , resizeWhileDragging: true
        , south__togglerAlign_closed: "top"
        , south__fxName: "slide"
        , south__initClosed: false
        , south__initClose: true
        , south__togglerClass: "history-toggler"
        , south__spacing_closed: 20
        , south__togglerLength_closed: 20
        , south__size: "30%"
        , south__paneSelector: "#tab-south"
        , south__resizable: true
        , south__minSize: 0
        , south__closable: true
        , autoBindCustomButtons: true
    });


    $('body').on('resize', function () {
        $("#plot_display_inner").tabs('refresh');
    });

    var westSelector = "body > .ui-layout-west"; // outer-west pane
    $("<span></span>").attr("id", "west-closer").prependTo(westSelector);
    outerLayout.addCloseBtn("#west-closer", "west");

    $("#listdt").jqGrid({
        datatype: "local",
        autowidth: true,
        shrinkToFit: true,
        colNames: ['ID', '#', 'Y axis', 'Hide', 'Title', 'Conf Interval', 'Line Color', 'Point Symbol', 'Series Line Type', 'Line Type', 'Line Width', 'Show Significant', 'Connect Across NA', 'Legend Text'],
        colModel: [
            {name: 'id', index: 'id', hidden: true},
            {name: 'order', width: 10, index: 'order', sortable: false},
            {name: 'y_axis', width: 30, index: 'y_axis', align: "center"},
            {
                name: 'hide',
                index: 'hide',
                width: 30,
                align: "center",
                editable: true,
                edittype: "checkbox",
                editoptions: {value: "Yes:No"}
            },
            {name: 'title', index: 'title', width: 300},
            {
                name: 'plot_ci',
                index: 'plot_ci',
                width: 70,
                editable: true,
                edittype: "select",
                formatter: 'select',
                editoptions: {value: "none:none;boot:boot;std:std;met_prm:met_prm;met_boot:met_boot"},
                align: "center"
            },
            {
                name: 'color',
                index: 'color',
                width: 40,
                editable: true,
                edittype: 'custom',
                editoptions: {custom_element: myelem, custom_value: myvalue},
                formatter: colorDisplayFmatter,
                unformat: colorDisplayUnmatter,
                align: "center"
            },
            {
                name: 'pch',
                index: 'pch',
                editable: true,
                width: 70,
                align: "center",
                edittype: "select",
                formatter: 'select',
                editoptions: {value: "20:Small circle;19:Circle;15:Square;17:Triangle;18:Rhombus;1:Ring"}
            },
            {
                name: 'type',
                index: 'type',
                sortable: false,
                editable: true,
                edittype: "select",
                formatter: 'select',
                editoptions: {value: "p:points;l:lines;o:overplotted;b:joined lines;s:stair steps;h:histogram-like;n:nothing"},
                width: 50,
                align: "center"
            },
            {
                name: 'lty',
                index: 'lty',
                sortable: false,
                editable: true,
                edittype: "select",
                formatter: 'select',
                editoptions: {value: "1:solid;2:dashed;3:dotted;4:dot-dash;5:long dash;6:long short"},
                width: 70,
                align: "center"
            },
            {
                name: 'lwd',
                index: 'lwd',
                sortable: false,
                editable: true,
                sorttype: "int",
                width: 40,
                align: "center"
            },
            {
                name: 'show_signif',
                index: 'hide',
                width: 30,
                align: "center",
                editable: true,
                edittype: "checkbox",
                editoptions: {value: "Yes:No"}
            },
            {
                name: 'con_series',
                index: 'con_series',
                sortable: false,
                editable: true,
                edittype: "select",
                formatter: 'select',
                editoptions: {value: "0:No;1:Yes"},
                width: 30,
                align: "center"
            },
            {
                name: 'legend',
                index: 'legend',
                sortable: false,
                width: 150,
                align: "left",
                editable: true
            }
        ],
        rowNum: -1,
        height: 'auto',
        pager: '#pagerdt',
        pginput: false,
        pgtext: false,
        pgbuttons: false,
        viewrecords: true,
        caption: "Series Formatting",
        cmTemplate: {title: false},
        cellEdit: true,
        hoverrows: false,
        url: 'clientArray',
        cellsubmit: 'clientArray',
        afterInsertRow: function (rowid, rowdata) {
            $('#color_' + rowdata.id).colorpicker({
                parts: ['header', 'map', 'bar', 'hex', 'rgb', 'alpha', 'preview', 'swatches', 'footer'],
                altField: '#color_' + rowdata.id
            })
        },
        beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
            lastSelRow = iRow;
            lastSelCol = iCol;
        }
    });
    $("#listdt").jqGrid('navGrid', '#pagerdt', {
        edit: false,
        add: false,
        del: false,
        search: false,
        refresh: false
    });

    var addDiffCurveDialogForm = $("#addDiffCurveDialogForm").dialog({
        autoOpen: false,
        height: "auto",
        width: "auto",
        modal: true,
        buttons: {
            "Create Derived Curve": function () {
                var valid = false;
                var yAxisValue = $('input:radio[name=yAxisDiff]:checked').val();
                var oper = jQuery('input[name=derive_oper]:checked').val();
                if (yAxisValue.indexOf("1") !== -1) {
                    if ($('#series1Y1').val() && $('#series2Y1').val()) {
                        seriesDiffY1.push($('#series1Y1').val() + "," + $('#series2Y1').val() + "," + oper);
                        valid = true;
                    }
                } else {
                    if ($('#series1Y2').val() && $('#series2Y2').val()) {
                        seriesDiffY2.push($('#series1Y2').val() + "," + $('#series2Y2').val() + "," + oper);
                        valid = true;
                    }
                }
                addDiffCurveDialogForm.dialog("close");
                if (valid) {
                    updateSeries();
                    //force Event Equalizer
                    $("#event_equal").prop('checked', true).trigger("change");
                }

            },
            'Cancel': function () {
                addDiffCurveDialogForm.dialog("close");
            }
        },
        open: function () {

            $("input[name=derive_oper][value=DIFF]").prop('checked', true);
            var allSeries = $("#listdt").jqGrid('getRowData');
            for (var i = 0; i < allSeries.length; i++) {
                $("#listdt").jqGrid('setCell', allSeries[i].id, 'order', i + 1);
                $("#listdt").jqGrid('getLocalRow', allSeries[i].id).order = i + 1;
            }
            var selected_mode = $("#plot_data").multiselect("getChecked").val();
            $('#series1Y2').empty();
            $('#series1Y1').empty();
            $('#series2Y2').empty();
            $('#series2Y1').empty();

            $("#y1AxisDiff").prop("checked", true);
            $("#y2AxisDiff").removeAttr("checked");

            $('#series1Y2').prop("disabled", true);
            $('#series2Y2').prop("disabled", true);
            $('#series1Y1').removeProp('disabled');
            $('#series2Y1').removeProp('disabled');
            $('#y2AxisDiff').removeProp("disabled");
            $('#y1AxisDiff').removeProp("disabled");
            series1Names = [];
            series2Names = [];


            for (var i = 0; i < allSeries.length; i++) {
                var isInclude = false;
                if (allSeries[i].title.indexOf('DIFF') != 0
                    && allSeries[i].title.indexOf('RATIO') != 0
                    && allSeries[i].title.indexOf('SS') != 0
                    && allSeries[i].title.indexOf('ETB') != 0) {
                    // curve can be included ONLY if it is MODE Ratio stat or any of Stat stats
                    if (selected_mode == "mode") {
                        var desc = allSeries[i].title.split(" ");
                        if (listStatModeRatio.indexOf(desc[desc.length - 1]) > -1) {
                            isInclude = true;
                        }
                    } else {
                        isInclude = true;
                    }
                }


                if (isInclude) {
                    var yAxisText = allSeries[i].y_axis;

                    if (yAxisText.indexOf("2") !== -1) {
                        $('#series1Y2')
                            .append($("<option></option>")
                                .attr("value", allSeries[i].title)
                                .text(allSeries[i].title));
                        $('#series2Y2')
                            .append($("<option></option>")
                                .attr("value", allSeries[i].title)
                                .text(allSeries[i].title));
                        series2Names.push(allSeries[i].title);
                    } else {
                        $('#series1Y1')
                            .append($("<option></option>")
                                .attr("value", allSeries[i].title)
                                .text(allSeries[i].title));
                        $('#series2Y1')
                            .append($("<option></option>")
                                .attr("value", allSeries[i].title)
                                .text(allSeries[i].title));

                        series1Names.push(allSeries[i].title);
                    }
                }
            }


            if ($("#series1Y2 option").length > 0 && $("#series1Y1 option").length > 0) {
                createNewDerivedSeriesName(1);
            } else {
                if ($("#series1Y2 option").length == 0) {
                    $('#y2AxisDiff').attr("disabled", true);
                    createNewDerivedSeriesName(1);
                }
                if ($("#series1Y1 option").length == 0) {
                    $('#y1AxisDiff').attr("disabled", true);
                    $("#y1AxisDiff").removeAttr("checked");
                    $("#y2AxisDiff").prop("checked", true);
                    $('#series1Y2').removeAttr('disabled');
                    $('#series2Y2').removeAttr('disabled');
                    $('#series1Y1').attr("disabled", true);
                    $('#series2Y1').attr("disabled", true);
                    createNewDerivedSeriesName(2);
                }
            }


        },
        close: function () {
        }
    });
    $("#listdt").jqGrid('navButtonAdd', '#pagerdt', {
        caption: "Add Derived Curve",
        title: "Add Derived Curve",
        buttonicon: "ui-icon-plus",
        onClickButton: function () {
            if (currentTab === 'Roc' || currentTab === 'Rely' || currentTab === 'Ens_ss' || currentTab === 'Perf' || currentTab === "Hist" || currentTab === "Eclv") {
                $("#unavailableDiffCurveDialogForm").dialog("open");
            } else {
                var allSeries = $("#listdt").jqGrid('getRowData');
                if (allSeries.length > 1) {
                    addDiffCurveDialogForm.dialog("open");
                } else {
                    $("#incorrectDiffCurveDialogForm").dialog("open");
                }
            }
        }
    }).jqGrid('navButtonAdd', '#pagerdt', {
        caption: "Remove Derived Curve",
        title: "Remove Derived Curve",
        buttonicon: "ui-icon-trash",
        onClickButton: function () {
            var sr = $(this).jqGrid('getGridParam', 'selrow');
            if (sr) {
                var rowData = $(this).getRowData(sr);
                if (rowData.title.startsWith("DIFF")
                    || rowData.title.startsWith("RATIO")
                    || rowData.title.startsWith("SS")
                    || rowData.title.startsWith("ETB")) {
                    $(this).jqGrid('delRowData', sr);
                    $("#1", "#gbox_listdt").css({display: ""});
                    var titleArr, title;
                    var titleMinusOne = rowData.title.slice(0, -1);
                    if (rowData.title.startsWith("DIFF")) {
                        titleArr = titleMinusOne.replace("DIFF (", "").split('"-"');
                        for (var i = 0; i < titleArr.length; i++) {
                            titleArr[i] = titleArr[i].replace('"', "");
                        }
                        title = titleArr.join() + ",DIFF";
                    } else if (rowData.title.startsWith("RATIO")) {
                        titleArr = titleMinusOne.replace("RATIO (", "").split('"/"');
                        for (var i = 0; i < titleArr.length; i++) {
                            titleArr[i] = titleArr[i].replace('"', "");
                        }
                        title = titleArr.join() + ",RATIO";
                    } else if (rowData.title.startsWith("SS")){
                        titleArr = titleMinusOne.replace("SS (", "").split('"and"');
                        for (var i = 0; i < titleArr.length; i++) {
                            titleArr[i] = titleArr[i].replace('"', "");
                        }
                        title = titleArr.join() + ",SS";
                    }else{
                        titleArr = titleMinusOne.replace("ETB (", "").split('"and"');
                        for (var i = 0; i < titleArr.length; i++) {
                            titleArr[i] = titleArr[i].replace('"', "");
                        }
                        title = titleArr.join() + ",ETB";
                    }


                    var index;
                    if (rowData.y_axis == "Y1") {
                        index = seriesDiffY1.indexOf(title);
                        if (index > -1) {
                            seriesDiffY1.splice(index, 1);
                        }
                    } else {
                        index = seriesDiffY2.indexOf(title);
                        if (index > -1) {
                            seriesDiffY2.splice(index, 1);
                        }
                    }
                    //renumber
                    var allSeries = $("#listdt").jqGrid('getRowData');
                    for (var i = 0; i < allSeries.length; i++) {
                        $("#listdt").jqGrid('setCell', allSeries[i].id, 'order', i + 1);
                        $("#listdt").jqGrid('getLocalRow', allSeries[i].id).order = i + 1;
                    }

                } else {
                    var idSelector = "#alertmod_" + this.p.id;
                    $.jgrid.viewModal(idSelector, {
                        gbox: "#gbox_" + $.jgrid.jqID(this.p.id),
                        jqm: true
                    });
                    $(idSelector).find("#alertcnt_listdt").empty().append('<div>This is not a derived curve</div>');
                    $(idSelector).find(".ui-jqdialog-titlebar-close").focus();
                }
            } else {
                var idSelector = "#alertmod_" + this.p.id;
                $.jgrid.viewModal(idSelector, {
                    gbox: "#gbox_" + $.jgrid.jqID(this.p.id),
                    jqm: true
                });
                $(idSelector).find(".ui-jqdialog-titlebar-close").focus();
            }
        }
    }).jqGrid('navButtonAdd', '#pagerdt', {
        caption: "Apply defaults",
        title: "Apply defaults",
        buttonicon: "ui-icon-transferthick-e-w",
        onClickButton: function () {
            alert("defaults..")
        }
    });
    $("#listdt").setGridWidth($(window).width() - 20);

    $("#unavailableDiffCurveDialogForm").dialog({
        autoOpen: false,
        height: "auto",
        width: "auto",
        modal: true,
        buttons: {
            Ok: function () {
                $(this).dialog("close");
            }
        }
    });

    $("#incorrectDiffCurveDialogForm").dialog({
        autoOpen: false,
        height: "auto",
        width: "auto",
        modal: true,
        buttons: {
            Ok: function () {
                $(this).dialog("close");
            }
        }
    });


    $(window).bind('resize', function () {
        $("#listdt").setGridWidth($(window).width() - 20);
    }).trigger('resize');
    $("#listdt").jqGrid('sortableRows', {
        update: function (e, ui) {
            var allSeries = $("#listdt").jqGrid('getRowData');
            for (var i = 0; i < allSeries.length; i++) {
                $("#listdt").jqGrid('setCell', allSeries[i].id, 'order', i + 1);
                $("#listdt").jqGrid('getLocalRow', allSeries[i].id).order = i + 1;
            }
        }
    });

    $("#pagerdt_left table.navtable tbody tr").append( // here 'pager' part or #pager_left is the id of the pager
        '<td><div ><input type="checkbox"  style="margin:0 4px;" id="seriesLock"/><label for="seriesLock">Lock Formatting</label></div></td>');
    $("#seriesLock").change(function () {
        if ($(this).is(':checked')) {
            $(this).attr("checked", "checked");
        } else {
            $(this).removeAttr("checked");
        }
    });

    $("#generate_plot").button({}).click(function () {
        sendXml();
    });

    var upload_file_dialog = $("#upload_file_dialog").dialog({
        modal: true,
        autoOpen: false,
        buttons: {
            'OK': function () {
                $("#formUpload").submit();
            },
            'Cancel': function () {
                upload_file_dialog.dialog('close')
            }
        }
    });

    $("#load_xml").button({}).click(function () {
        upload_file_dialog.dialog("open");

    });

    $("#reload_databases").button({}).click(function () {
        requestDBUpdate();
    });
    $("input[name=show_history_choice][value=show_history_success]").prop('checked', true);
    $("#show_history_choice").buttonset();
    $('#grid_col').colorpicker({
        parts: ['header', 'map', 'bar', 'hex', 'rgb', 'alpha', 'preview', 'swatches', 'footer'],
        showOn: 'focus alt click',
        altField: '#grid_col'
    });
    $('#grid_col').colorpicker('setColor', '#CCCCCC');
    $('#caption_col').colorpicker({
        parts: ['header', 'map', 'bar', 'hex', 'rgb', 'alpha', 'preview', 'swatches', 'footer'],
        showOn: 'focus alt click',
        altField: '#caption_col'
    });
    $('#caption_col').colorpicker('setColor', '#333333');

    $("#error_message").dialog({
        modal: true,
        autoOpen: false,
        buttons: {
            Ok: function () {
                $(this).dialog("close");
            }
        }
    });
    $("#r_error_message").dialog({
        modal: false,
        autoOpen: false,
        height: 360,
        buttons: {
            Ok: function () {
                $(this).dialog("close");
            }
        }
    });


    $("#refresh_history").button({
        icons: {
            primary: "ui-icon-refresh"
        },
        text: false
    }).click(function () {
        refreshHistory();
    });
    $.ajaxSetup({
        beforeSend: function () {
            $('#modal').css("display", "block");
            $('#fade').css("display", "block");
        },
        complete: function () {
            $('#modal').css("display", "none");
            $('#fade').css("display", "none");
        }
    });
    $("#download_plot").button({
        icons: {
            primary: "ui-icon-disk"
        },
        text: false
    }).click(function () {
        downloadPlot();
    });

    $("#reset_formatting").button({
        icons: {
            primary: "ui-icon-arrowrefresh-1-w"
        },
        text: false
    }).click(function () {
        resetFormatting();
    });

    $("#plot_image").click(function () {
        if (document.getElementById("plot_image").firstChild.tagName === 'IMG') {
            viewImage(resultName.replace("plot_", ""));
        }

    });
    var tabIndex = 0;
    if (initXML != null) {
        var template = initXML.find("plot").find("template")[0].innerHTML;
        if (template === "series_plot.R_tmpl" || template === 'revision_series_plot.R_tmpl') {
            currentTab = "Series";
        } else if (template === "box_plot.R_tmpl" || template === 'revision_box_plot.R_tmpl') {
            currentTab = "Box";
        } else if (template === "bar_plot.R_tmpl") {
            currentTab = "Bar";
        } else if (template === "rhist.R_tmpl" || template === "phist.R_tmpl" || template === "relp.R_tmpl") {
            currentTab = "Hist";
        } else if (template === "roc.R_tmpl") {
            currentTab = "Roc";
        } else if (template === "eclv.R_tmpl") {
            currentTab = "Eclv";
        } else if (template === "rely.R_tmpl") {
            currentTab = "Rely";
        } else if (template === "ens_ss.R_tmpl") {
            currentTab = "Ens_ss";
        } else if (template === "performance.R_tmpl") {
            currentTab = "Perf";
        } else if (template === "taylor_plot.R_tmpl") {
            currentTab = "Taylor";
        } else if (template === "contour_plot.R_tmpl") {
            currentTab = "Contour";
        }

        var tabs = $("#plot_config").find("a");

        for (var i = 0; i < tabs.length; i++) {
            if (tabs[i].text === currentTab) {
                tabIndex = i;
                break;
            }
        }
    }
    $("#plot_config").tabs({
        active: tabIndex,
        beforeActivate: function (event, ui) {
            var tabId = ui.oldTab.attr("aria-controls");
            $("#" + tabId).empty();
            cleanUp();
            currentTab = ui.newTab.text();
        },
        beforeLoad: function (event, ui) {
            $.ajaxSetup({cache: true});
            ui.jqXHR.error(function () {
                ui.panel.html(
                    "Couldn't load this tab. We'll try to fix this as soon as possible. " +
                    "If this wouldn't be a demo.");
            });
        }
    });

    if (initXML != null) {
        $('#plot_title').val($(initXML.find("plot").find("tmpl").find("title")).text());
        $('#x_label_title').val($(initXML.find("plot").find("tmpl").find("x_label")).text());
        $('#y1_label_title').val($(initXML.find("plot").find("tmpl").find("y1_label")).text());
        $('#y2_label_title').val($(initXML.find("plot").find("tmpl").find("y2_label")).text());
        $('#caption').val($(initXML.find("plot").find("tmpl").find("caption")).text());
        if ($(initXML.find("plot").find("tmpl").find("job_title"))) {
            $('#job_title').val($(initXML.find("plot").find("tmpl").find("job_title")).text());
        }
        if ($(initXML.find("plot").find("tmpl").find("keep_revisions"))) {
            $("#keep_revisions").prop('checked', $(initXML.find("plot").find("tmpl").find("keep_revisions")).text() === "true");
        }

        $("#is_python").prop('checked', $(initXML.find("plot").find("execution_type")).text() == "Python");
        $("#vert_plot").prop('checked', $(initXML.find("plot").find("vert_plot")).text() == "true");
        $("#x_reverse").prop('checked', $(initXML.find("plot").find("x_reverse")).text() == "true");
        $("#num_stats").prop('checked', $(initXML.find("plot").find("num_stats")).text() == "true");
        $("#grid_on").prop('checked', $(initXML.find("plot").find("grid_on")).text() == "true");
        $("#sync_axes").prop('checked', $(initXML.find("plot").find("sync_axes")).text() == "true");
        $("#dump_points1").prop('checked', $(initXML.find("plot").find("dump_points1")).text() == "true");
        $("#dump_points2").prop('checked', $(initXML.find("plot").find("dump_points2")).text() == "true");
        $("#indy1_stag").prop('checked', $(initXML.find("plot").find("indy1_stag")).text() == "true");
        $("#indy2_stag").prop('checked', $(initXML.find("plot").find("indy2_stag")).text() == "true");
        $("#varianceInflationFactor").prop('checked', $(initXML.find("plot").find("varianceinflationfactor")).text() === "true");
        $("#ci_alpha").val($(initXML.find("plot").find("ci_alpha")).text());
        $("#eqbound_low").val($(initXML.find("plot").find("eqbound_low")).text());
        $("#eqbound_high").val($(initXML.find("plot").find("eqbound_high")).text());

        $("#plot_type").val($(initXML.find("plot").find("plot_type")).text());
        $("#plot_height").val($(initXML.find("plot").find("plot_height")).text());
        $("#plot_width").val($(initXML.find("plot").find("plot_width")).text());
        $("#plot_units").val($(initXML.find("plot").find("plot_units")).text());
        $("#cex").val($(initXML.find("plot").find("cex")).text());
        $("#plot_res").val($(initXML.find("plot").find("plot_res")).text());

        var mar_arr = $(initXML.find("plot").find("mar")).text().replace("c(", "").replace(")", "").split(",");

        $("#mar_bottom").val(mar_arr[0]);
        $("#mar_left").val(mar_arr[1]);
        $("#mar_top").val(mar_arr[2]);
        $("#mar_right").val(mar_arr[3]);

        var mgp_arr = $(initXML.find("plot").find("mgp")).text().replace("c(", "").replace(")", "").split(",");

        $("#mgp_title").val(mgp_arr[0]);
        $("#mgp_labels").val(mgp_arr[1]);
        $("#mgp_line").val(mgp_arr[2]);

        $("#title_align").val($(initXML.find("plot").find("title_align")).text());
        $("#title_offset").val($(initXML.find("plot").find("title_offset")).text());
        $("#title_size").val($(initXML.find("plot").find("title_size")).text());
        $("#title_weight").val($(initXML.find("plot").find("title_weight")).text());
        $("#grid_lty").val($(initXML.find("plot").find("grid_lty")).text());
        $("#grid_lwd").val($(initXML.find("plot").find("grid_lwd")).text());
        $('#grid_col').colorpicker('setColor', $(initXML.find("plot").find("grid_col")).text());
        $("#grid_x").val($(initXML.find("plot").find("grid_x")).text());
        $("#plot_cmd").val($(initXML.find("plot").find("plot_cmd")).text());

        $("#xlab_align").val($(initXML.find("plot").find("xlab_align")).text());
        $("#xlab_offset").val($(initXML.find("plot").find("xlab_offset")).text());
        $("#xlab_size").val($(initXML.find("plot").find("xlab_size")).text());
        $("#xlab_weight").val($(initXML.find("plot").find("xlab_weight")).text());
        $("#xtlab_horiz").val($(initXML.find("plot").find("xtlab_horiz")).text());
        $("#xtlab_perp").val($(initXML.find("plot").find("xtlab_perp")).text());
        $("#xtlab_size").val($(initXML.find("plot").find("xtlab_size")).text());
        $("#xtlab_freq").val($(initXML.find("plot").find("xtlab_freq")).text());
        $("#xtlab_orient").val($(initXML.find("plot").find("xtlab_orient")).text());

        $("#x2lab_align").val($(initXML.find("plot").find("x2lab_align")).text());
        $("#x2lab_offset").val($(initXML.find("plot").find("x2lab_offset")).text());
        $("#x2lab_size").val($(initXML.find("plot").find("x2lab_size")).text());
        $("#x2lab_weight").val($(initXML.find("plot").find("x2lab_weight")).text());
        $("#x2tlab_horiz").val($(initXML.find("plot").find("x2tlab_horiz")).text());
        $("#x2tlab_perp").val($(initXML.find("plot").find("x2tlab_perp")).text());
        $("#x2tlab_size").val($(initXML.find("plot").find("x2tlab_size")).text());
        $("#x2tlab_orient").val($(initXML.find("plot").find("x2tlab_orient")).text());


        $("#ylab_align").val($(initXML.find("plot").find("ylab_align")).text());
        $("#ylab_offset").val($(initXML.find("plot").find("ylab_offset")).text());
        $("#ylab_size").val($(initXML.find("plot").find("ylab_size")).text());
        $("#ylab_weight").val($(initXML.find("plot").find("ylab_weight")).text());
        $("#ytlab_horiz").val($(initXML.find("plot").find("ytlab_horiz")).text());
        $("#ytlab_perp").val($(initXML.find("plot").find("ytlab_perp")).text());
        $("#ytlab_size").val($(initXML.find("plot").find("ytlab_size")).text());
        $("#ytlab_orient").val($(initXML.find("plot").find("ytlab_orient")).text());

        var y1_lim_arr = $(initXML.find("plot").find("y1_lim")).text().replace("c(", "").replace(")", "").split(",");

        $("#y1_lim_min").val(y1_lim_arr[0]);
        $("#y1_lim_max").val(y1_lim_arr[1]);
        $("#y1_bufr").val($(initXML.find("plot").find("y1_bufr")).text());

        var x1_lim_arr = $(initXML.find("plot").find("x1_lim")).text().replace("c(", "").replace(")", "").split(",");

        $("#x1_lim_min").val(x1_lim_arr[0]);
        $("#x1_lim_max").val(x1_lim_arr[1]);


        $("#y2lab_align").val($(initXML.find("plot").find("y2lab_align")).text());
        $("#y2lab_offset").val($(initXML.find("plot").find("y2lab_offset")).text());
        $("#y2lab_size").val($(initXML.find("plot").find("y2lab_size")).text());
        $("#y2lab_weight").val($(initXML.find("plot").find("y2lab_weight")).text());
        $("#y2tlab_horiz").val($(initXML.find("plot").find("y2tlab_horiz")).text());
        $("#y2tlab_perp").val($(initXML.find("plot").find("y2tlab_perp")).text());
        $("#y2tlab_size").val($(initXML.find("plot").find("y2tlab_size")).text());
        $("#y2tlab_orient").val($(initXML.find("plot").find("y2tlab_orient")).text());
        var y2_lim_arr = $(initXML.find("plot").find("y2_lim")).text().replace("c(", "").replace(")", "").split(",");
        $("#y2_lim_min").val(y2_lim_arr[0]);
        $("#y2_lim_max").val(y2_lim_arr[1]);
        $("#y2_bufr").val($(initXML.find("plot").find("y1_bufr")).text());

        $("#legend_size").val($(initXML.find("plot").find("legend_size")).text());
        var legend_inset_arr = $(initXML.find("plot").find("legend_inset")).text().replace("c(", "").replace(")", "").split(",");
        $("#legend_inset_min").val(legend_inset_arr[0]);
        $("#legend_inset_max").val(legend_inset_arr[1]);
        $("#legend_box").val($(initXML.find("plot").find("legend_box")).text());
        $("#legend_ncol").val($(initXML.find("plot").find("legend_ncol")).text());
        $("#caption_align").val($(initXML.find("plot").find("caption_align")).text());
        $("#caption_offset").val($(initXML.find("plot").find("caption_offset")).text());
        $("#caption_size").val($(initXML.find("plot").find("caption_size")).text());
        $("#caption_weight").val($(initXML.find("plot").find("caption_weight")).text());
        var caption_col = $(initXML.find("plot").find("caption_col")).text();
        if (caption_col.length > 7) {
            caption_col = caption_col.substring(0, 7);
        }
        $('#caption_col').colorpicker('setColor', caption_col);


    } else {
        resetFormatting();
    }

    $('#release').on('click', function () {
        var win = window.open('https://metviewer.readthedocs.io/en/latest/');
        if (win) {
            //Browser has allowed it to be opened
            win.focus();
        } else {
            //Browser has blocked it
            alert('Please allow popups for this site');
        }
    });
    var categoriesEl = $("#categories11");
    for (var i = 0; i < categories.length; i++) {
        var t = $(categories[i]);
        var ul = $('<ul data-label="' + t.attr('name') + '">');
        var databases = t.find("db");
        for (var j = 0; j < databases.length; j++) {
            var d = $(databases[j]);
            var val = d.find("val");
            var desc = d.find("desc");
            var li = $('<li data-value="' + val.text() + '" title="' + desc.text() + '">');
            var input = $('<input name="multiselect_database" type="checkbox" disabled value="' + val.text()
                + '" title="' + desc.text() + '" id="' + val.text() + '" /><label for="' + val.text() + '" >' + val.text() + '</label>lab');
            //li.text(val.text());
            li.prepend(input);

            ul.append(li);
        }
        categoriesEl.append(ul);
    }


    $('.multilevel-dropdown').multilevelDropdown();
    $("input[name='multiselect_database']").on('change', function (event) {
        if ($(this).val() != null) {
            var selected_db = [];
            $("input[name='multiselect_database']:checked").each(function () {
                selected_db.push($(this).val());
            });

            var text;
            if (selected_db.length === 1) {
                text = selected_db[0];
            } else if (selected_db.length === 0) {
                text = "Select database";
            } else {
                text = selected_db.length + " selected";
            }
            var textnode = document.createTextNode(text);
            var item = document.getElementById("categories1").childNodes[0];
            item.replaceChild(textnode, item.childNodes[0]);
            updatePages();
        }
    });


    $('#header').css("position", "static");
}

function updatePages() {
    seriesDiffY1 = [];
    seriesDiffY2 = [];
    var values, i;
    if (currentTab === 'Series' || currentTab === 'Box' || currentTab === 'Bar') {
        $('#listdt').jqGrid('clearGridData');
        var mode = $('#plot_data').multiselect('getChecked')[0].value;
        updateForecastVariables();
        if ($('#plot_data').multiselect('getChecked')[0].value !== mode) {
            mode = $('#plot_data').multiselect('getChecked')[0].value;
            updateForecastVariables();
            if ($('#plot_data').multiselect('getChecked')[0].value !== mode) {
                updateForecastVariables();
            }
        }
        mode = $('#plot_data').multiselect('getChecked')[0].value;
        if (mode === 'stat') {
            updateStats("y1", 1, []);
            updateStats("y2", 1, []);
            updateFixVar("stat");
            updateIndyVar("stat");
            $("#agg_none").prop('checked', 'checked');
        } else if (mode === 'mode') {
            updateMode("y1", 1, []);
            updateMode("y2", 1, []);
            updateFixVar("mode");
            updateIndyVar("mode");
        } else if (mode === 'mtd') {
            updateMtd("y1", 1, []);
            updateMtd("y2", 1, []);
            updateFixVar("mtd");
            updateIndyVar("mtd");
        }
        updateSeriesVarVal("y1", 1, []);
        updateSeriesVarVal("y2", 1, []);
    } else if (currentTab === 'Roc' || currentTab === 'Rely' || currentTab === 'Hist' || currentTab === 'Eclv') {
        updateSeriesVarValHist(1, []);
        for (i = 0; i < fixed_var_indexes.length; i++) {
            values = $("#fixed_var_val_" + fixed_var_indexes[i]).val();
            updateFixedVarValHist(fixed_var_indexes[i], values);
        }
        if (currentTab === 'Rely') {
            updateSeriesRely();
        } else {
            updateSeriesHist();
        }
    } else if (currentTab === 'Ens_ss') {

        for (i = 0; i < series_var_y1_indexes.length; i++) {
            values = $("#series_var_val_y1_" + series_var_y1_indexes[i]).val();
            updateSeriesVarValEns(series_var_y1_indexes[i], values);
        }
        for (i = 0; i < fixed_var_indexes.length; i++) {
            values = $("#fixed_var_val_" + fixed_var_indexes[i]).val();
            updateFixedVarValHist(fixed_var_indexes[i], values);
        }
    } else if (currentTab === 'Perf') {
        $('#listdt').jqGrid('clearGridData');
        updateSeriesVarVal("y1", 1, []);
        var rowCount = $('#fixed_var_table').find('tr').length;
        for (i = rowCount - 1; i >= 0; i--) {
            removeFixedVar("fixed_var_" + (i + 1));
        }
    } else if (currentTab === 'Taylor') {
        $('#listdt').jqGrid('clearGridData');
        updateForecastVariables();
        updateSeriesVarVal("y1", 1, []);
    } else if (currentTab === 'Contour') {
        $('#listdt').jqGrid('clearGridData');
        updateStatVariable();
        updateYvalueCountour([]);

    }
}

function addThemeSwitcher(container, position) {
    var pos = {top: '15px', zIndex: 10};
    $('<div id="themeContainer" style="position: absolute; overflow-x: hidden;"></div>')
        .css($.extend(pos, position))
        .appendTo(container || 'body')
        .themeswitcher();

}

function changeFixedVarHist(value) {
    var optionsMap = {};
    if (value === 'rhist') {
        optionsMap = rhist_fixed_var_map;
    } else if (value === 'phist') {
        optionsMap = phist_fixed_var_map;
    } else if (value === 'relp') {
        optionsMap = relp_fixed_var_map;
    }
    for (var i = 0; i < fixed_var_indexes.length; i++) {
        var selected = $('#fixed_var_' + fixed_var_indexes[i]).val();
        $('#fixed_var_' + fixed_var_indexes[i]).empty();
        $.each(optionsMap, function (key, value) {
            if (key === selected) {
                $('#fixed_var_' + fixed_var_indexes[i]).append($('<option value="' + key + '" selected>' + value + '</option>'));
            } else {
                $('#fixed_var_' + fixed_var_indexes[i]).append($('<option value="' + key + '">' + value + '</option>'));
            }
        });
        $('#fixed_var_' + fixed_var_indexes[i]).multiselect('refresh');
    }
}

function onIndyCalendarClose(obj, index) {
    var by;
    var unit;
    var dates;
    var custom_format;
    var val_obj;
    if (index) {
        by = $("#fixed_var_val_date_range_by_" + index).val().trim();
        unit = $("#fixed_var_val_date_range_by_unit_" + index).val();
        dates = $(fixVarValResponse[index]).find("val");
        custom_format = 'YYYY-MM-DD HH:mm:ss';
        val_obj = $("#fixed_var_val_" + index);
    } else {
        by = $("#date_range_by").val().trim();
        unit = $("#date_range_by_unit").val();
        dates = $(previousIndVarValResponse).find("val");
        if ($("#date_range_format").length) {
            custom_format = $("#date_range_format").val().trim();
        } else {
            custom_format = 'YYYY-MM-DD HH:mm:ss';
        }
        val_obj = $("#indy_var_val");
    }
    if (by.length === 0) {
        by = 1;
        unit = "hours";
    }
    by = parseInt(by);
    if (unit === "min") {
        by = by * 60;
    } else if (unit === "hours") {
        by = by * 3600;
    } else if (unit === "days") {
        by = by * 86400;
    }
    var start = moment.tz(obj.date1, 'UTC');
    var end = moment.tz(obj.date2, 'UTC');

    val_obj.multiselect("uncheckAll");
    var indy_var_val = $('[name="multiselect_indy_var_val"]');
    while (start <= end) {
        var current_date_str = start.format('YYYY-MM-DD HH:mm:ss');
        var isFound = false;
        for (var i = 0; i < dates.length; i++) {
            if ($(dates[i]).text() === current_date_str) {
                isFound = true;
                break;
            }
        }
        if (isFound) {
            var formattedDate;
            try {
                formattedDate = start.format(custom_format);
            } catch (error) {
                console.log("formatting error");
                console.error(error);
                formattedDate = current_date_str
            }
            var option = val_obj.find('option[value="' + current_date_str + '"]');
            option.prop('selected', true);
            if (!index) {
                indy_var_vals_to_attr = {};
                for (var i = 0; i < indy_var_val.length; i++) {
                    var jqObject = $(indy_var_val[i]);
                    if (jqObject.attr("value") === current_date_str) {
                        var id = jqObject.attr("id");
                        $('#' + id + '_label').val(formattedDate);
                        indy_var_vals_to_attr[indy_var_val[i].value] = obj;
                        break;
                    }
                }
            }
            option.text(formattedDate);
        }
        start.add(by, 'seconds');
    }
    if (index) {
        val_obj.multiselect("option", "indy_var_vals_to_attr", indy_var_vals_to_attr);
    }
    try {
        val_obj.multiselect("refresh");
    } catch (err) {
        console.log(err);
    }
}

function createCalendarTopBarWithFormat() {
    var html = "";
    html += '<div class="normal-top">' +
        '<span class="selection-top">' + 'Selected:' + ' </span> <b class="start-day">...</b>';

    html += ' <span class="separator-day">' + " - " + '</span> <b class="end-day">...</b> <i class="selected-days">(<span class="selected-days-num">3</span> ' + 'Days' + ')</i>';
    html += '<br/><label for="date_range_by" style="color: #333;">By:</label><input style="width: 30px;line-height: 1;" id="date_range_by" type="text"><select id="date_range_by_unit" style="font-size: 10px;">' +
        '            <option value="sec">sec</option>' +
        '            <option value="min">min</option>' +
        '            <option value="hours" selected="">hours</option>' +
        '            <option value="days">days</option>' +
        '          </select><label for="date_range_format" style="color: #333;">&nbsp;Format:</label><input style="width: 150px;line-height: 1;" id="date_range_format" type="text" value="YYYY-MM-DD HH:mm:ss">';

    html += '</div>';
    html += '<div class="error-top">error</div>' +
        '<div class="default-top">default</div>';
    return html;
}

function createCalendarTopBarNoFormat(index) {
    var by_id;
    var unit_id;
    if (index) {
        by_id = "fixed_var_val_date_range_by_" + index;
        unit_id = "fixed_var_val_date_range_by_unit_" + index;
    } else {
        by_id = "date_range_by";
        unit_id = "date_range_by_unit";
    }
    var html = "";
    html += '<div class="normal-top">' +
        '<span class="selection-top">' + 'Selected:' + ' </span> <b class="start-day">...</b>';

    html += ' <span class="separator-day">' + " - " + '</span> <b class="end-day">...</b> <i class="selected-days">(<span class="selected-days-num">3</span> ' + 'Days' + ')</i>';
    html += '<br/><label for="date_range_by" style="color: #333;">By:</label><input style="width: 30px;line-height: 1;" id="' + by_id + '" type="text"><select id="' + unit_id + '" style="font-size: 10px;">' +
        '            <option value="sec">sec</option>' +
        '            <option value="min">min</option>' +
        '            <option value="hours" selected="">hours</option>' +
        '            <option value="days">days</option>' +
        '          </select>';

    html += '</div>';
    html += '<div class="error-top">error</div>' +
        '<div class="default-top">default</div>';
    return html;
}

String.prototype.formatAll = function (t) {
    var target = this;
    target = target.split("&#38;").join("&");
    target = target.split("&gt;").join(">");
    target = target.split("&lt;").join("<");
    return target;
};